name: CI

on:
  push:
    branches:
      - main

env:
  NODE_VERSION: '22.21.1'
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  ci_build_test:
    name: Build & Test (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    environment: 'BasedDB CI-CD'

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: based-db-ci
            name: Linux-ARM64
          # - os: macos-latest
          #   name: MacOS-ARM64
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # --- LINUX SPECIFIC SETUP ---
      - name: Install Build Essentials & GCC-14 (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "üõ†Ô∏è Installing build tools..."
          sudo apt-get update

          sudo apt-get install -y build-essential software-properties-common

          sudo add-apt-repository -y universe
          sudo apt-get update

          sudo apt-get install -y gcc-14 g++-14

          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 14 --slave /usr/bin/g++ g++ /usr/bin/g++-14

          gcc --version
          make --version

      - name: Setup Docker (Linux)
        if: runner.os == 'Linux'
        run: |
          if ! command -v docker &> /dev/null; then
            echo "üê≥ Docker not found on this runner. Installing..."
            sudo apt-get install -y docker.io
            
            sudo systemctl start docker || sudo service docker start
          else
            echo "‚úÖ Docker is already installed."
          fi

          echo "üîß Fixing Docker socket permissions..."
          sudo chmod 666 /var/run/docker.sock

      - name: Build Builder Image (Linux)
        if: matrix.name == 'Linux-ARM64'
        run: docker build -t based-db-clibs-build-linux_aarch64 -f podman/Containerfile .

      - name: Run Build
        run: |
          if [[ "${{ matrix.name }}" == "Linux-ARM64" ]]; then
              docker run -t --rm -w /usr/src/based-db -v "${{ github.workspace }}:/usr/src/based-db" based-db-clibs-build-linux_aarch64
              sudo chown -R $USER:$USER .
          fi

          echo "Installing ZVM..."
          curl -L https://raw.githubusercontent.com/tristanisham/zvm/master/install.sh | bash

          export ZVM_INSTALL="$HOME/.zvm"
          export PATH="$PATH:$ZVM_INSTALL/bin:$ZVM_INSTALL/self"

          echo "Installing Zig..."
          zvm i 0.15.2
          zvm use 0.15.2

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y patchelf
          fi

          npm ci

          if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            echo "Running Linux Locale Build..."
            npm run build-locale
          fi
          for pkg in hash utils schema protocol; do
            npm run build -w "@based/$pkg"
          done

          # DEBUG
          find packages/db/dist -name "libselva.so" || echo "‚ö†Ô∏è Library NOT found in packages/db/dist"

          cd packages/db
          npm run build-zig linux-aarch64

          npx tsc

      - name: Run Test Command
        run: |
          cd packages/db
          npm run test-fast

      # --- PACKAGING & Releasing ---

      # - name: Create & Upload Release Asset
      #   if: success()
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     cd packages/db

      #     npm pack

      #     ORIGINAL_NAME=$(ls *.tgz | head -n 1)
      #     ASSET_NAME="based-db-${{ matrix.name }}-${{ github.sha }}.tgz"
      #     mv "$ORIGINAL_NAME" "$ASSET_NAME"

      #     echo "Created package: $ASSET_NAME"

      #     RELEASE_TAG="build-${{ github.sha }}"

      #     gh release create "$RELEASE_TAG" "$ASSET_NAME" \
      #       --repo "${{ github.repository }}" \
      #       --title "Build ${{ github.sha }}" \
      #       --notes "Automated build for commit ${{ github.sha }}" \
      #       --prerelease \
      #       --target main || \
      #     gh release upload "$RELEASE_TAG" "$ASSET_NAME" --repo "${{ github.repository }}" --clobber

      # --- NOTIFICATIONS ---

      - name: Send Discord Notification
        uses: tsickert/discord-webhook@v7.0.0
        if: always()
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK_URL }}
          username: GitHub
          avatar-url: 'https://cdn.discordapp.com/avatars/999680196040982618/df91181b3f1cf0ef1592fbe18e0962d7.webp'
          embed-author-name: ${{ github.actor }}
          embed-author-url: ${{ github.server_url }}/${{ github.actor }}
          embed-author-icon-url: 'https://avatars.githubusercontent.com/u/${{ github.actor_id }}?v=4'
          embed-title: "${{ job.status == 'success' && '‚úÖ SUCCESS: CI/CD Passed & Artifact Created' || '‚ùå FAILURE: CI/CD Failed' }}"
          embed-description: |
            **Commit:** [${{ github.event.head_commit.message }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            **Artifact:** based-db-${{ matrix.name }}-${{ github.sha }}
