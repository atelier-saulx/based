#!/bin/bash
set -e

# 1. Detect Environment
PLATFORM=$(node -p "process.platform")
ARCH=$(node -p "process.arch")
CURRENT="$PLATFORM-$ARCH"

echo "ğŸ” Detected host: $CURRENT"

# 2. Dispatch Logic
case $CURRENT in
  "darwin-arm64")
    # --- Native macOS (Default) ---
    echo "ğŸ macOS ARM64 detected. Running native build..."
    make -C clibs
    ;;

  "linux-arm64")
    # --- Linux ARM64 (Custom Wrapper) ---
    echo "ğŸ§ Linux ARM64 detected. Running custom build flow..."
    ./scripts/sync-clibs linux-aarch64
    make -C .clibs-linux-aarch64
    ;;

  "linux-x64")
    # --- Linux x64 (Custom Wrapper) ---
    echo "ğŸ§ Linux x64 detected. Running custom build flow..."
    ./scripts/sync-clibs linux-x86_64
    make -C .clibs-linux-x86_64
    ;;

  *)
    echo "âŒ Error: Unsupported platform/arch combination: $CURRENT"
    exit 1
    ;;
esac

echo "âœ… Build complete."