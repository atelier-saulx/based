import{createEncoder as e,deepEqual as t}from"@saulx/utils";import*as s from"fflate";import{applyPatch as n}from"@saulx/diff";import{hash as o,hashObjectIgnoreKeyOrder as i}from"@saulx/hash";import r from"@based/opts";import a from"isomorphic-ws";const c=e=>{try{const t=global.atob(decodeURI(e));return JSON.parse(t)}catch(e){return{error:"Invalid authState"}}},{encode:l}=e(["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," "],["0"]),h=e=>encodeURI(l(global.btoa(String.fromCodePoint(...(new TextEncoder).encode(JSON.stringify(e))))));var u;!function(e){e[e.FunctionError=50001]="FunctionError",e[e.AuthorizeFunctionError=50002]="AuthorizeFunctionError",e[e.NoOservableCacheAvailable=50003]="NoOservableCacheAvailable",e[e.ObservableFunctionError=50004]="ObservableFunctionError",e[e.ObserveCallbackError=50005]="ObserveCallbackError",e[e.FunctionNotFound=40401]="FunctionNotFound",e[e.FunctionIsNotObservable=40402]="FunctionIsNotObservable",e[e.FunctionIsObservable=40403]="FunctionIsObservable",e[e.FunctionIsStream=40404]="FunctionIsStream",e[e.CannotStreamToObservableFunction=40405]="CannotStreamToObservableFunction",e[e.AuthorizeRejectedError=40301]="AuthorizeRejectedError",e[e.InvalidPayload=40001]="InvalidPayload",e[e.PayloadTooLarge=40002]="PayloadTooLarge",e[e.ChunkTooLarge=40003]="ChunkTooLarge",e[e.UnsupportedContentEncoding=40004]="UnsupportedContentEncoding",e[e.NoBinaryProtocol=40005]="NoBinaryProtocol",e[e.LengthRequired=41101]="LengthRequired",e[e.MethodNotAllowed=40501]="MethodNotAllowed",e[e.RateLimit=40029]="RateLimit",e[e.MissingAuthStateProtocolHeader=40030]="MissingAuthStateProtocolHeader",e[e.IncorrectAccessKey=40031]="IncorrectAccessKey"}(u=u||(u={}));class d extends Error{}const f=(e,t)=>{if(!e||"object"!=typeof e){const t=new d(`Payload: ${e}`);return t.name="Invalid returned payload",t}const{message:s,code:n}=e,o=s?"["===s[0]?s:`[${u[n]}] `+s:n?"Cannot read error msg":JSON.stringify(e,null,2),i=new d(o);return i.stack=t?o+" "+t:o,i.name=u[n],i.code=n,i},g=new Map;let m;"undefined"!=typeof document&&document.addEventListener("visibilitychange",function(){clearTimeout(m),document.hidden?m=setTimeout(()=>{g.forEach(e=>{e(!1)})},3e4):g.forEach(e=>{e(!0)})});const b=(e,t,s={destroy:()=>{g.delete(s)}},n=0,o=!1)=>(((e,t)=>{"function"==typeof e?e().then(e=>{t(e)}):t(e)})(t,i=>{setTimeout(()=>{if(s.disconnected)return;let r=!0;g.set(s,n=>{s.disconnected||(!n&&r?e.functionResponseListeners.size?(console.warn("Send to background - streams or functions in progress try again in 10 seconds..."),clearTimeout(m),m=setTimeout(()=>{g.forEach(e=>{e(!1)})},1e4)):(console.warn("Send to background - close connection"),r=!1,e.onClose(),c.close()):!r&&n&&(g.delete(s),b(e,t,s,0,!0)))});const c=s.ws=new a(i,[h(e.authState)]);let l=!1;c.binaryType="blob",c.addEventListener("error",e=>{e.message&&e.message.includes("401")&&(l=!0)}),c.addEventListener("message",t=>{e.onData(t)}),c.addEventListener("open",()=>{if(r){if(s.disconnected)return;n=100,o&&e.onReconnect(),e.onOpen()}}),c.addEventListener("close",()=>{if(r){if(s.disconnected)return;e.onClose(),b(e,t,s,l?5e3:Math.min(2500,n+~~(500*Math.random())+100),!0)}})},n)}),s);class S{constructor(){this.listeners={},Object.defineProperty(this,"listeners",{enumerable:!1,writable:!0})}emit(e,t){if(this.listeners[e]){const s=this.listeners[e];for(let e=0,n=s.length;e<s.length;e++){const o=s[e];o(t),n>s.length&&s[e]!==o&&(e--,n=s.length)}}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeAllListeners(){this.listeners={}}once(e,t){if(!t)return new Promise(t=>{const s=n=>{t(n),this.off(e,s)};this.on(e,s)});const s=n=>{t(n),this.off(e,s)};this.on(e,s)}off(e,t){const s=this.listeners[e];if(s)if(t){for(let e=0;e<s.length;e++)if(s[e]===t){s.splice(e,1),e--;break}0===s.length&&delete this.listeners[e]}else delete this.listeners[e]}}const p="@based",v=p+"-cache-",y=p+"-size",w=p+"-authState-",T=new TextDecoder,I=new TextEncoder,E=(e,t)=>{const s=localStorage.getItem(t);s&&(e.storageSize-=new Blob([s]).size,localStorage.setItem(y,String(e.storageSize)),localStorage.removeItem(t))},Q=()=>{const e=Object.keys(localStorage);try{for(const t of e)t.startsWith(p)&&localStorage.removeItem(t)}catch(e){try{localStorage.clear()}catch(e){}}},R=(e,t,n)=>{try{const o=e.storageEnvKey;if(!o)return;const i=localStorage.getItem(t),r=JSON.stringify(n),a=r.length>70||t===w+o?global.btoa(T.decode(s.deflateSync(I.encode(r)))):r,c=new Blob([a]).size;i&&(e.storageSize-=new Blob([i]).size),e.storageSize+=c,e.storageSize>e.maxStorageSize&&(Q(),e.storageSize=0,!0===e.authState.persistent&&R(e,w+o,e.authState),e.storageSize+=c),localStorage.setItem(y,String(e.storageSize)),localStorage.setItem(t,a)}catch(e){}},C=(e,t)=>{const n=e.storageEnvKey;if(n)try{const e=localStorage.getItem(t);if(void 0!==e){if(e.length<70&&t!==w+n)try{return JSON.parse(e)}catch(e){}return(e=>{const t=global.atob(e),n=T.decode(s.inflateSync(I.encode(t)));return JSON.parse(n)})(e)}return}catch(e){}},q="undefined"!=typeof window,z=(e,t)=>{const s=e.storageEnvKey;s&&q&&E(e,t+="-"+s)},O=(e,t,s)=>{const n=e.storageEnvKey;n&&q&&R(e,t+="-"+n,s)},P=async e=>{},N=(e,t)=>{t.persistent?O(e,"@based-authState",t):z(e,"@based-authState"),e.authState=t},L=new TextEncoder,A=(e,t,s,n)=>{for(let o=s;o<s+n;o++){const s=255&t;e[o]=s,t=(t-s)/256}},M=(e,t,s,n=s)=>{const o=((e,t,s)=>(e<<1)+(0|t)+(s<<4))(e,t,s),i=new Uint8Array(n);return A(i,o,0,4),i},x=(e,t=!1)=>{let n,o=!1;return void 0!==e?(n=L.encode("string"==typeof e?e:JSON.stringify(e)),!t&&n.length>150&&(n=s.deflateSync(n),o=!0),[o,n]):[!1]},k=(e,t)=>{let s=4;const[n,o,i,r]=t;if(3===n){const t=L.encode(o);s+=1+t.length;const[a,c]=x(r);c&&(s+=c.length);const l=16;s+=l;const h=M(n,a,s,5+l);return A(h,e,4,8),A(h,i,12,8),h[20]=t.length,c?{buffers:[h,t,c],len:s}:{buffers:[h,t],len:s}}return{buffers:[],len:0}},F=(e,t)=>{let s=4;const[n,o,i]=t;if(7===n){const t=M(n,!1,12);return A(t,e,4,8),{buffers:[t],len:12}}const r=L.encode(o);s+=1+r.length;const a=6===n,[,c]=x(i,!0);c&&(s+=c.length),s+=8;const l=M(5,a,s,13);return A(l,e,4,8),l[12]=r.length,c?{buffers:[l,r,c],len:s}:{buffers:[l,r],len:s}},J=(e,t)=>{let s=4;const[n,o,i,r]=t;if(2===n){const t=M(n,!1,12);return A(t,e,4,8),{buffers:[t],len:12}}const a=L.encode(o);s+=1+a.length;const[c,l]=x(r);l&&(s+=l.length),s+=16;const h=M(n,c,s,21);return A(h,e,4,8),A(h,i,12,8),h[20]=a.length,l?{buffers:[h,a,l],len:s}:{buffers:[h,a],len:s}},j=e=>{let t=7;const[s,n,o]=e,i=L.encode(n);t+=1+i.length;const[r,a]=x(o);a&&(t+=a.length);const c=M(0,r,t,8);return A(c,s,4,3),c[7]=i.length,a?{buffers:[c,i,a],len:t}:{buffers:[c,i],len:t}},B=e=>{let t=12;const[s,n]=e,[o,i]=x(n);i&&(t+=i.length);const r=M(6,o,t,12);return A(r,s,4,8),i?{buffers:[r,i],len:t}:{buffers:[r],len:t}},D=new Uint8Array(0),U=e=>!!(e.fQ.length||e.oQ.size||e.gQ.size||e.cQ.size||e.pQ.length),K=e=>{if(e.connected&&!e.drainInProgress&&U(e)){e.drainInProgress=!0;const t=()=>{if(e.drainInProgress=!1,e.connected&&U(e)){const t=e.cQ,s=e.pQ,n=e.fQ,o=e.oQ,i=e.gQ,r=[];let a=0;for(const[e,s]of t){const{buffers:t,len:n}=F(e,s);r.push(...t),a+=n}for(const[e,t]of i){const{buffers:s,len:n}=k(e,t);r.push(...s),a+=n}for(const[e,t]of o){const{buffers:s,len:n}=J(e,t);r.push(...s),a+=n}for(const e of n){const{buffers:t,len:s}=j(e);r.push(...t),a+=s}for(const e of s){const{buffers:t,len:s}=B(e);r.push(...t),a+=s}const c=new Uint8Array(a);let l=0;for(const e of r)c.set(e,l),l+=e.length;e.fQ=[],e.pQ=[],e.oQ.clear(),e.gQ.clear(),e.cQ.clear(),e.connection.ws.send(c),(e=>{clearTimeout(e.idlePing),e.idlePing=setTimeout(()=>{e.connection&&e.connected&&!e.connection.disconnected&&e.connection.ws.send(D)},6e4)})(e)}};e.drainTimeout=setTimeout(t,0)}},_=(e,t,s,n,o)=>{e.requestId++,e.requestId>16777215&&(e.requestId=0);const i=e.requestId,r=Error().stack.split(/BasedClient\.function.+:\d\d\)/)[1];e.functionResponseListeners.set(i,[n,o,r]),e.fQ.push([i,s,t]),K(e)},W=(e,t,s,n)=>{var o;5!==(null==(o=e.cQ.get(s))?void 0:o[0])&&(e.cQ.set(s,[5,t,n]),K(e))},$=(e,t,s,n)=>{var o;const i=null==(o=e.cQ.get(s))?void 0:o[0];5!==i&&6!==i&&(e.cQ.set(s,[6,t,n]),K(e))},H=(e,t,s,n,o=0)=>{var i;1!==(null==(i=e.oQ.get(s))?void 0:i[0])&&(e.oQ.set(s,[1,t,o,n]),K(e))},G=(e,t,s,n,o=0)=>{e.gQ.has(s)||(e.gQ.set(s,[3,t,o,n]),K(e))},V=async(e,s)=>t(s,e.authState)?(console.warn("[Based] Trying to send the same authState twice",e.authState),e.authRequest.inProgress?e.authRequest.promise:new Promise(e=>e({}))):(e.authRequest.inProgress&&(console.warn("[Based] Authentication still in progress - waiting until done"),await e.authRequest.promise),N(e,s),e.emit("authstate-change",e.authState),e.connected&&e.connection.ws.send((e=>{let t=4;const[s,n]=x(e);n&&(t+=n.length);const o=M(4,s,t);return n&&o.set(n,4),o})(s)),e.authRequest.promise=new Promise((t,s)=>{e.authRequest.inProgress=!0,e.authRequest.resolve=t,e.authRequest.reject=s}).finally(()=>{e.authRequest.resolve=null,e.authRequest.reject=null,e.authRequest.inProgress=!1}),e.authRequest.promise),X=(e,t,s)=>{let n=0;for(let o=s-1+t;o>=t;o--)n=256*n+e[o];return n},Y=(e,t)=>{const s=e.observeState.get(t);G(e,s.name,t,s.payload)},Z=(e,t,s)=>{const n="sub"===s?e.observeState.get(t):e.channelState.get(t);return n?n.payload?{name:n.name,payload:n.payload,id:t}:{name:n.name,id:t}:{name:`[Cannot find ${t}]`,id:t}},ee=(e,t,n,o)=>(new TextDecoder).decode(n?s.inflateSync(o.slice(e,t)):o.slice(e,t)),te=(e,t)=>void 0===t?o(e):i([e,t]);class se{constructor(e,t,s,n){this.query=s,this.id=te(t,s),this.client=e,this.name=t,this.persistent=(null==n?void 0:n.persistent)||!1}get cache(){return this.client.cache.get(this.id)||null}clearCache(){this.persistent&&z(this.client,"@based-cache-"+this.id),this.client.cache.delete(this.id)}subscribe(e,t){let s;const n=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){const o=this.client.observeState.get(this.id);this.persistent&&!o.persistent&&(o.persistent=!0,n&&O(this.client,"@based-cache-"+this.id,n)),s=++o.idCnt,o.subscribers.set(s,{onError:t,onData:e})}else{s=1;const o=new Map;o.set(s,{onError:t,onData:e}),this.client.observeState.set(this.id,{payload:this.query,name:this.name,subscribers:o,persistent:this.persistent||!1,idCnt:1}),H(this.client,this.name,this.id,this.query,(null==n?void 0:n.checksum)||0)}return n&&e(n.value,n.checksum),()=>{const e=this.client.observeState.get(this.id);var t,n,o;e?(e.subscribers.delete(s),0===e.subscribers.size&&(this.client.observeState.delete(this.id),2!==(null==(o=(t=this.client).oQ.get(n=this.id))?void 0:o[0])&&(t.oQ.set(n,[2]),K(t)))):console.warn("Subscription allready removed",this.query,this.name)}}async getWhen(e){return new Promise(t=>{const s=this.subscribe((n,o)=>{e(n,o)&&(t(n),s())})})}async get(){return new Promise((e,t)=>{if(this.client.getState.has(this.id))return void this.client.getState.get(this.id).push([e,t]);this.client.getState.set(this.id,[]);const s=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){if(this.client.oQ.has(this.id)){const[s]=this.client.oQ.get(this.id);if(1===s)return void this.client.getState.get(this.id).push([e,t])}if(s)return void e(s.value)}this.client.getState.get(this.id).push([e,t]),G(this.client,this.name,this.id,this.query,(null==s?void 0:s.checksum)||0)})}}const ne=e=>{e.channelCleanTimeout||(e.channelCleanTimeout=setTimeout(()=>{if(e.channelCleanTimeout=null,e.connected){let t=!1;e.channelState.forEach((s,n)=>{-1!==s.removeTimer&&(s.removeTimer--,0===s.removeTimer?e.channelState.delete(n):t=!0)}),t&&ne(e)}else ne(e)},e.channelCleanupCycle))};class oe{constructor(e,t,s){this.payload=s,this.id=te(t,s),this.client=e,this.name=t}subscribe(e,t){let s;if(this.client.channelState.has(this.id)&&0!==this.client.channelState.get(this.id).subscribers.size){const n=this.client.channelState.get(this.id);n.removeTimer=-1,s=++n.idCnt,n.subscribers.set(s,{onMessage:e,onError:t})}else{s=1;const n=new Map;n.set(s,{onMessage:e,onError:t}),this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:n,removeTimer:-1,idCnt:1}),W(this.client,this.name,this.id,this.payload)}return()=>{const e=this.client.channelState.get(this.id);var t,n,o;e.subscribers.delete(s),0===e.subscribers.size&&(e.removeTimer=2,7!==(null==(o=(t=this.client).cQ.get(n=this.id))?void 0:o[0])&&(t.cQ.set(n,[7]),K(t)))}}publish(e){if(this.client.channelState.has(this.id)){const e=this.client.channelState.get(this.id);-1!==e.removeTimer&&e.removeTimer<2&&(e.removeTimer=2,ne(this.client))}else this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:new Map,removeTimer:2,idCnt:0}),ne(this.client),$(this.client,this.name,this.id,this.payload);var t,s,n;s=this.id,n=e,(t=this.client).pQ.length>t.maxPublishQueue&&t.pQ.shift(),t.pQ.push([s,n]),K(t)}}const ie=r.default;class re extends S{constructor(e,t){super(),this.storageSize=0,this.maxStorageSize=4999500,this.storageEnvKey=0,this.connected=!1,this.outgoingStreams=new Map,this.isDrainingStreams=!1,this.maxPublishQueue=1e3,this.pQ=[],this.fQ=[],this.oQ=new Map,this.cQ=new Map,this.gQ=new Map,this.drainInProgress=!1,this.localStorage=!1,this.maxCacheSize=4e6,this.cache=new Map,this.functionResponseListeners=new Map,this.requestId=0,this.channelState=new Map,this.channelCleanupCycle=3e4,this.observeState=new Map,this.getState=new Map,this.authState={},this.authRequest={authState:null,promise:null,resolve:null,reject:null,inProgress:!1},null!=t&&t.persistentStorage&&(this.storagePath=t.persistentStorage),null!=t&&t.maxCacheSize&&(console.warn("MaxCacheSize setting not implemented yet..."),this.maxCacheSize=t.maxCacheSize),e&&this.connect(e)}onClose(){this.connected=!1,this.functionResponseListeners.size>this.fQ.length&&this.functionResponseListeners.forEach((e,t)=>{this.fQ.find(([e])=>e===t)||(e[1](new Error("Server disconnected before function result was processed")),this.functionResponseListeners.delete(t))}),this.emit("disconnect",!0)}onReconnect(){this.connected=!0,this.emit("reconnect",!0)}onOpen(){this.connected=!0,this.emit("connect",!0);for(const[e,t]of this.observeState)if(!this.oQ.has(e)){const s=this.cache.get(e);H(this,t.name,e,t.payload,(null==s?void 0:s.checksum)||0)}for(const[e,t]of this.channelState)this.cQ.has(e)||(t.subscribers.size?W(this,t.name,e,t.payload):$(this,t.name,e,t.payload));K(this)}onData(e){(async(e,s)=>{if(!e.isDestroyed)try{const i=s.data,r=await(async e=>{if(e instanceof ArrayBuffer)return new Uint8Array(e);if("undefined"==typeof window){if(e instanceof Buffer)return new Uint8Array(e)}else if(e instanceof Blob){const t=await e.arrayBuffer();return new Uint8Array(t)}throw new Error("432")})(i),{type:a,len:c,isDeflate:l}=(e=>{const t=15&e;return{type:t>>1,isDeflate:1==(1&t),len:e>>4}})(X(r,0,4));if(0===a){const t=X(r,4,3);let s;3!==c&&(s=JSON.parse(ee(7,c+4,l,r))),e.functionResponseListeners.has(t)&&(e.functionResponseListeners.get(t)[0](s),e.functionResponseListeners.delete(t))}else if(3===a){const t=X(r,4,8);if(e.getState.has(t)&&e.cache.has(t)){const s=e.getState.get(t);for(const[n]of s)n(e.cache.get(t).value);e.getState.delete(t)}}else if(2===a){const t=X(r,4,8),s=e.cache.get(t);if(!s)return void Y(e,t);const o=X(r,12,8),i=X(r,20,8);if(s.checksum!==i)return void Y(e,t);let a;24!==c&&(a=JSON.parse(ee(28,c+4,l,r)));try{s.value=n(s.value,a),s.checksum=o}catch(s){return void Y(e,t)}if(e.observeState.has(t)){const n=e.observeState.get(t);n.persistent&&(s.persistent=!0,O(e,v+t,s));for(const[,e]of n.subscribers)e.onData(s.value,o)}if(e.getState.has(t)){const n=e.getState.get(t);for(const[e]of n)e(s.value);e.getState.delete(t)}}else if(1===a){const t=X(r,4,8),s=X(r,12,8);let n;16!==c&&(n=JSON.parse(ee(20,c+4,l,r)));const o={value:n,checksum:s};if(e.cache.set(t,o),e.observeState.has(t)){const i=e.observeState.get(t);i.persistent&&(o.persistent=!0,O(e,v+t,o));for(const[,e]of i.subscribers)e.onData(n,s)}if(e.getState.has(t)){const s=e.getState.get(t);for(const[e]of s)e(n);e.getState.delete(t)}}else if(4===a){let s;if(3!==c&&(s=JSON.parse(ee(4,c+4,l,r))),!0===s)null==e.authRequest.resolve||e.authRequest.resolve(e.authState);else if("error"in s)N(e,s),e.emit("authstate-change",e.authState),null==e.authRequest.reject||e.authRequest.reject(new Error(s.error));else{var o;t(e.authState,s)?N(e,s):(N(e,s),e.emit("authstate-change",e.authState)),null==(o=e.authRequest)||null==o.resolve||o.resolve(e.authState)}}else if(5===a){let t;if(3!==c&&(t=JSON.parse(ee(4,c+4,l,r))),t.requestId&&e.functionResponseListeners.has(t.requestId)){const[,s,n]=e.functionResponseListeners.get(t.requestId);s(f(t,n)),e.functionResponseListeners.delete(t.requestId)}if(t.channelId&&e.channelState.has(t.channelId)){const s=f(t),n=e.channelState.get(t.channelId);for(const[,o]of n.subscribers)o.onError?o.onError(s):console.error(Z(e,t.channelId,"channel"),s)}if(t.observableId){if(e.cache.delete(t.observableId),e.observeState.has(t.observableId)){const s=f(t),n=e.observeState.get(t.observableId);for(const[,o]of n.subscribers)o.onError?o.onError(s):console.error(Z(e,t.observableId,"sub"),s)}if(e.getState.has(t.observableId)){const s=f(t),n=e.getState.get(t.observableId);for(const[,e]of n)e(s);e.getState.delete(t.observableId)}}}else if(6===a){const t=X(r,4,8),s=e.channelState.get(t);if(t){if(!s.inTransit){s.inTransit=!0;const{buffers:n,len:o}=F(t,[6,s.name,s.payload]),i=new Uint8Array(o);let r=0;for(const e of n)i.set(e,r),r+=e.length;e.connection.ws.send(i),-1!==s.removeTimer&&s.removeTimer<2&&(s.removeTimer+=1),setTimeout(()=>{const s=e.channelState.get(t);s&&(s.inTransit=!1)},5e3)}e.connection.ws.send(r)}}else if(7===a&&0===X(r,4,1)){const t=X(r,5,8);let s;if(9!==c){const e=ee(13,c+5,l,r);try{s=JSON.parse(e)}catch(t){s=e}}if(e.channelState.has(t)){const n=e.channelState.get(t);for(const[,e]of n.subscribers)e.onMessage(s)}}}catch(e){console.error(981,e)}})(this,e)}async connect(e){if(e&&Object.keys(e).length>0){if(this.opts){if(t(this.opts,e))return;this.disconnect()}this.opts=e,this.url=()=>ie(e),this.storageEnvKey=i(e),(async e=>{q&&(async e=>{var t;const s=e.storageEnvKey;if(!s)return;const n=null!=(t=global.__basedcache__)?t:{};for(const t in n)e.cache.set(Number(t),n[t]);try{let t=Number(localStorage.getItem(y)||0);t<0&&(Q(),t=0),e.storageSize=t;const n=Object.keys(localStorage);if(1===n.length&&t>0&&(Q(),t=0),t>0)for(const t of n){if(t===y||!t.startsWith(p))continue;if(t===w+s){const s=C(e,t);s&&e.setAuthState(s).catch(s=>{console.error(s.message),E(e,t)});continue}const[,n]=t.split(v);if(!n)continue;const[o,i]=n.split("-");if(i!==String(s))continue;if(!o){E(e,t);continue}const r=C(e,t);e.cache.set(Number(o),r)}}catch(e){}})(this)})()}this.opts?this.url&&!this.connection&&(this.connection=b(this,this.url)):console.error("Configure opts to connect")}disconnect(){this.connection&&(this.connection.disconnected=!0,this.connection.destroy(),this.connection.ws&&this.connection.ws.close(),this.connected&&this.onClose(),delete this.connection),clearTimeout(this.drainTimeout),clearTimeout(this.idlePing),this.connected=!1}async destroy(e){e||await P(),clearTimeout(this.storageBeingWritten),clearTimeout(this.channelCleanTimeout),this.disconnect();for(const e in this)delete this[e];this.isDestroyed=!0}channel(e,t){return new oe(this,e,t)}query(e,t,s){return new se(this,e,t,s)}call(e,t,s){const n=null==s?void 0:s.retryStrategy;return new Promise(n?s=>{let o=0,i=0;const r=a=>{const c=n(a,o,i);i++,"number"!=typeof c||isNaN(c)||(o=c,0===c?_(this,t,e,s,r):setTimeout(()=>{_(this,t,e,s,r)},c))};return _(this,t,e,s,r)}:(s,n)=>_(this,t,e,s,n))}stream(e,t,s){return(async(e,t,s,n)=>{})()}setAuthState(e){if("object"==typeof e)return V(this,e);throw new Error("Invalid auth() arguments")}clearAuthState(){return V(this,{})}clearStorage(){return(async e=>{if(q)return Q()})()}saveStorage(){return P()}genCacheScript(){return`<script>window.__basedcache__=${JSON.stringify(ae(this))}<\/script>`}}const ae=e=>{const t={};return e.cache.forEach((e,s)=>{t[s]=e}),t};function ce(e,t){return new re(e,t)}export{re as BasedClient,d as BasedError,u as BasedErrorCode,se as BasedQuery,f as convertDataToBasedError,c as decodeAuthState,ce as default,h as encodeAuthState};
//# sourceMappingURL=bundle.js.map
