(()=>{var so=Object.create;var mr=Object.defineProperty;var io=Object.getOwnPropertyDescriptor;var ao=Object.getOwnPropertyNames;var fo=Object.getPrototypeOf,uo=Object.prototype.hasOwnProperty;var y=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var lo=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ao(t))!uo.call(e,o)&&o!==r&&mr(e,o,{get:()=>t[o],enumerable:!(n=io(t,o))||n.enumerable});return e};var fe=(e,t,r)=>(r=e!=null?so(fo(e)):{},lo(t||!e||!e.__esModule?mr(r,"default",{value:e,enumerable:!0}):r,e));var Sr=y(_t=>{"use strict";Object.defineProperty(_t,"__esModule",{value:!0});var wr=e=>{let t=Array.isArray(e)?[]:{};for(let r in e)e[r]!==null&&typeof e[r]=="object"?t[r]=wr(e[r]):t[r]=e[r];return t};_t.default=wr});var xr=y(jt=>{"use strict";Object.defineProperty(jt,"__esModule",{value:!0});function co(e){return e&&typeof e=="object"&&e.constructor!==Array}jt.default=co});var Or=y(Pt=>{"use strict";Object.defineProperty(Pt,"__esModule",{value:!0});Pt.default=(e=100)=>new Promise(t=>{setTimeout(()=>t(),e)})});var _r=y(Tt=>{"use strict";Object.defineProperty(Tt,"__esModule",{value:!0});var At=(e,t)=>{let r=typeof e,n=typeof t;if(e===t)return!0;if(r!==n||e===null||t===null)return!1;if(r!=="object"){if(r==="function"){if(e.toString()!==t.toString())return!1}else if(e!==t)return!1}else{if(Array.isArray(e))if(Array.isArray(t)){let s=e.length;if(s!==t.length)return!1;for(let a=0;a<s;a++){let i=typeof e[a];if(typeof t[a]!==i)return!1;if(i==="object"&&!At(e[a],t[a]))return!1}}else return!1;if(e.checksum||t.checksum)return e.checksum===t.checksum;let o=0;for(let s in e){if(s[0]==="_"||!e.hasOwnProperty(s))continue;if(!t.hasOwnProperty(s))return!1;let a=t[s],i=e[s];if(a===void 0&&i!==void 0)return!1;let f=typeof a;if(f!==typeof i)return!1;if(a&&f==="object"){if(!At(i,a))return!1}else if(a!==i)return!1;o++}for(let s in t)if(o--,o<0)return!1}return!0};Tt.default=At});var jr=y(Mt=>{"use strict";Object.defineProperty(Mt,"__esModule",{value:!0});Mt.default=e=>(e=e.replace(/[@-\\/|*&^%$#@!()\-+]/g,"_"),e=e.replace(/^_+/,""),e=e.replace(/_+$/,""),e.toUpperCase())});var Pr=y(()=>{});var Ar=y(It=>{"use strict";Object.defineProperty(It,"__esModule",{value:!0});var ho=Pr();It.default=e=>new Promise((t,r)=>{let n=new ho.PassThrough;n.on("error",s=>{r(s)});let o=[];n.on("data",s=>{typeof s=="string"?o.push(Buffer.from(s)):o.push(s)}),n.on("end",s=>{t(Buffer.concat(o))}),e.pipe(n)})});var me=y(zt=>{"use strict";Object.defineProperty(zt,"__esModule",{value:!0});var po=(e,t=5381)=>{let r=e.length;for(;r;){let n=e.charCodeAt(--r);t=t*33^n}return t};zt.default=po});var qt=y(qe=>{"use strict";var vo=qe&&qe.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(qe,"__esModule",{value:!0});var _=vo(me()),Dt=(e,t=5381,r=52711)=>{if(Array.isArray(e))for(let n=0;n<e.length;n++){let o=e[n],s=typeof o;if(s==="string"){let a=n+":"+o;t=_.default(a,t),r=_.default(a,r)}else if(s==="number"){let a=n+"n:"+o;t=_.default(a,t),r=_.default(a,r)}else if(s==="object")if(o===null){let a=n+"v:null";t=_.default(a,t),r=_.default(a,r)}else{let a=Dt(o,t,r);t=_.default(n+"o:",a[0]),r=_.default(n+"o:",a[1])}else if(s==="boolean"){let a=n+"b:"+(o?"true":"false");t=_.default(a,t),r=_.default(a,r)}}else for(let n in e){let o=e[n],s=typeof o;if(s==="string"){let a=n+":"+o;t=_.default(a,t),r=_.default(a,r)}else if(s==="number"){let a=n+"n:"+o;t=_.default(a,t),r=_.default(a,r)}else if(s==="object")if(o===null){let a=n+"v:null";t=_.default(a,t),r=_.default(a,r)}else{let a=Dt(o,t,r);t=_.default(n+"o:",a[0]),r=_.default(n+"o:",a[1])}else if(s==="boolean"){let a=n+"b:"+(o?"true":"false");t=_.default(a,t),r=_.default(a,r)}}return[t,r]};qe.default=Dt});var Ve=y(Qe=>{"use strict";var go=Qe&&Qe.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Qe,"__esModule",{value:!0});var yo=go(qt()),mo=e=>{let t=yo.default(e);return(t[0]>>>0)*4096+t[1]};Qe.default=mo});var Qt=y(Ce=>{"use strict";var Tr=Ce&&Ce.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Ce,"__esModule",{value:!0});var bo=Tr(Ve()),Fe=Tr(me()),wo=(e,t)=>{let r;if(typeof e=="object"?e===null?r=0:r=bo.default(e):typeof e=="boolean"?r=(Fe.default(e?":true":":false")>>>0)*4096:typeof e=="number"?r=(Fe.default("n:"+e)>>>0)*4096+(Fe.default("n:"+e,52711)>>>0):r=(Fe.default(e)>>>0)*4096+(Fe.default(e,52711)>>>0),t){let n=Math.ceil(Math.log10(r+1));if(n<t)return r*Math.pow(10,t-n)}return r};Ce.default=wo});var Dr=y(Ee=>{"use strict";var Ct=Ee&&Ee.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Ee,"__esModule",{value:!0});var Mr=Ct(Qt()),Ft=Ct(me()),So=Ct(Ve()),Ir=pe(),xo="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",zr=e=>{let t="",r;do r=e%62,t=xo.charAt(r)+t,e=Math.floor(e/62);while(e>0);return t},Oo=(e,t,r)=>{let n;if(typeof e=="object")if(e===null)n=0;else if(t&&t>9&&e.constructor===Array){let a="",i=e.length;for(let u=0;u<i;u++)a+=zr(r&&e[u]&&typeof e[u]=="object"?Ir.hashObjectIgnoreKeyOrder(e[u]):Mr.default(e[u]));let f=a.length;if(f<t)a+="x",f+1<t&&(a+=new Array(t-f).join("0"));else if(f>t)return a.slice(0,t);return a}else n=(r?Ir.hashObjectIgnoreKeyOrder(e):So.default(e))>>>0;else typeof e=="boolean"?n=Ft.default(e?":true":":false")*4096:typeof e=="number"?n=(Ft.default("n:"+e)>>>0)*4096:n=Ft.default(e)>>>0;let o=zr(n),s=o.length;return s<t&&(o+="x",s+1<t&&(o+=new Array(t-s).join("0"))),o};Ee.default=Oo});var kt=y(ke=>{"use strict";var _o=ke&&ke.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ke,"__esModule",{value:!0});var S=_o(me()),Et=(e,t=5381,r=52711)=>{if(Array.isArray(e)){let n="__len:"+e.length+1;t=S.default(n,t),r=S.default(n,r);for(let o=0;o<e.length;o++){let s=e[o],a=typeof s;if(a==="string"){let i=o+":"+s;t=S.default(i,t),r=S.default(i,r)}else if(a==="number"){let i=o+"n:"+s;t=S.default(i,t),r=S.default(i,r)}else if(a==="object")if(s===null){let i=o+"v:null";t=S.default(i,t),r=S.default(i,r)}else{let i=Et(s,t,r),f=o+"o:";t=S.default(f,i[0]),r=S.default(f,i[1])}else if(a==="boolean"){let i=o+"b:"+(s?"true":"false");t=S.default(i,t),r=S.default(i,r)}}}else{let n=Object.keys(e).sort(),o="__len:"+n.length+1;t=S.default(o,t),r=S.default(o,r);for(let s=0;s<n.length;s++){let a=n[s],i=e[a],f=typeof i;if(f==="string"){let u=a+":"+i;t=S.default(u,t),r=S.default(u,r)}else if(f==="number"){let u=a+"n:"+i;t=S.default(u,t),r=S.default(u,r)}else if(f==="object")if(i===null){let u=a+"v:null";t=S.default(u,t),r=S.default(u,r)}else{let u=Et(i,t,r),l=a+"o:";t=S.default(l,u[0]),r=S.default(l,u[1])}else if(f==="boolean"){let u=a+"b:"+(i?"true":"false");t=S.default(u,t),r=S.default(u,r)}}}return[t,r]};ke.default=Et});var qr=y(Le=>{"use strict";var jo=Le&&Le.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Le,"__esModule",{value:!0});var Po=jo(kt()),Ao=e=>{let t=Po.default(e);return(t[0]>>>0)*4096+(t[1]>>>0)};Le.default=Ao});var pe=y(H=>{"use strict";var de=H&&H.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(H,"__esModule",{value:!0});var To=de(Qt());H.hash=To.default;var Mo=de(Dr());H.hashCompact=Mo.default;var Io=de(Ve());H.hashObject=Io.default;var zo=de(qr());H.hashObjectIgnoreKeyOrder=zo.default;var Do=de(kt());H.hashObjectIgnoreKeyOrderNest=Do.default;var qo=de(qt());H.hashObjectNest=qo.default;var Qo=de(me());H.stringHash=Qo.default});var Fr=y((Di,Qr)=>{"use strict";Qr.exports=e=>{if(Object.prototype.toString.call(e)!=="[object Object]")return!1;let t=Object.getPrototypeOf(e);return t===null||t===Object.prototype}});var Cr=y(Re=>{"use strict";var Fo=Re&&Re.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Re,"__esModule",{value:!0});var Lt=pe(),Co=Fo(Fr());function Eo(e,t){let r=0,n=(...o)=>new Promise((s,a)=>{e(...o).then(i=>s(i)).catch(i=>{var f,u;r++,t.logError&&t.logError(i,o,r),!t.max||r<t.max?setTimeout(()=>{s(n(...o))},Math.min(r*((f=t.minTime)!==null&&f!==void 0?f:1e3),(u=t.maxTime)!==null&&u!==void 0?u:1/0)):a(i)})});return n}var ko=(...e)=>{let t="";for(let r of e)r!==void 0&&(typeof r=="object"?(Array.isArray(r)||(0,Co.default)(r))&&(t+=(0,Lt.hashObjectIgnoreKeyOrder)(r)):t+=(0,Lt.hash)(r));return t||(~~(Math.random()*99999)).toString(16)};function Lo(e,t={}){t.retry&&(e=Eo(e,t.retry)),t.dedup||(t.dedup=ko),t.concurrency||(t.concurrency=1);let r={},n=new Set,o=()=>{for(let s in r){if(n.size===t.concurrency)break;if(!n.has(s)){let a=r[s];if(n.add(s),e(...a.args).then(i=>{delete r[s],n.delete(s),a.listeners.forEach(([f])=>{f(i)}),o()}).catch(i=>{delete r[s],n.delete(s),a.listeners.forEach(([,f])=>{f(i)}),o()}),n.size===t.concurrency)break}}};return(...s)=>new Promise((a,i)=>{let f=t.dedup(...s);r[f]?r[f].listeners.push([a,i]):r[f]={args:s,listeners:[[a,i]]},n.size<t.concurrency&&o()})}Re.default=Lo});var kr=y(Rt=>{"use strict";Object.defineProperty(Rt,"__esModule",{value:!0});function Er(e,t,...r){return new Promise((n,o)=>{let{timeout:s=100,maxRetries:a=-1}=t,i=0;e(...r).then(f=>n(f)).catch(f=>{++i<=a||a<0?setTimeout(()=>{n(Er(e,{timeout:s,maxRetries:a-1},...r))},s):o(f)})})}Rt.default=Er});var Lr=y(Ut=>{"use strict";Object.defineProperty(Ut,"__esModule",{value:!0});function Ro(e,t){let r=t&&t.noSpecials||!1,n=t&&t.noLowerCase||!1,o=t&&t.noUpperCase||!1,s=t&&t.noNumbers||!1,a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i="abcdefghijklmnopqrstuvwxyz",f="0123456789",u="!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~",l="";r||(l+=u),n||(l+=i),o||(l+=a),s||(l+=f);let c="",p=l.length;for(let h=0;h<e;h++)c+=l.charAt(Math.floor(Math.random()*p));return c}Ut.default=Ro});var Nt=y(be=>{"use strict";Object.defineProperty(be,"__esModule",{value:!0});be.padRight=be.padLeft=void 0;var Uo=(e,t,r)=>{let n=e.length;for(let o=0;o<t-n;o++)e=r+e;return e};be.padLeft=Uo;var No=(e,t,r)=>{let n=e.length;for(let o=0;o<t-n;o++)e=e+r;return e};be.padRight=No});var Rr=y(Ye=>{"use strict";Object.defineProperty(Ye,"__esModule",{value:!0});Ye.createDecode=void 0;var $o=(e,t,r=["$"],n)=>{if(r.length>1&&e)return s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];if(r.includes(f)){let u="";for(let c=0;c<t;c++)u+=s[i+c+1];a+=n[u],i+=t}else a+=f}return a};if(r.length>1)return s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];r.includes(f)?(a+=n[s[i+1]],i++):a+=f}return a};let o=r[0];return e?s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];if(f===o){let u="";for(let c=0;c<t;c++)u+=s[i+c+1];a+=n[u],i+=t}else a+=f}return a}:s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];f===o?(a+=n[s[i+1]],i++):a+=f}return a}};Ye.createDecode=$o});var Nr=y(Xe=>{"use strict";Object.defineProperty(Xe,"__esModule",{value:!0});Xe.createEncode=void 0;var Ur=(e,t)=>t%2?e[e.length-t]:e[t],Ko=(e,t,r)=>{if(r.length>1&&e===1){let n=r.length;return o=>{let s=0,a="";for(let i=0;i<o.length;i++){let f=o.charAt(i);t[f]?(s+=1,s>=n&&(s=0),a+=Ur(r,s)+t[f]):a+=f}return a}}if(r.length>1){let n=r.length;return o=>{let s=0,a="";for(let i=0;i<o.length;i++){let f=!1;for(let u=e-1;u>-1;u--){if(i+u>o.length-1)continue;let l="";for(let c=0;c<u+1;c++)l+=o.charAt(i+c);t[l]&&(s+=1,s>=n&&(s=0),a+=Ur(r,s)+t[l],i+=l.length-1,u=-1,f=!0)}f||(a+=o.charAt(i))}return a}}return e===1?n=>{let o="";for(let s=0;s<n.length;s++){let a=n.charAt(s);t[a]?o+=t[a]:o+=a}return o}:n=>{let o="";for(let s=0;s<n.length;s++){let a=!1;for(let i=e-1;i>-1;i--){if(s+i>n.length-1)continue;let f="";for(let u=0;u<i+1;u++)f+=n.charAt(s+u);t[f]&&(o+=t[f],s+=f.length-1,i=-1,a=!0)}a||(o+=n.charAt(s))}return o}};Xe.createEncode=Ko});var $r=y(et=>{"use strict";Object.defineProperty(et,"__esModule",{value:!0});et.createEncoder=void 0;var Jo=Rr(),Bo=Nr(),Ho=Nt(),Wo=(e,t=["$"])=>{let r=1,n=e.length>36,o=[...e,...t],s=o.map((u,l)=>(u.length>r&&(r=u.length),l>25?String(l-26):String.fromCharCode(97+l))),a={},i={};for(let u=0;u<o.length;u++)a[o[u]]=t.length===1?t[0]+s[u]:s[u],i[s[u]]=o[u];let f=1;if(n){for(let u in i)u.length>f&&(f=u.length);for(let u in i)if(u.length<f){let l=(0,Ho.padLeft)(u,f,"0"),c=i[u];t.length>1?a[c]=l:a[c]=t[0]+l,delete i[u],i[l]=c}}return{charMap:a,reverseCharMap:i,encode:(0,Bo.createEncode)(r,a,t),decode:(0,Jo.createDecode)(n,f,t,i)}};et.createEncoder=Wo});var Kr=y(we=>{"use strict";Object.defineProperty(we,"__esModule",{value:!0});we.deepMerge=we.deepMergeArrays=void 0;var tt=(e,t)=>{if(t.constructor===Array)for(let r=0;r<t.length;r++)r in e&&e[r]&&typeof e[r]=="object"&&t[r]&&typeof t[r]=="object"?tt(e[r],t[r]):e[r]=t[r];else for(let r in t)r in e&&e[r]&&typeof e[r]=="object"&&t[r]&&typeof t[r]=="object"?tt(e[r],t[r]):e[r]=t[r]};function Go(e,...t){if(!t.length)return e;if(t.length===1){let r=t[0];if(e&&typeof e=="object"&&r&&typeof r=="object")return tt(e,r),e}for(let r=0;r<t.length;r++){let n=t[r];if(e&&typeof e=="object"&&n&&typeof n=="object")return tt(e,n),e}return e}we.deepMergeArrays=Go;var $t=(e,t)=>{if(t.constructor===Array||e.constructor===Array)return t;for(let r in t)if(r in e)if(e[r]&&t[r]&&typeof e[r]=="object"&&e[r].constructor!==Array&&typeof t[r]=="object"&&t[r].constructor!==Array){let n=$t(e[r],t[r]);n!==e[r]&&(e[r]=n)}else e[r]=t[r];else e[r]=t[r];return e};function Zo(e,...t){if(!t.length)return e;if(t.length===1){let r=t[0];if(e&&typeof e=="object"&&r&&typeof r=="object")return $t(e,r)}for(let r=0;r<t.length;r++){let n=t[r];if(e&&typeof e=="object"&&n&&typeof n=="object"){let o=$t(e,n);o!==e&&(e=o)}}return e}we.deepMerge=Zo});var Jr=y(Ue=>{"use strict";Object.defineProperty(Ue,"__esModule",{value:!0});Ue.walk=void 0;var Se=re(),Vo=async e=>(0,Se.getType)(e.ref)!=="object",Yo=async(e,t)=>Object.keys(e).map(r=>({name:r,ref:e[r],path:[t,r].filter(Boolean).join("/"),type:(0,Se.getType)(e[r])})),Xo=async e=>(0,Se.getType)(e.ref)==="object",es=async e=>(0,Se.getType)(e)==="object",ts=async(e,t,r)=>{if(r={listFn:Yo,itemMatchFn:Vo,recurseFn:Xo,targetValidationFn:es,...r},(0,Se.getType)(r.targetValidationFn)==="function"&&!await r.targetValidationFn(e))return;["listFn","itemMatchFn","recurseFn"].forEach(o=>{if((0,Se.getType)(r[o])!=="function")throw new Error(o+" should be a function")});let n=await r.listFn(e,r.previousPath);await Promise.all(n.map(async o=>{let{name:s,path:a,type:i}=o;await r.itemMatchFn(o)&&await t(o.ref,{name:s,path:a,type:i}),await r.recurseFn(o)&&await(0,Ue.walk)(o.ref,t,{...r,previousPath:o.path})}))};Ue.walk=ts});var Br=y(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.getType=void 0;var rs=e=>e===null?"null":Array.isArray(e)?"array":typeof e;rt.getType=rs});var Hr=y(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.serializeQuery=ue.parseQuery=void 0;var Kt=e=>{if(e.includes(",")){e=e.split(",");for(let t=0;t<e.length;t++)e[t]=Kt(e[t]);return e}return e==="null"?null:e==="true"||e===""?!0:e==="false"?!1:isNaN(e)?e:Number(e)},ns=e=>{if(e)try{let t={},r="",n="",o=!1,s=0,a=e.length;for(let i=0;i<a;i++){let f=e[i];if(f==="&"&&(!s||s===1&&e[i-1]==="}"||s===2&&e[i-1]==="]")){if(!o)t[r]=!0;else if(s)try{t[r]=JSON.parse(n)}catch{t[r]=n}else t[r]=Kt(n);s=0,o=!1,r="",n=""}else f==="="&&!s?o=!0:o?(n===""&&(f==="{"?s=1:f==="["&&(s=2)),n+=f):r+=f}if(r)if(s)try{t[r]=JSON.parse(n)}catch{t[r]=n}else t[r]=Kt(n);return t}catch{}};ue.parseQuery=ns;var os=e=>{let t=[];for(let r in e){let n=e[r];n===!0?t.push(`${r}`):t.push(`${r}=${(0,ue.serializeQuery)(n,!0)}`)}return t.join("&")},ss=(e,t=!1)=>typeof e=="string"?e:typeof e=="boolean"?e?"true":"false":typeof e=="number"||typeof e=="number"?String(e):e===null?"null":Array.isArray(e)?e.map(r=>typeof r=="object"&&r!==null?JSON.stringify(r):(0,ue.serializeQuery)(r,!0)).join(","):typeof e=="object"?t?JSON.stringify(e):os(e):"";ue.serializeQuery=ss});var Wr=y(xe=>{"use strict";Object.defineProperty(xe,"__esModule",{value:!0});xe.encodeBase64=xe.decodeBase64=void 0;var is=e=>e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0,nt=e=>e<26?e+65:e<52?e+71:e<62?e-4:e===62?43:e===63?47:65,as=(e,t)=>{let r=e.replace(/[^A-Za-z0-9+/]/g,""),n=r.length,o=t?Math.ceil((n*3+1>>2)/t)*t:n*3+1>>2,s=new Uint8Array(o),a,i,f=0,u=0;for(let l=0;l<n;l++)if(i=l&3,f|=is(r.charCodeAt(l))<<6*(3-i),i===3||n-l===1){for(a=0;a<3&&u<o;)s[u]=f>>>(16>>>a&24)&255,a++,u++;f=0}return s};xe.decodeBase64=as;var fs=e=>{let t=2,r="",n=e.length,o=0;for(let s=0;s<n;s++)t=s%3,o|=e[s]<<(16>>>t&24),(t===2||e.length-s===1)&&(r+=String.fromCodePoint(nt(o>>>18&63),nt(o>>>12&63),nt(o>>>6&63),nt(o&63)),o=0);return r.substring(0,r.length-2+t)+(t===2?"":t===1?"=":"==")};xe.encodeBase64=fs});var Gr=y(Oe=>{"use strict";Object.defineProperty(Oe,"__esModule",{value:!0});Oe.stringToUtf8=Oe.uft8ToString=void 0;var us=e=>{let t="",r,n=e.length;for(let o=0;o<n;o++)r=e[o],t+=String.fromCodePoint(r>251&&r<254&&o+5<n?(r-252)*1073741824+(e[++o]-128<<24)+(e[++o]-128<<18)+(e[++o]-128<<12)+(e[++o]-128<<6)+e[++o]-128:r>247&&r<252&&o+4<n?(r-248<<24)+(e[++o]-128<<18)+(e[++o]-128<<12)+(e[++o]-128<<6)+e[++o]-128:r>239&&r<248&&o+3<n?(r-240<<18)+(e[++o]-128<<12)+(e[++o]-128<<6)+e[++o]-128:r>223&&r<240&&o+2<n?(r-224<<12)+(e[++o]-128<<6)+e[++o]-128:r>191&&r<224&&o+1<n?(r-192<<6)+e[++o]-128:r);return t};Oe.uft8ToString=us;var ls=e=>{let t,r=e.length,n=0;for(let i=0;i<r;i++)t=e.codePointAt(i),t>=65536&&i++,n+=t<128?1:t<2048?2:t<65536?3:t<2097152?4:t<67108864?5:6;let o=new Uint8Array(n),s=0,a=0;for(;s<n;)t=e.codePointAt(a),t<128?o[s++]=t:t<2048?(o[s++]=192+(t>>>6),o[s++]=128+(t&63)):t<65536?(o[s++]=224+(t>>>12),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63)):t<2097152?(o[s++]=240+(t>>>18),o[s++]=128+(t>>>12&63),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63),a++):t<67108864?(o[s++]=248+(t>>>24),o[s++]=128+(t>>>18&63),o[s++]=128+(t>>>12&63),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63),a++):(o[s++]=252+(t>>>30),o[s++]=128+(t>>>24&63),o[s++]=128+(t>>>18&63),o[s++]=128+(t>>>12&63),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63),a++),a++;return o};Oe.stringToUtf8=ls});var Zr=y(_e=>{"use strict";Object.defineProperty(_e,"__esModule",{value:!0});_e.getByPath=_e.setByPath=void 0;function cs(e,t,r){if(typeof e!="object")return e;let n=e;for(let o=0;o<t.length;o++){let s=t[o];if(o===t.length-1){n[s]=r;break}n[s]===void 0&&(typeof t[o+1]=="number"?n[s]=[]:n[s]={}),n=n[s]}return e}_e.setByPath=cs;var hs=(e,t)=>{if(typeof e!="object")return;let r=e;for(let n=0;n<t.length;n++){let o=t[n];if(r?.[o]!==void 0)r=r[o];else{r=void 0;break}}return r};_e.getByPath=hs});var re=y(m=>{"use strict";var ps=m&&m.__createBinding||(Object.create?function(e,t,r,n){n===void 0&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);(!o||("get"in o?!t.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){n===void 0&&(n=r),e[n]=t[r]}),ne=m&&m.__exportStar||function(e,t){for(var r in e)r!=="default"&&!Object.prototype.hasOwnProperty.call(t,r)&&ps(t,e,r)},oe=m&&m.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(m,"__esModule",{value:!0});m.randomString=m.retry=m.toEnvVar=m.deepEqual=m.wait=m.isObject=m.readStream=m.queued=m.deepCopy=void 0;var ds=oe(Sr());m.deepCopy=ds.default;var vs=oe(xr());m.isObject=vs.default;var gs=oe(Or());m.wait=gs.default;var ys=oe(_r());m.deepEqual=ys.default;var ms=oe(jr());m.toEnvVar=ms.default;var bs=oe(Ar());m.readStream=bs.default;var ws=oe(Cr());m.queued=ws.default;var Ss=oe(kr());m.retry=Ss.default;var xs=oe(Lr());m.randomString=xs.default;ne(Nt(),m);ne($r(),m);ne(Kr(),m);ne(Jr(),m);ne(Br(),m);ne(Hr(),m);ne(Wr(),m);ne(Gr(),m);ne(Zr(),m)});var Xr=y((Gi,Yr)=>{Yr.exports=fetch});var un=y((Zi,fn)=>{var _s=Object.create,ot=Object.defineProperty,js=Object.getOwnPropertyDescriptor,Ps=Object.getOwnPropertyNames,As=Object.getPrototypeOf,Ts=Object.prototype.hasOwnProperty,Ms=(e,t)=>{for(var r in t)ot(e,r,{get:t[r],enumerable:!0})},tn=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ps(t))!Ts.call(e,o)&&o!==r&&ot(e,o,{get:()=>t[o],enumerable:!(n=js(t,o))||n.enumerable});return e},Is=(e,t,r)=>(r=e!=null?_s(As(e)):{},tn(t||!e||!e.__esModule?ot(r,"default",{value:e,enumerable:!0}):r,e)),zs=e=>tn(ot({},"__esModule",{value:!0}),e),rn={};Ms(rn,{default:()=>Rs,genCache:()=>sn,getServicePort:()=>nn});fn.exports=zs(rn);var Ds=Is(Xr()),Bt=re(),qs=e=>{let t=5381,r=e.length;for(;r;)t=t*33^e.charCodeAt(--r);let n=t>>>0;for(;n>65535;)n=n/10;return Math.round(n)},nn=(e,t,r,n,o="allServices",s=0)=>qs(`${o}-${e}-${t}-${r}-${n}-${s}`),Qs=pe(),on=e=>e||"@based/env-hub",Fs={"@based/env-hub":0,"@based/env-admin-hub":1,"@based/admin-hub":2,"@based/machine-hub":3},sn=e=>{let t=Fs[on(e.name)],r=Math.floor(Math.random()*1e4),n=t+""+r;return e.key?n+"/"+(e.optionalKey?e.key+"$":e.key):n},Cs=async(e,t,r)=>{try{let n=await(0,Ds.default)(`${e}/status/${sn(t)}`,{headers:t.headers});if(n.ok){let o=n.headers.get("x-request-id");if(!o)return 1;let{decode:s}=(0,Bt.createEncoder)(ks,o.slice(0,6).split("")),a=s(o.slice(6)).split(","),i=[];for(let l=0;l<Math.floor(a.length/2);l++)i.push([a[l],encodeURIComponent(a[a.length-1-l])]);let[f,u]=i[~~(Math.random()*i.length)];return r?`${/^https/.test(e)?"https":"http"}://${f}`:`${/^https/.test(e)?"wss":"ws"}://${f}/${u}`}else return!1}catch{return!1}},en=/^ws/,Es=({cluster:e="production",org:t,project:r,env:n,name:o})=>{if(e==="local")return[`http://localhost:${nn(t,r,n,on(o).includes("env-")?"@based/env-hub-discovery":"@based/hub-discovery","allServices")}`];let s="-status";return[`https://${(0,Qs.hashObjectIgnoreKeyOrder)({org:t,project:r,env:n,cluster:e}).toString(36)}${s}.based.dev`]},an=async(e,t=!1,r=0)=>{if(e.url){let o;return typeof e.url=="function"?o=await e.url():o=e.url,t&&o&&en.test(o)?o.replace(en,"http"):o}let n=e.discoveryUrls||Es(e);for(let o=0;o<n.length;o++){let s=n[o],a=await Promise.race([Cs(s,e,t),(0,Bt.wait)(3e3)]);if(a===1||!a&&o===n.length-1)return await(0,Bt.wait)(Math.min(r*r*50+500,5e3)),an(e,t,++r);if(a)return a}},ks=[",",".based.dev","localhost:","localhost","based.io","based.dev","@based","/env-hub","admin","hub","900","90","443","80",":","%","/","=","<","?","."],Ls=an,Rs=async(e,t)=>Ls(e,t)});var Un=y(ur=>{"use strict";Object.defineProperty(ur,"__esModule",{value:!0});var En=re(),kn=(e,t,r)=>{if(r.constructor===Array){let n=r[0];if(n===0)e[t]=r[1];else if(n===1)delete e[t];else if(n===2){let o=Ln(e[t],r[1]);if(o===null)return null;e[t]=o}}else{if(r.___$toObject&&e[t]&&e[t].constructor===Array){let n={};for(let o=0;o<e[t].length;o++)n[o]=e[t][o];e[t]=n}if(e[t]===void 0)return console.warn("Diff apply patch: Cannot find key in original object",t,JSON.stringify(r,null,2)),null;for(let n in r)if(n!=="___$toObject"&&kn(e[t],n,r[n])===null)return null}},Ln=(e,t)=>{let r=t.length,n=new Array(t[0]),o=-1,s=[],a={};for(let f=1;f<r;f++){let u=t[f],l=u[0];if(l===0)for(let c=1;c<u.length;c++)n[++o]=u[c];else if(l===1){let c=u[2],p=u[1]+c;for(let h=c;h<p;h++){let d=typeof e[h];if(d==="object"&&h in a){let v=En.deepCopy(e[h]);n[++o]=v}else d==="object"&&(a[h]=!0),n[++o]=e[h]}}else if(l===2){let c=u[1],p=u.length-2+c;for(let h=c;h<p;h++){let d=[++o,h,u[h-c+2]];s.push(d)}}}let i=s.length;for(let f=0;f<i;f++){let[u,l,c]=s[f],p=l in a?En.deepCopy(e[l]):e[l],h=Rn(p,c);if(h===null)return null;n[u]=h}return n},Rn=(e,t)=>{if(t)if(t.constructor===Array){let r=t[0];if(r===0)return t[1];if(r===1)return;if(r===2)return Ln(e,t[1])}else{if(t.___$toObject&&e&&e.constructor===Array){let r={};for(let n=0;n<e.length;n++)r[n]=e[n];e=r}for(let r in t)if(r!=="___$toObject"&&kn(e,r,t[r])===null)return null;return e}else return e};ur.default=Rn});var $n=y(ze=>{"use strict";var ri=ze&&ze.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ze,"__esModule",{value:!0});ze.execCreatePartialDiff=void 0;var Nn=re(),ni=ri(lr()),oi=(e,t,r)=>{let n=e(t);if(n!==!1)if(n.type==="array"){let o=[];if(!Array.isArray(t))return o[0]=0,console.log("no current value do something..."),o;o[0]=2;let s=[t.length];o[1]=s,n.values.sort((c,p)=>c.index<p.index?-1:c.index===p.index?0:1);let a=0,i,f=0,u=0,l=!0;for(let c of n.values){let p=c.type,h=c.index;if(f){if(h+f>a+1){let d=h-a-1;d>0&&(u+=d,s.push([1,h-a-1,a+1]))}}else if(i?h>a:h>a+1)if(i)if(p==="insert"){let d=h-a-1;s[0]++,d>0&&(u+=d,s.push([1,d,a+1]))}else{let d=h-a;d>0&&(u+=d,s.push([1,d,a+1]))}else{let d=h-a;d>0&&(u+=d,s.push([1,d,a]))}if(p==="delete")s[0]--,i=!0,l=!1,f&&s.length>1&&s[s.length-1][0]===1&&s[s.length-1][2]--,f=0;else{if(p==="update"||p==="merge"){l=!0;let d=!1,v=c.value;if(p==="merge"){let x=c.fromIndex||h;if(!(!t[x]||typeof t[x]!="object")){let O=Nn.deepMerge(Nn.deepCopy(t[x]),v);v=[2,x,ni.default(t[x],O)],d=!0}}let w=s[s.length-1];!d&&s.length>1&&w[0]===0?(w.push(v),u++,h++):(a===0&&h===1&&!i&&(s.push([1,1,0]),u++),u++,d?s.push(v):s.push([0,v]),h++)}else if(p==="insert"){l=!1;let d=s.length,v;d>1&&(v=s[d-1]),d>1&&v[0]===0?c.values?(f=c.values.length,s[0]+=c.values.length,v.push(...c.values)):(s[0]++,f=1,v.push(c.value)):c.values?(f=c.values.length,s[0]+=c.values.length,s.push([0].concat(c.values))):(s[0]++,f=1,s.push([0,c.value])),u+=f}i=!1}a=h}if(u<s[0]){let c=s[0]-u;i||l?c>0&&s.push([1,c,a+1]):c>0&&s.push([1,c,a])}return o}else{if(n.type==="update")return[0,n.value];if(n.type==="delete")return[1]}};ze.execCreatePartialDiff=oi});var Wn=y(G=>{"use strict";Object.defineProperty(G,"__esModule",{value:!0});G.createPatch=G.arrayDiff=void 0;var si=pe(),Jn=$n(),Kn=e=>e===null?"___isNull$":e===!1?"___isFalse$":e===!0?"___isTrue$":typeof e=="object"&&e!==null?"___obj"+si.hashObject(e):e,ii=(e,t,r)=>{let n=e.length,o=t.length,s={},a=new Array(n);for(let l=0;l<n;l++){let c=Kn(e[l]);s[c]||(s[c]=[]),s[c].push(l),a[l]=c}let i=[],f=0;i[0]=o;for(let l=0;l<o;l++){let c=a[l],p=Kn(t[l]),h=i[f],d=i[f]&&i[f][0];if(c===p){let v=!1;if(d===1){let w=h[2];for(let x=0;x<w.length;x++){let O=w[x];if(O+h[1]===l){v=O;break}}}v!==!1?(h[1]++,h[2]=[v]):v===!1&&(d===1&&(h[2]=h[2][0]),f++,i[f]=[1,1,[l]])}else if(s[p]){let v=!1;if(d===1)for(let w=0;w<s[p].length;w++){let x=s[p][w],O=h[2],R=!1;for(let Q=0;Q<O.length;Q++){let I=O[Q];if(I+h[1]===x){v=I,R=!0;break}}if(R)break}v!==!1?(h[1]++,h[2]=[v]):v===!1&&(d===1&&(h[2]=h[2][0]),f++,i[f]=[1,1,s[p]])}else if(d===1&&(h[2]=h[2][0]),typeof e[l]=="object"&&typeof t[l]=="object"){let v=G.createPatch(e[l],t[l],r);d===2?h.push(v):(f++,i[f]=[2,l,v])}else d===0?h.push(t[l]):(f++,i[f]=[0,t[l]])}let u=i[i.length-1];if(u[0]===1&&(u[2]=u[2][0]),!(i.length===2&&i[1][0]===1&&i[1][1]===i[0]&&i[1][2]===0&&i[0]===n))return i};G.arrayDiff=ii;var Bn=(e,t,r,n,o)=>{let s=typeof t;if(s==="function"&&o&&o.parseDiffFunctions){let a=Jn.execCreatePartialDiff(t,e,o);a&&(r[n]=a)}else if(s!==typeof e)r[n]=[0,t];else if(s==="object")if(t===null)r[n]=[0,null];else{let a;if(t.constructor===Array)if(t.length===0)e&&e.constructor===Array&&e.length===0||(a=[0,[]],r[n]=a);else if(e&&e.constructor===Array){let i=G.arrayDiff(e,t,o);i&&i.length>1&&(a=[2,i],r[n]=a)}else{let i=G.arrayDiff(e,t,o);i&&i.length>1&&(a=[0,i],r[n]=a)}else{a={},e&&e.constructor===Array&&e.length&&(a.___$toObject=!0);for(let i in t)i in e?Bn(e[i],t[i],a,i,o):a[i]=[0,t[i]];for(let i in e)i in t||(a[i]=[1]);for(let i in a){r[n]=a;break}}}else e===t||(r[n]=[0,t])},Hn=(e,t,r)=>{let n=e[t];if(n){let o=typeof n;if(o==="function"){let s=Jn.execCreatePartialDiff(e[t],void 0,r);console.log(s),s?e[t]=s[1]:delete e[t]}else if(o==="object")for(let s in n)Hn(n,s,r)}},ai=(e,t,r)=>{let n=typeof t;if(n!==typeof e)return[0,t];if(n==="object"){if(t===null)return[0,null];if(t.constructor===Array){if(t.length===0)return e.constructor===Array&&e.length===0?void 0:[0,t];if(e.constructor===Array){let o=G.arrayDiff(e,t,r);if(o&&o.length>1)return[2,G.arrayDiff(e,t,r)]}else return[0,t]}else{let o={};e.constructor===Array&&(o.___$toObject=!0);for(let s in t)s in e?Bn(e[s],t[s],o,s,r):(r&&r.parseDiffFunctions&&Hn(t,s,r),o[s]=[0,t[s]]);for(let s in e)s in t||(o[s]=[1]);for(let s in o)return o}}else if(e!==t)return[0,t]};G.createPatch=ai});var lr=y(Z=>{"use strict";var fi=Z&&Z.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Z,"__esModule",{value:!0});Z.createPatch=Z.applyPatch=Z.arrayDiff=void 0;var ui=fi(Un());Z.applyPatch=ui.default;var cr=Wn();Object.defineProperty(Z,"createPatch",{enumerable:!0,get:function(){return cr.createPatch}});Object.defineProperty(Z,"arrayDiff",{enumerable:!0,get:function(){return cr.arrayDiff}});Z.default=cr.createPatch});var br=(e,t)=>{typeof e=="function"?e().then(r=>{t(r)}):t(e)};var Vr=fe(re(),1);var{encode:Os}=(0,Vr.createEncoder)(["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," "],["0"]),Jt=e=>encodeURI(Os(global.btoa(String.fromCodePoint(...new TextEncoder().encode(JSON.stringify(e))))));var je;(function(e){e[e.FunctionError=50001]="FunctionError",e[e.AuthorizeFunctionError=50002]="AuthorizeFunctionError",e[e.NoOservableCacheAvailable=50003]="NoOservableCacheAvailable",e[e.ObservableFunctionError=50004]="ObservableFunctionError",e[e.ObserveCallbackError=50005]="ObserveCallbackError",e[e.FunctionNotFound=40401]="FunctionNotFound",e[e.FunctionIsNotObservable=40402]="FunctionIsNotObservable",e[e.FunctionIsObservable=40403]="FunctionIsObservable",e[e.FunctionIsStream=40404]="FunctionIsStream",e[e.CannotStreamToObservableFunction=40405]="CannotStreamToObservableFunction",e[e.AuthorizeRejectedError=40301]="AuthorizeRejectedError",e[e.InvalidPayload=40001]="InvalidPayload",e[e.PayloadTooLarge=40002]="PayloadTooLarge",e[e.ChunkTooLarge=40003]="ChunkTooLarge",e[e.UnsupportedContentEncoding=40004]="UnsupportedContentEncoding",e[e.NoBinaryProtocol=40005]="NoBinaryProtocol",e[e.LengthRequired=41101]="LengthRequired",e[e.MethodNotAllowed=40501]="MethodNotAllowed",e[e.RateLimit=40029]="RateLimit",e[e.MissingAuthStateProtocolHeader=40030]="MissingAuthStateProtocolHeader",e[e.IncorrectAccessKey=40031]="IncorrectAccessKey"})(je=je||(je={}));var st=class extends Error{statusMessage;code},Pe=(e,t)=>{if(!e||typeof e!="object"){let a=new st(`Payload: ${e}`);return a.name="Invalid returned payload",a}let{message:r,code:n}=e,o=r?r[0]==="["?r:`[${je[n]}] `+r:n?"Cannot read error msg":JSON.stringify(e,null,2),s=new st(o);return s.stack=t?o+" "+t:o,s.name=je[n],s.code=n,s};var ln={streaming:!1};var Ae=null;typeof WebSocket<"u"?Ae=WebSocket:typeof MozWebSocket<"u"?Ae=MozWebSocket:typeof global<"u"?Ae=global.WebSocket||global.MozWebSocket:typeof window<"u"?Ae=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(Ae=self.WebSocket||self.MozWebSocket);var cn=Ae;var Te=new Map,it;typeof document<"u"&&document.addEventListener("visibilitychange",function(){clearTimeout(it),document.hidden?it=setTimeout(()=>{Te.forEach(e=>{e(!1)})},3e4):Te.forEach(e=>{e(!0)})});var Ht=(e,t,r={destroy:()=>{Te.delete(r)}},n=0,o=!1)=>(br(t,s=>{setTimeout(()=>{if(r.disconnected)return;let a=!0;Te.set(r,u=>{r.disconnected||(!u&&a?e.functionResponseListeners.size||ln.streaming?(console.warn("Send to background - streams or functions in progress try again in 10 seconds..."),clearTimeout(it),it=setTimeout(()=>{Te.forEach(l=>{l(!1)})},1e4)):(console.warn("Send to background - close connection"),a=!1,e.onClose(),i.close()):!a&&u&&(Te.delete(r),Ht(e,t,r,0,!0)))});let i=r.ws=new cn(s,[Jt(e.authState)]),f=!1;i.binaryType="blob",i.addEventListener("error",u=>{u.message&&u.message.includes("401")&&(f=!0)}),i.addEventListener("message",u=>{e.onData(u)}),i.addEventListener("open",()=>{if(a){if(r.disconnected)return;n=100,o&&e.onReconnect(),e.onOpen()}}),i.addEventListener("close",()=>{if(a){if(r.disconnected)return;e.onClose(),Ht(e,t,r,f?5e3:Math.min(2500,n+~~(Math.random()*500)+100),!0)}})},n)}),r),hn=Ht;var Wt=class{constructor(){Object.defineProperty(this,"listeners",{enumerable:!1,writable:!0})}listeners={};emit(t,r){if(this.listeners[t]){let n=this.listeners[t];for(let o=0,s=n.length;o<n.length;o++){let a=n[o];a(r),s>n.length&&n[o]!==a&&(o--,s=n.length)}}}on(t,r){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(r)}removeAllListeners(){this.listeners={}}once(t,r){if(!r)return new Promise(o=>{let s=a=>{o(a),this.off(t,s)};this.on(t,s)});let n=o=>{r(o),this.off(t,n)};this.on(t,n)}off(t,r){let n=this.listeners[t];if(n)if(!r)delete this.listeners[t];else{for(let o=0;o<n.length;o++)if(n[o]===r){n.splice(o,1),o--;break}n.length===0&&delete this.listeners[t]}}},pn=Wt;var F=Uint8Array,L=Uint16Array,at=Uint32Array,ft=new F([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ut=new F([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Yt=new F([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),yn=function(e,t){for(var r=new L(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var o=new at(r[30]),n=1;n<30;++n)for(var s=r[n];s<r[n+1];++s)o[s]=s-r[n]<<5|n;return[r,o]},mn=yn(ft,2),bn=mn[0],Xt=mn[1];bn[28]=258,Xt[258]=28;var wn=yn(ut,0),Us=wn[0],dn=wn[1],er=new L(32768);for(b=0;b<32768;++b)se=(b&43690)>>>1|(b&21845)<<1,se=(se&52428)>>>2|(se&13107)<<2,se=(se&61680)>>>4|(se&3855)<<4,er[b]=((se&65280)>>>8|(se&255)<<8)>>>1;var se,b,ee=function(e,t,r){for(var n=e.length,o=0,s=new L(t);o<n;++o)e[o]&&++s[e[o]-1];var a=new L(t);for(o=0;o<t;++o)a[o]=a[o-1]+s[o-1]<<1;var i;if(r){i=new L(1<<t);var f=15-t;for(o=0;o<n;++o)if(e[o])for(var u=o<<4|e[o],l=t-e[o],c=a[e[o]-1]++<<l,p=c|(1<<l)-1;c<=p;++c)i[er[c]>>>f]=u}else for(i=new L(n),o=0;o<n;++o)e[o]&&(i[o]=er[a[e[o]-1]++]>>>15-e[o]);return i},ce=new F(288);for(b=0;b<144;++b)ce[b]=8;var b;for(b=144;b<256;++b)ce[b]=9;var b;for(b=256;b<280;++b)ce[b]=7;var b;for(b=280;b<288;++b)ce[b]=8;var b,Ke=new F(32);for(b=0;b<32;++b)Ke[b]=5;var b,Ns=ee(ce,9,0),$s=ee(ce,9,1),Ks=ee(Ke,5,0),Js=ee(Ke,5,1),Gt=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},W=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(t&7)&r},Zt=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},nr=function(e){return(e+7)/8|0},Sn=function(e,t,r){(t==null||t<0)&&(t=0),(r==null||r>e.length)&&(r=e.length);var n=new(e.BYTES_PER_ELEMENT==2?L:e.BYTES_PER_ELEMENT==4?at:F)(r-t);return n.set(e.subarray(t,r)),n};var Bs=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],le=function(e,t,r){var n=new Error(t||Bs[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,le),!r)throw n;return n},Hs=function(e,t,r){var n=e.length;if(!n||r&&r.f&&!r.l)return t||new F(0);var o=!t||r,s=!r||r.i;r||(r={}),t||(t=new F(n*3));var a=function(Ze){var De=t.length;if(Ze>De){var ye=new F(Math.max(De*2,Ze));ye.set(t),t=ye}},i=r.f||0,f=r.p||0,u=r.b||0,l=r.l,c=r.d,p=r.m,h=r.n,d=n*8;do{if(!l){i=W(e,f,1);var v=W(e,f+1,3);if(f+=3,v)if(v==1)l=$s,c=Js,p=9,h=5;else if(v==2){var R=W(e,f,31)+257,Q=W(e,f+10,15)+4,I=R+W(e,f+5,31)+1;f+=14;for(var T=new F(I),j=new F(19),g=0;g<Q;++g)j[Yt[g]]=W(e,f+g*3,7);f+=Q*3;for(var V=Gt(j),C=(1<<V)-1,ge=ee(j,V,1),g=0;g<I;){var z=ge[W(e,f,C)];f+=z&15;var w=z>>>4;if(w<16)T[g++]=w;else{var U=0,D=0;for(w==16?(D=3+W(e,f,3),f+=2,U=T[g-1]):w==17?(D=3+W(e,f,7),f+=3):w==18&&(D=11+W(e,f,127),f+=7);D--;)T[g++]=U}}var E=T.subarray(0,R),P=T.subarray(R);p=Gt(E),h=Gt(P),l=ee(E,p,1),c=ee(P,h,1)}else le(1);else{var w=nr(f)+4,x=e[w-4]|e[w-3]<<8,O=w+x;if(O>n){s&&le(0);break}o&&a(u+x),t.set(e.subarray(w,O),u),r.b=u+=x,r.p=f=O*8,r.f=i;continue}if(f>d){s&&le(0);break}}o&&a(u+131072);for(var A=(1<<p)-1,N=(1<<h)-1,K=f;;K=f){var U=l[Zt(e,f)&A],Y=U>>>4;if(f+=U&15,f>d){s&&le(0);break}if(U||le(2),Y<256)t[u++]=Y;else if(Y==256){K=f,l=null;break}else{var $=Y-254;if(Y>264){var g=Y-257,B=ft[g];$=W(e,f,(1<<B)-1)+bn[g],f+=B}var X=c[Zt(e,f)&N],k=X>>>4;X||le(3),f+=X&15;var P=Us[k];if(k>3){var B=ut[k];P+=Zt(e,f)&(1<<B)-1,f+=B}if(f>d){s&&le(0);break}o&&a(u+131072);for(var q=u+$;u<q;u+=4)t[u]=t[u-P],t[u+1]=t[u+1-P],t[u+2]=t[u+2-P],t[u+3]=t[u+3-P];u=q}}r.l=l,r.p=K,r.b=u,r.f=i,l&&(i=1,r.m=p,r.d=c,r.n=h)}while(!i);return u==t.length?t:Sn(t,0,u)},ie=function(e,t,r){r<<=t&7;var n=t/8|0;e[n]|=r,e[n+1]|=r>>>8},Ne=function(e,t,r){r<<=t&7;var n=t/8|0;e[n]|=r,e[n+1]|=r>>>8,e[n+2]|=r>>>16},Vt=function(e,t){for(var r=[],n=0;n<e.length;++n)e[n]&&r.push({s:n,f:e[n]});var o=r.length,s=r.slice();if(!o)return[or,0];if(o==1){var a=new F(r[0].s+1);return a[r[0].s]=1,[a,1]}r.sort(function(I,T){return I.f-T.f}),r.push({s:-1,f:25001});var i=r[0],f=r[1],u=0,l=1,c=2;for(r[0]={s:-1,f:i.f+f.f,l:i,r:f};l!=o-1;)i=r[r[u].f<r[c].f?u++:c++],f=r[u!=l&&r[u].f<r[c].f?u++:c++],r[l++]={s:-1,f:i.f+f.f,l:i,r:f};for(var p=s[0].s,n=1;n<o;++n)s[n].s>p&&(p=s[n].s);var h=new L(p+1),d=tr(r[l-1],h,0);if(d>t){var n=0,v=0,w=d-t,x=1<<w;for(s.sort(function(T,j){return h[j.s]-h[T.s]||T.f-j.f});n<o;++n){var O=s[n].s;if(h[O]>t)v+=x-(1<<d-h[O]),h[O]=t;else break}for(v>>>=w;v>0;){var R=s[n].s;h[R]<t?v-=1<<t-h[R]++-1:++n}for(;n>=0&&v;--n){var Q=s[n].s;h[Q]==t&&(--h[Q],++v)}d=t}return[new F(h),d]},tr=function(e,t,r){return e.s==-1?Math.max(tr(e.l,t,r+1),tr(e.r,t,r+1)):t[e.s]=r},vn=function(e){for(var t=e.length;t&&!e[--t];);for(var r=new L(++t),n=0,o=e[0],s=1,a=function(f){r[n++]=f},i=1;i<=t;++i)if(e[i]==o&&i!=t)++s;else{if(!o&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(o),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(o);s=1,o=e[i]}return[r.subarray(0,n),t]},$e=function(e,t){for(var r=0,n=0;n<t.length;++n)r+=e[n]*t[n];return r},rr=function(e,t,r){var n=r.length,o=nr(t+2);e[o]=n&255,e[o+1]=n>>>8,e[o+2]=e[o]^255,e[o+3]=e[o+1]^255;for(var s=0;s<n;++s)e[o+s+4]=r[s];return(o+4+n)*8},gn=function(e,t,r,n,o,s,a,i,f,u,l){ie(t,l++,r),++o[256];for(var c=Vt(o,15),p=c[0],h=c[1],d=Vt(s,15),v=d[0],w=d[1],x=vn(p),O=x[0],R=x[1],Q=vn(v),I=Q[0],T=Q[1],j=new L(19),g=0;g<O.length;++g)j[O[g]&31]++;for(var g=0;g<I.length;++g)j[I[g]&31]++;for(var V=Vt(j,7),C=V[0],ge=V[1],z=19;z>4&&!C[Yt[z-1]];--z);var U=u+5<<3,D=$e(o,ce)+$e(s,Ke)+a,E=$e(o,p)+$e(s,v)+a+14+3*z+$e(j,C)+(2*j[16]+3*j[17]+7*j[18]);if(U<=D&&U<=E)return rr(t,l,e.subarray(f,f+u));var P,A,N,K;if(ie(t,l,1+(E<D)),l+=2,E<D){P=ee(p,h,0),A=p,N=ee(v,w,0),K=v;var Y=ee(C,ge,0);ie(t,l,R-257),ie(t,l+5,T-1),ie(t,l+10,z-4),l+=14;for(var g=0;g<z;++g)ie(t,l+3*g,C[Yt[g]]);l+=3*z;for(var $=[O,I],B=0;B<2;++B)for(var X=$[B],g=0;g<X.length;++g){var k=X[g]&31;ie(t,l,Y[k]),l+=C[k],k>15&&(ie(t,l,X[g]>>>5&127),l+=X[g]>>>12)}}else P=Ns,A=ce,N=Ks,K=Ke;for(var g=0;g<i;++g)if(n[g]>255){var k=n[g]>>>18&31;Ne(t,l,P[k+257]),l+=A[k+257],k>7&&(ie(t,l,n[g]>>>23&31),l+=ft[k]);var q=n[g]&31;Ne(t,l,N[q]),l+=K[q],q>3&&(Ne(t,l,n[g]>>>5&8191),l+=ut[q])}else Ne(t,l,P[n[g]]),l+=A[n[g]];return Ne(t,l,P[256]),l+A[256]},Ws=new at([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),or=new F(0),Gs=function(e,t,r,n,o,s){var a=e.length,i=new F(n+a+5*(1+Math.ceil(a/7e3))+o),f=i.subarray(n,i.length-o),u=0;if(!t||a<8)for(var l=0;l<=a;l+=65535){var c=l+65535;c>=a&&(f[u>>3]=s),u=rr(f,u+1,e.subarray(l,c))}else{for(var p=Ws[t-1],h=p>>>13,d=p&8191,v=(1<<r)-1,w=new L(32768),x=new L(v+1),O=Math.ceil(r/3),R=2*O,Q=function(Ot){return(e[Ot]^e[Ot+1]<<O^e[Ot+2]<<R)&v},I=new at(25e3),T=new L(288),j=new L(32),g=0,V=0,l=0,C=0,ge=0,z=0;l<a;++l){var U=Q(l),D=l&32767,E=x[U];if(w[D]=E,x[U]=D,ge<=l){var P=a-l;if((g>7e3||C>24576)&&P>423){u=gn(e,f,0,I,T,j,V,C,z,l-z,u),C=g=V=0,z=l;for(var A=0;A<286;++A)T[A]=0;for(var A=0;A<30;++A)j[A]=0}var N=2,K=0,Y=d,$=D-E&32767;if(P>2&&U==Q(l-$))for(var B=Math.min(h,P)-1,X=Math.min(32767,l),k=Math.min(258,P);$<=X&&--Y&&D!=E;){if(e[l+N]==e[l+N-$]){for(var q=0;q<k&&e[l+q]==e[l+q-$];++q);if(q>N){if(N=q,K=$,q>B)break;for(var Ze=Math.min($,q-2),De=0,A=0;A<Ze;++A){var ye=l-$+A+32768&32767,oo=w[ye],vr=ye-oo+32768&32767;vr>De&&(De=vr,E=ye)}}}D=E,E=w[D],$+=D-E+32768&32767}if(K){I[C++]=268435456|Xt[N]<<18|dn[K];var gr=Xt[N]&31,yr=dn[K]&31;V+=ft[gr]+ut[yr],++T[257+gr],++j[yr],ge=l+N,++g}else I[C++]=e[l],++T[e[l]]}}u=gn(e,f,s,I,T,j,V,C,z,l-z,u),!s&&u&7&&(u=rr(f,u+1,or))}return Sn(i,0,n+nr(u)+o)};var Zs=function(e,t,r,n,o){return Gs(e,t.level==null?6:t.level,t.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(e.length)))*1.5):12+t.mem,r,n,!o)};function lt(e,t){return Zs(e,t||{},0,0)}function ae(e,t){return Hs(e,t)}var Vs=typeof TextDecoder<"u"&&new TextDecoder,Ys=0;try{Vs.decode(or,{stream:!0}),Ys=1}catch{}var On=new TextDecoder,_n=new TextEncoder,Xs=e=>{let t=global.atob(e),r=On.decode(ae(_n.encode(t)));return JSON.parse(r)},ct=(e,t)=>{let r=localStorage.getItem(t);r&&(e.storageSize-=new Blob([r]).size,localStorage.setItem("@based-size",String(e.storageSize)),localStorage.removeItem(t))},Je=()=>{let e=Object.keys(localStorage);try{for(let t of e)t.startsWith("@based")&&localStorage.removeItem(t)}catch{try{localStorage.clear()}catch{console.error("Based - Error clearing localStorage")}}},ir=(e,t,r)=>{try{let n=e.storageEnvKey;if(!n)return;let o=localStorage.getItem(t),s=JSON.stringify(r),a=s.length>70||t==="@based-authState-"+n?global.btoa(On.decode(lt(_n.encode(s)))):s,f=new Blob([a]).size;o&&(e.storageSize-=new Blob([o]).size),e.storageSize+=f,e.storageSize>e.maxStorageSize&&(console.info("Based - Max localStorage size reached - clear"),Je(),e.storageSize=0,e.authState.persistent===!0&&ir(e,"@based-authState-"+n,e.authState),e.storageSize+=f),localStorage.setItem("@based-size",String(e.storageSize)),localStorage.setItem(t,a)}catch(n){console.error(`Based - Error writing ${t} to localStorage`,n)}},xn=(e,t)=>{let r=e.storageEnvKey;if(!!r)try{let n=localStorage.getItem(t);if(n!==void 0){if(n.length<70&&t!=="@based-authState-"+r)try{return JSON.parse(n)}catch{}return Xs(n)}return}catch{console.error(`Based - Error parsing ${t} from localStorage`)}},jn=async e=>{let t=e.storageEnvKey;if(!t)return;let r=global.__basedcache__??{};for(let n in r)e.cache.set(Number(n),r[n]);try{let n=Number(localStorage.getItem("@based-size")||0);n<0&&(console.error("Based - Corrupt localStorage (negative size) - clear"),Je(),n=0),e.storageSize=n;let o=Object.keys(localStorage);if(o.length===1&&n>0&&(console.error("Based - Corrupt localStorage (size but no keys) - clear",n),Je(),n=0),console.info(`Based - init localstorage stored ${~~(n/1024)+"kb"}`),n>0)for(let s of o){if(s==="@based-size"||!s.startsWith("@based"))continue;if(s==="@based-authState-"+t){let l=xn(e,s);l&&e.setAuthState(l).catch(c=>{console.error(c.message),ct(e,s)});continue}let[,a]=s.split("@based-cache-");if(!a)continue;let[i,f]=a.split("-");if(f!==String(t))continue;if(!i){console.warn("Based - clear corrupt localStorage item"),ct(e,s);continue}let u=xn(e,s);e.cache.set(Number(i),u)}}catch{console.error("Based - Cannot read localStorage")}};var Be=typeof window<"u",ht=(e,t)=>{let r=e.storageEnvKey;!r||(Be?(t+="-"+r,ct(e,t)):e.storagePath)},ve=(e,t,r)=>{let n=e.storageEnvKey;!n||(Be?(t+="-"+n,ir(e,t,r)):e.storagePath)},ar=async e=>{Be||e.storagePath},Pn=async e=>{if(Be)return jn(e);e.storagePath},An=async e=>{if(Be)return Je();e.storagePath};var Me=(e,t)=>{t.persistent?ve(e,"@based-authState",t):ht(e,"@based-authState"),e.authState=t};var He=new TextEncoder,M=(e,t,r,n)=>{for(let o=r;o<r+n;o++){let s=t&255;e[o]=s,t=(t-s)/256}},he=(e,t,r)=>{let n=(e<<1)+(t|0);return(r<<4)+n},Ie=(e,t=!1)=>{let r,n=!1;return e!==void 0?(r=He.encode(typeof e=="string"?e:JSON.stringify(e)),!t&&r.length>150&&(r=lt(r),n=!0),[n,r]):[!1]},Tn=(e,t)=>{let r=4,[n,o,s,a]=t;if(n===3){let i=He.encode(o);r+=1+i.length;let[f,u]=Ie(a);u&&(r+=u.length);let l=16;r+=l;let c=he(n,f,r),p=new Uint8Array(1+4+l);return M(p,c,0,4),M(p,e,4,8),M(p,s,12,8),p[20]=i.length,u?{buffers:[p,i,u],len:r}:{buffers:[p,i],len:r}}return{buffers:[],len:0}},pt=(e,t)=>{let r=4,[n,o,s]=t;if(n===7){let p=he(n,!1,12),h=new Uint8Array(4+8);return M(h,p,0,4),M(h,e,4,8),{buffers:[h],len:12}}let a=He.encode(o);r+=1+a.length;let i=n===6,[,f]=Ie(s,!0);f&&(r+=f.length);let u=8;r+=u;let l=he(5,i,r),c=new Uint8Array(1+4+u);return M(c,l,0,4),M(c,e,4,8),c[12]=a.length,f?{buffers:[c,a,f],len:r}:{buffers:[c,a],len:r}},Mn=(e,t)=>{let r=4,[n,o,s,a]=t;if(n===2){let h=he(n,!1,12),d=new Uint8Array(4+8);return M(d,h,0,4),M(d,e,4,8),{buffers:[d],len:12}}let i=He.encode(o);r+=1+i.length;let[f,u]=Ie(a);u&&(r+=u.length);let l=16;r+=l;let c=he(n,f,r),p=new Uint8Array(1+4+l);return M(p,c,0,4),M(p,e,4,8),M(p,s,12,8),p[20]=i.length,u?{buffers:[p,i,u],len:r}:{buffers:[p,i],len:r}},In=e=>{let t=7,[r,n,o]=e,s=He.encode(n);t+=1+s.length;let[a,i]=Ie(o);i&&(t+=i.length);let f=he(0,a,t),u=new Uint8Array(4+3+1);return M(u,f,0,4),M(u,r,4,3),u[7]=s.length,i?{buffers:[u,s,i],len:t}:{buffers:[u,s],len:t}},zn=e=>{let t=12,[r,n]=e,[o,s]=Ie(n);s&&(t+=s.length);let a=he(6,o,t),i=new Uint8Array(4+8);return M(i,a,0,4),M(i,r,4,8),s?{buffers:[i,s],len:t}:{buffers:[i],len:t}},Dn=e=>{let t=4,[r,n]=Ie(e);n&&(t+=n.length);let o=he(4,r,t),s=new Uint8Array(t);return M(s,o,0,4),n&&s.set(n,4),s};var qn=fe(re(),1),ei=new Uint8Array(0),ti=e=>{clearTimeout(e.idlePing),e.idlePing=setTimeout(()=>{e.connection&&e.connected&&!e.connection.disconnected&&e.connection.ws.send(ei)},6e4)},te=e=>{if(e.connected&&!e.drainInProgress&&(e.functionQueue.length||e.observeQueue.size||e.getObserveQueue.size||e.channelQueue.size||e.publishQueue.length)){e.drainInProgress=!0;let t=()=>{if(e.drainInProgress=!1,!!e.connected&&(e.functionQueue.length||e.observeQueue.size||e.getObserveQueue.size||e.channelQueue.size||e.publishQueue.length)){let r=e.channelQueue,n=e.publishQueue,o=e.functionQueue,s=e.observeQueue,a=e.getObserveQueue,i=[],f=0;for(let[c,p]of r){let{buffers:h,len:d}=pt(c,p);i.push(...h),f+=d}for(let[c,p]of a){let{buffers:h,len:d}=Tn(c,p);i.push(...h),f+=d}for(let[c,p]of s){let{buffers:h,len:d}=Mn(c,p);i.push(...h),f+=d}for(let c of o){let{buffers:p,len:h}=In(c);i.push(...p),f+=h}for(let c of n){let{buffers:p,len:h}=zn(c);i.push(...p),f+=h}let u=new Uint8Array(f),l=0;for(let c of i)u.set(c,l),l+=c.length;e.functionQueue=[],e.publishQueue=[],e.observeQueue.clear(),e.getObserveQueue.clear(),e.channelQueue.clear(),e.connection.ws.send(u),ti(e)}};e.drainTimeout=setTimeout(t,0)}};var We=(e,t,r,n,o)=>{e.requestId++,e.requestId>16777215&&(e.requestId=0);let s=e.requestId,a=Error().stack.split(/BasedClient\.function.+:\d\d\)/)[1];e.functionResponseListeners.set(s,[n,o,a]),e.functionQueue.push([s,r,t]),te(e)},Qn=(e,t)=>{e.channelQueue.get(t)?.[0]!==7&&(e.channelQueue.set(t,[7]),te(e))},dt=(e,t,r,n)=>{e.channelQueue.get(r)?.[0]!==5&&(e.channelQueue.set(r,[5,t,n]),te(e))},vt=(e,t,r,n)=>{let o=e.channelQueue.get(r)?.[0];o===5||o===6||(o===7&&console.warn("Case not handled yet... ubsub and req for info for channel"),e.channelQueue.set(r,[6,t,n]),te(e))},Fn=(e,t,r)=>{e.publishQueue.length>e.maxPublishQueue&&e.publishQueue.shift(),e.publishQueue.push([t,r]),te(e)},Cn=(e,t)=>{e.observeQueue.get(t)?.[0]!==2&&(e.observeQueue.set(t,[2]),te(e))},gt=(e,t,r,n,o=0)=>{e.observeQueue.get(r)?.[0]!==1&&(e.observeQueue.set(r,[1,t,o,n]),te(e))},yt=(e,t,r,n,o=0)=>{e.getObserveQueue.has(r)||(e.getObserveQueue.set(r,[3,t,o,n]),te(e))},fr=async(e,t)=>(0,qn.deepEqual)(t,e.authState)?(console.warn("[Based] Trying to send the same authState twice",e.authState),e.authRequest.inProgress?e.authRequest.promise:new Promise(r=>r({}))):(e.authRequest.inProgress&&(console.warn("[Based] Authentication still in progress - waiting until done"),await e.authRequest.promise),Me(e,t),e.emit("authstate-change",e.authState),e.connected&&e.connection.ws.send(Dn(t)),e.authRequest.promise=new Promise((r,n)=>{e.authRequest.inProgress=!0,e.authRequest.resolve=r,e.authRequest.reject=n}).finally(()=>{e.authRequest.resolve=null,e.authRequest.reject=null,e.authRequest.inProgress=!1}),e.authRequest.promise);var Vn=fe(lr(),1);var Yn=fe(re(),1);var Gn=e=>{let t=e>>4,r=e&15,n=r>>1,o=r&1;return{type:n,isDeflate:o===1,len:t}},J=(e,t,r)=>{let n=0,o=r-1+t;for(let s=o;s>=t;s--)n=n*256+e[s];return n},Zn=async e=>{if(e instanceof ArrayBuffer)return new Uint8Array(e);if(typeof window>"u"){if(e instanceof Buffer)return new Uint8Array(e)}else if(e instanceof Blob){let t=await e.arrayBuffer();return new Uint8Array(t)}throw new Error("Recieved incorrect data")},mt=(e,t)=>{let r=e.observeState.get(t);if(!r){console.warn("Cannot find query function name for id from diff [id]");return}yt(e,r.name,t,r.payload)};var hr=(e,t,r)=>{let n=r==="sub"?e.observeState.get(t):e.channelState.get(t);return n?n.payload?{name:n.name,payload:n.payload,id:t}:{name:n.name,id:t}:{name:`[Cannot find ${t}]`,id:t}};var Xn=async(e,t)=>{if(!e.isDestroyed)try{let r=t.data,n=await Zn(r),{type:o,len:s,isDeflate:a}=Gn(J(n,0,4));if(o===0){let i=J(n,4,3),f=7,u=s+4,l;s!==3&&(l=JSON.parse(new TextDecoder().decode(a?ae(n.slice(f,u)):n.slice(f,u)))),e.functionResponseListeners.has(i)&&(e.functionResponseListeners.get(i)[0](l),e.functionResponseListeners.delete(i))}else if(o===3){let i=J(n,4,8);if(e.getState.has(i)&&e.cache.has(i)){let f=e.getState.get(i);for(let[u]of f)u(e.cache.get(i).value);e.getState.delete(i)}}else if(o===2){let i=J(n,4,8),f=e.cache.get(i);if(!f){mt(e,i);return}let u=J(n,12,8),l=J(n,20,8);if(f.checksum!==l){mt(e,i);return}let c=28,p=s+4,h;s!==24&&(h=JSON.parse(new TextDecoder().decode(a?ae(n.slice(c,p)):n.slice(c,p))));try{f.value=(0,Vn.applyPatch)(f.value,h),f.checksum=u}catch{mt(e,i);return}if(e.observeState.has(i)){let d=e.observeState.get(i);d.persistent&&(f.persistent=!0,ve(e,"@based-cache-"+i,f));for(let[,v]of d.subscribers)v.onData(f.value,u)}if(e.getState.has(i)){let d=e.getState.get(i);for(let[v]of d)v(f.value);e.getState.delete(i)}}else if(o===1){let i=J(n,4,8),f=J(n,12,8),u=20,l=s+4,c;s!==16&&(c=JSON.parse(new TextDecoder().decode(a?ae(n.slice(u,l)):n.slice(u,l))));let p={value:c,checksum:f};if(e.cache.set(i,p),e.observeState.has(i)){let h=e.observeState.get(i);h.persistent&&(p.persistent=!0,ve(e,"@based-cache-"+i,p));for(let[,d]of h.subscribers)d.onData(c,f)}if(e.getState.has(i)){let h=e.getState.get(i);for(let[d]of h)d(c);e.getState.delete(i)}}else if(o===4){let f=s+4,u;s!==3&&(u=JSON.parse(new TextDecoder().decode(a?ae(n.slice(4,f)):n.slice(4,f)))),u===!0?e.authRequest.resolve?.(e.authState):"error"in u?(Me(e,u),e.emit("authstate-change",e.authState),e.authRequest.reject?.(new Error(u.error))):((0,Yn.deepEqual)(e.authState,u)?Me(e,u):(Me(e,u),e.emit("authstate-change",e.authState)),e.authRequest?.resolve?.(e.authState))}else if(o===5){let f=s+4,u;if(s!==3&&(u=JSON.parse(new TextDecoder().decode(a?ae(n.slice(4,f)):n.slice(4,f)))),u.requestId&&e.functionResponseListeners.has(u.requestId)){let[,l,c]=e.functionResponseListeners.get(u.requestId);l(Pe(u,c)),e.functionResponseListeners.delete(u.requestId)}if(u.channelId&&e.channelState.has(u.channelId)){let l=Pe(u),c=e.channelState.get(u.channelId);for(let[,p]of c.subscribers)p.onError?p.onError(l):console.error(hr(e,u.channelId,"channel"),l)}if(u.observableId){if(e.cache.delete(u.observableId),e.observeState.has(u.observableId)){let l=Pe(u),c=e.observeState.get(u.observableId);for(let[,p]of c.subscribers)p.onError?p.onError(l):console.error(hr(e,u.observableId,"sub"),l)}if(e.getState.has(u.observableId)){let l=Pe(u),c=e.getState.get(u.observableId);for(let[,p]of c)p(l);e.getState.delete(u.observableId)}}}else if(o===6){let i=J(n,4,8),f=e.channelState.get(i);if(i){if(!f.inTransit){f.inTransit=!0;let{buffers:u,len:l}=pt(i,[6,f.name,f.payload]),c=new Uint8Array(l),p=0;for(let h of u)c.set(h,p),p+=h.length;e.connection.ws.send(c),f.removeTimer!==-1&&f.removeTimer<2&&(f.removeTimer+=1),setTimeout(()=>{let h=e.channelState.get(i);h&&(h.inTransit=!1)},5e3)}e.connection.ws.send(n)}}else if(o===7&&J(n,4,1)===0){let f=J(n,5,8),u=13,l=s+5,c;if(s!==9){let p=new TextDecoder().decode(a?ae(n.slice(u,l)):n.slice(u,l));try{c=JSON.parse(p)}catch{c=p}}if(e.channelState.has(f)){let p=e.channelState.get(f);for(let[,h]of p.subscribers)h.onMessage(c)}}}catch(r){console.error(981,r)}};var bt=fe(pe(),1),wt=(e,t)=>t===void 0?(0,bt.hash)(e):(0,bt.hashObjectIgnoreKeyOrder)([e,t]);var St=class{id;query;name;client;persistent;constructor(t,r,n,o){this.query=n,this.id=wt(r,n),this.client=t,this.name=r,this.persistent=o?.persistent||!1}get cache(){return this.client.cache.get(this.id)||null}clearCache(){this.persistent&&ht(this.client,"@based-cache-"+this.id),this.client.cache.delete(this.id)}subscribe(t,r){let n,o=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){let s=this.client.observeState.get(this.id);this.persistent&&!s.persistent&&(s.persistent=!0,o&&ve(this.client,"@based-cache-"+this.id,o)),n=++s.idCnt,s.subscribers.set(n,{onError:r,onData:t})}else{n=1;let s=new Map;s.set(n,{onError:r,onData:t}),this.client.observeState.set(this.id,{payload:this.query,name:this.name,subscribers:s,persistent:this.persistent||!1,idCnt:1}),gt(this.client,this.name,this.id,this.query,o?.checksum||0)}return o&&t(o.value,o.checksum),()=>{let s=this.client.observeState.get(this.id);s?(s.subscribers.delete(n),s.subscribers.size===0&&(this.client.observeState.delete(this.id),Cn(this.client,this.id))):console.warn("Subscription allready removed",this.query,this.name)}}async getWhen(t){return new Promise(r=>{let n=this.subscribe((o,s)=>{t(o,s)&&(r(o),n())})})}async get(){return new Promise((t,r)=>{if(this.client.getState.has(this.id)){this.client.getState.get(this.id).push([t,r]);return}this.client.getState.set(this.id,[]);let n=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){if(this.client.observeQueue.has(this.id)){let[o]=this.client.observeQueue.get(this.id);if(o===1){this.client.getState.get(this.id).push([t,r]);return}}if(n){t(n.value);return}}this.client.getState.get(this.id).push([t,r]),yt(this.client,this.name,this.id,this.query,n?.checksum||0)})}};var eo=async(e,t,r,n)=>{};var Ge=e=>{e.channelCleanTimeout||(e.channelCleanTimeout=setTimeout(()=>{if(e.channelCleanTimeout=null,e.connected){let t=!1;e.channelState.forEach((r,n)=>{r.removeTimer!==-1&&(r.removeTimer--,r.removeTimer===0?e.channelState.delete(n):t=!0)}),t&&Ge(e)}else Ge(e)},e.channelCleanupCycle))};var xt=class{id;payload;name;client;constructor(t,r,n){this.payload=n,this.id=wt(r,n),this.client=t,this.name=r}subscribe(t,r){let n;if(!this.client.channelState.has(this.id)||this.client.channelState.get(this.id).subscribers.size===0){n=1;let o=new Map;o.set(n,{onMessage:t,onError:r}),this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:o,removeTimer:-1,idCnt:1}),dt(this.client,this.name,this.id,this.payload)}else{let o=this.client.channelState.get(this.id);o.removeTimer=-1,n=++o.idCnt,o.subscribers.set(n,{onMessage:t,onError:r})}return()=>{let o=this.client.channelState.get(this.id);o.subscribers.delete(n),o.subscribers.size===0&&(o.removeTimer=2,Qn(this.client,this.id))}}publish(t){if(!this.client.channelState.has(this.id))this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:new Map,removeTimer:2,idCnt:0}),Ge(this.client),vt(this.client,this.name,this.id,this.payload);else{let r=this.client.channelState.get(this.id);r.removeTimer!==-1&&r.removeTimer<2&&(r.removeTimer=2,Ge(this.client))}Fn(this.client,this.id,t)}};var to=fe(pe(),1),ro=fe(re(),1),no=fe(un(),1),li=no.default.default;var pr=class extends pn{constructor(t,r){super(),r?.persistentStorage&&(this.storagePath=r.persistentStorage),r?.maxCacheSize&&(console.warn("MaxCacheSize setting not implemented yet..."),this.maxCacheSize=r.maxCacheSize),t&&this.connect(t)}storageSize=0;maxStorageSize=5e6-500;storageEnvKey=0;storagePath;storageBeingWritten;opts;connected=!1;connection;url;outgoingStreams=new Map;isDrainingStreams=!1;maxPublishQueue=1e3;publishQueue=[];functionQueue=[];observeQueue=new Map;channelQueue=new Map;getObserveQueue=new Map;drainInProgress=!1;drainTimeout;idlePing;localStorage=!1;maxCacheSize=4e6;cache=new Map;functionResponseListeners=new Map;requestId=0;channelState=new Map;channelCleanTimeout;channelCleanupCycle=3e4;observeState=new Map;getState=new Map;authState={};authRequest={authState:null,promise:null,resolve:null,reject:null,inProgress:!1};onClose(){this.connected=!1,this.functionResponseListeners.size>this.functionQueue.length&&this.functionResponseListeners.forEach((t,r)=>{this.functionQueue.find(([n])=>n===r)||(t[1](new Error("Server disconnected before function result was processed")),this.functionResponseListeners.delete(r))}),this.emit("disconnect",!0)}onReconnect(){this.connected=!0,this.emit("reconnect",!0)}onOpen(){this.connected=!0,this.emit("connect",!0);for(let[t,r]of this.observeState)if(!this.observeQueue.has(t)){let n=this.cache.get(t);gt(this,r.name,t,r.payload,n?.checksum||0)}for(let[t,r]of this.channelState)this.channelQueue.has(t)||(r.subscribers.size?dt(this,r.name,t,r.payload):vt(this,r.name,t,r.payload));te(this)}onData(t){Xn(this,t)}async connect(t){if(t&&Object.keys(t).length>0){if(this.opts){if((0,ro.deepEqual)(this.opts,t))return;this.disconnect()}this.opts=t,this.url=()=>li(t),this.storageEnvKey=(0,to.hashObjectIgnoreKeyOrder)(t),Pn(this)}if(!this.opts){console.error("Configure opts to connect");return}this.url&&!this.connection&&(this.connection=hn(this,this.url))}disconnect(){this.connection&&(this.connection.disconnected=!0,this.connection.destroy(),this.connection.ws&&this.connection.ws.close(),this.connected&&this.onClose(),delete this.connection),clearTimeout(this.drainTimeout),clearTimeout(this.idlePing),this.connected=!1}isDestroyed;async destroy(t){t||await ar(this),clearTimeout(this.storageBeingWritten),clearTimeout(this.channelCleanTimeout),this.disconnect();for(let r in this)delete this[r];this.isDestroyed=!0}channel(t,r){return new xt(this,t,r)}query(t,r,n){return new St(this,t,r,n)}call(t,r,n){let o=n?.retryStrategy;return o?new Promise(s=>{let a=0,i=0,f=u=>{let l=o(u,a,i);i++,typeof l=="number"&&!isNaN(l)&&(a=l,l===0?We(this,r,t,s,f):setTimeout(()=>{We(this,r,t,s,f)},l))};return We(this,r,t,s,f)}):new Promise((s,a)=>We(this,r,t,s,a))}stream(t,r,n){return eo(this,t,r,n)}setAuthState(t){if(typeof t=="object")return fr(this,t);throw new Error("Invalid auth() arguments")}clearAuthState(){return fr(this,{})}clearStorage(){return An(this)}saveStorage(){return ar(this)}genCacheScript(){return`<script>window.__basedcache__=${JSON.stringify(ci(this))}<\/script>`}},ci=e=>{let t={};return e.cache.forEach((r,n)=>{t[n]=r}),t};function dr(e,t){return new pr(e,t)}var hi=dr({url:"ws://localhost:8082"}),pi=()=>{let e=document.body;hi.query("text").subscribe(t=>{e.innerHTML=t.map(r=>`<div>${r}</div>`).join("!!!----------")})};pi();})();
