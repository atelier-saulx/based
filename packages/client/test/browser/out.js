(()=>{var co=Object.create;var _r=Object.defineProperty;var ho=Object.getOwnPropertyDescriptor;var po=Object.getOwnPropertyNames;var vo=Object.getPrototypeOf,go=Object.prototype.hasOwnProperty;var y=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var yo=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of po(t))!go.call(e,o)&&o!==r&&_r(e,o,{get:()=>t[o],enumerable:!(n=ho(t,o))||n.enumerable});return e};var ae=(e,t,r)=>(r=e!=null?co(vo(e)):{},yo(t||!e||!e.__esModule?_r(r,"default",{value:e,enumerable:!0}):r,e));var Pr=y(Tt=>{"use strict";Object.defineProperty(Tt,"__esModule",{value:!0});var jr=e=>{let t=Array.isArray(e)?[]:{};for(let r in e)e[r]!==null&&typeof e[r]=="object"?t[r]=jr(e[r]):t[r]=e[r];return t};Tt.default=jr});var Ar=y(It=>{"use strict";Object.defineProperty(It,"__esModule",{value:!0});function mo(e){return e&&typeof e=="object"&&e.constructor!==Array}It.default=mo});var Mr=y(Dt=>{"use strict";Object.defineProperty(Dt,"__esModule",{value:!0});Dt.default=(e=100)=>new Promise(t=>{setTimeout(()=>t(),e)})});var Tr=y(qt=>{"use strict";Object.defineProperty(qt,"__esModule",{value:!0});var zt=(e,t)=>{let r=typeof e,n=typeof t;if(e===t)return!0;if(r!==n||e===null||t===null)return!1;if(r!=="object"){if(r==="function"){if(e.toString()!==t.toString())return!1}else if(e!==t)return!1}else{if(Array.isArray(e))if(Array.isArray(t)){let s=e.length;if(s!==t.length)return!1;for(let a=0;a<s;a++){let i=typeof e[a];if(typeof t[a]!==i)return!1;if(i==="object"&&!zt(e[a],t[a]))return!1}}else return!1;if(e.checksum||t.checksum)return e.checksum===t.checksum;let o=0;for(let s in e){if(s[0]==="_"||!e.hasOwnProperty(s))continue;if(!t.hasOwnProperty(s))return!1;let a=t[s],i=e[s];if(a===void 0&&i!==void 0)return!1;let f=typeof a;if(f!==typeof i)return!1;if(a&&f==="object"){if(!zt(i,a))return!1}else if(a!==i)return!1;o++}for(let s in t)if(o--,o<0)return!1}return!0};qt.default=zt});var Ir=y(Ct=>{"use strict";Object.defineProperty(Ct,"__esModule",{value:!0});Ct.default=e=>(e=e.replace(/[@-\\/|*&^%$#@!()\-+]/g,"_"),e=e.replace(/^_+/,""),e=e.replace(/_+$/,""),e.toUpperCase())});var Dr=y(()=>{});var zr=y(Et=>{"use strict";Object.defineProperty(Et,"__esModule",{value:!0});var bo=Dr();Et.default=e=>new Promise((t,r)=>{let n=new bo.PassThrough;n.on("error",s=>{r(s)});let o=[];n.on("data",s=>{typeof s=="string"?o.push(Buffer.from(s)):o.push(s)}),n.on("end",s=>{t(Buffer.concat(o))}),e.pipe(n)})});var ye=y(Qt=>{"use strict";Object.defineProperty(Qt,"__esModule",{value:!0});var wo=(e,t=5381)=>{let r=e.length;for(;r;){let n=e.charCodeAt(--r);t=t*33^n}return t};Qt.default=wo});var kt=y(Ce=>{"use strict";var So=Ce&&Ce.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Ce,"__esModule",{value:!0});var O=So(ye()),Ft=(e,t=5381,r=52711)=>{if(Array.isArray(e))for(let n=0;n<e.length;n++){let o=e[n],s=typeof o;if(s==="string"){let a=n+":"+o;t=O.default(a,t),r=O.default(a,r)}else if(s==="number"){let a=n+"n:"+o;t=O.default(a,t),r=O.default(a,r)}else if(s==="object")if(o===null){let a=n+"v:null";t=O.default(a,t),r=O.default(a,r)}else{let a=Ft(o,t,r);t=O.default(n+"o:",a[0]),r=O.default(n+"o:",a[1])}else if(s==="boolean"){let a=n+"b:"+(o?"true":"false");t=O.default(a,t),r=O.default(a,r)}}else for(let n in e){let o=e[n],s=typeof o;if(s==="string"){let a=n+":"+o;t=O.default(a,t),r=O.default(a,r)}else if(s==="number"){let a=n+"n:"+o;t=O.default(a,t),r=O.default(a,r)}else if(s==="object")if(o===null){let a=n+"v:null";t=O.default(a,t),r=O.default(a,r)}else{let a=Ft(o,t,r);t=O.default(n+"o:",a[0]),r=O.default(n+"o:",a[1])}else if(s==="boolean"){let a=n+"b:"+(o?"true":"false");t=O.default(a,t),r=O.default(a,r)}}return[t,r]};Ce.default=Ft});var tt=y(Ee=>{"use strict";var xo=Ee&&Ee.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Ee,"__esModule",{value:!0});var _o=xo(kt()),Oo=e=>{let t=_o.default(e);return(t[0]>>>0)*4096+t[1]};Ee.default=Oo});var Lt=y(Fe=>{"use strict";var qr=Fe&&Fe.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Fe,"__esModule",{value:!0});var jo=qr(tt()),Qe=qr(ye()),Po=(e,t)=>{let r;if(typeof e=="object"?e===null?r=0:r=jo.default(e):typeof e=="boolean"?r=(Qe.default(e?":true":":false")>>>0)*4096:typeof e=="number"?r=(Qe.default("n:"+e)>>>0)*4096+(Qe.default("n:"+e,52711)>>>0):r=(Qe.default(e)>>>0)*4096+(Qe.default(e,52711)>>>0),t){let n=Math.ceil(Math.log10(r+1));if(n<t)return r*Math.pow(10,t-n)}return r};Fe.default=Po});var Fr=y(ke=>{"use strict";var Ut=ke&&ke.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ke,"__esModule",{value:!0});var Cr=Ut(Lt()),Rt=Ut(ye()),Ao=Ut(tt()),Er=he(),Mo="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Qr=e=>{let t="",r;do r=e%62,t=Mo.charAt(r)+t,e=Math.floor(e/62);while(e>0);return t},To=(e,t,r)=>{let n;if(typeof e=="object")if(e===null)n=0;else if(t&&t>9&&e.constructor===Array){let a="",i=e.length;for(let u=0;u<i;u++)a+=Qr(r&&e[u]&&typeof e[u]=="object"?Er.hashObjectIgnoreKeyOrder(e[u]):Cr.default(e[u]));let f=a.length;if(f<t)a+="x",f+1<t&&(a+=new Array(t-f).join("0"));else if(f>t)return a.slice(0,t);return a}else n=(r?Er.hashObjectIgnoreKeyOrder(e):Ao.default(e))>>>0;else typeof e=="boolean"?n=Rt.default(e?":true":":false")*4096:typeof e=="number"?n=(Rt.default("n:"+e)>>>0)*4096:n=Rt.default(e)>>>0;let o=Qr(n),s=o.length;return s<t&&(o+="x",s+1<t&&(o+=new Array(t-s).join("0"))),o};ke.default=To});var $t=y(Le=>{"use strict";var Io=Le&&Le.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Le,"__esModule",{value:!0});var S=Io(ye()),Nt=(e,t=5381,r=52711)=>{if(Array.isArray(e)){let n="__len:"+e.length+1;t=S.default(n,t),r=S.default(n,r);for(let o=0;o<e.length;o++){let s=e[o],a=typeof s;if(a==="string"){let i=o+":"+s;t=S.default(i,t),r=S.default(i,r)}else if(a==="number"){let i=o+"n:"+s;t=S.default(i,t),r=S.default(i,r)}else if(a==="object")if(s===null){let i=o+"v:null";t=S.default(i,t),r=S.default(i,r)}else{let i=Nt(s,t,r),f=o+"o:";t=S.default(f,i[0]),r=S.default(f,i[1])}else if(a==="boolean"){let i=o+"b:"+(s?"true":"false");t=S.default(i,t),r=S.default(i,r)}}}else{let n=Object.keys(e).sort(),o="__len:"+n.length+1;t=S.default(o,t),r=S.default(o,r);for(let s=0;s<n.length;s++){let a=n[s],i=e[a],f=typeof i;if(f==="string"){let u=a+":"+i;t=S.default(u,t),r=S.default(u,r)}else if(f==="number"){let u=a+"n:"+i;t=S.default(u,t),r=S.default(u,r)}else if(f==="object")if(i===null){let u=a+"v:null";t=S.default(u,t),r=S.default(u,r)}else{let u=Nt(i,t,r),l=a+"o:";t=S.default(l,u[0]),r=S.default(l,u[1])}else if(f==="boolean"){let u=a+"b:"+(i?"true":"false");t=S.default(u,t),r=S.default(u,r)}}}return[t,r]};Le.default=Nt});var kr=y(Re=>{"use strict";var Do=Re&&Re.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Re,"__esModule",{value:!0});var zo=Do($t()),qo=e=>{let t=zo.default(e);return(t[0]>>>0)*4096+(t[1]>>>0)};Re.default=qo});var he=y(J=>{"use strict";var pe=J&&J.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(J,"__esModule",{value:!0});var Co=pe(Lt());J.hash=Co.default;var Eo=pe(Fr());J.hashCompact=Eo.default;var Qo=pe(tt());J.hashObject=Qo.default;var Fo=pe(kr());J.hashObjectIgnoreKeyOrder=Fo.default;var ko=pe($t());J.hashObjectIgnoreKeyOrderNest=ko.default;var Lo=pe(kt());J.hashObjectNest=Lo.default;var Ro=pe(ye());J.stringHash=Ro.default});var Rr=y((Li,Lr)=>{"use strict";Lr.exports=e=>{if(Object.prototype.toString.call(e)!=="[object Object]")return!1;let t=Object.getPrototypeOf(e);return t===null||t===Object.prototype}});var Ur=y(Ue=>{"use strict";var Uo=Ue&&Ue.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Ue,"__esModule",{value:!0});var Ht=he(),No=Uo(Rr());function $o(e,t){let r=0,n=(...o)=>new Promise((s,a)=>{e(...o).then(i=>s(i)).catch(i=>{var f,u;r++,t.logError&&t.logError(i,o,r),!t.max||r<t.max?setTimeout(()=>{s(n(...o))},Math.min(r*((f=t.minTime)!==null&&f!==void 0?f:1e3),(u=t.maxTime)!==null&&u!==void 0?u:1/0)):a(i)})});return n}var Ho=(...e)=>{let t="";for(let r of e)r!==void 0&&(typeof r=="object"?(Array.isArray(r)||(0,No.default)(r))&&(t+=(0,Ht.hashObjectIgnoreKeyOrder)(r)):t+=(0,Ht.hash)(r));return t||(~~(Math.random()*99999)).toString(16)};function Ko(e,t={}){t.retry&&(e=$o(e,t.retry)),t.dedup||(t.dedup=Ho),t.concurrency||(t.concurrency=1);let r={},n=new Set,o=()=>{for(let s in r){if(n.size===t.concurrency)break;if(!n.has(s)){let a=r[s];if(n.add(s),e(...a.args).then(i=>{delete r[s],n.delete(s),a.listeners.forEach(([f])=>{f(i)}),o()}).catch(i=>{delete r[s],n.delete(s),a.listeners.forEach(([,f])=>{f(i)}),o()}),n.size===t.concurrency)break}}};return(...s)=>new Promise((a,i)=>{let f=t.dedup(...s);r[f]?r[f].listeners.push([a,i]):r[f]={args:s,listeners:[[a,i]]},n.size<t.concurrency&&o()})}Ue.default=Ko});var $r=y(Kt=>{"use strict";Object.defineProperty(Kt,"__esModule",{value:!0});function Nr(e,t,...r){return new Promise((n,o)=>{let{timeout:s=100,maxRetries:a=-1}=t,i=0;e(...r).then(f=>n(f)).catch(f=>{++i<=a||a<0?setTimeout(()=>{n(Nr(e,{timeout:s,maxRetries:a-1},...r))},s):o(f)})})}Kt.default=Nr});var Hr=y(Jt=>{"use strict";Object.defineProperty(Jt,"__esModule",{value:!0});function Jo(e,t){let r=t&&t.noSpecials||!1,n=t&&t.noLowerCase||!1,o=t&&t.noUpperCase||!1,s=t&&t.noNumbers||!1,a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i="abcdefghijklmnopqrstuvwxyz",f="0123456789",u="!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~",l="";r||(l+=u),n||(l+=i),o||(l+=a),s||(l+=f);let c="",p=l.length;for(let h=0;h<e;h++)c+=l.charAt(Math.floor(Math.random()*p));return c}Jt.default=Jo});var Zt=y(me=>{"use strict";Object.defineProperty(me,"__esModule",{value:!0});me.padRight=me.padLeft=void 0;var Zo=(e,t,r)=>{let n=e.length;for(let o=0;o<t-n;o++)e=r+e;return e};me.padLeft=Zo;var Wo=(e,t,r)=>{let n=e.length;for(let o=0;o<t-n;o++)e=e+r;return e};me.padRight=Wo});var Kr=y(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.createDecode=void 0;var Go=(e,t,r=["$"],n)=>{if(r.length>1&&e)return s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];if(r.includes(f)){let u="";for(let c=0;c<t;c++)u+=s[i+c+1];a+=n[u],i+=t}else a+=f}return a};if(r.length>1)return s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];r.includes(f)?(a+=n[s[i+1]],i++):a+=f}return a};let o=r[0];return e?s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];if(f===o){let u="";for(let c=0;c<t;c++)u+=s[i+c+1];a+=n[u],i+=t}else a+=f}return a}:s=>{let a="";for(let i=0;i<s.length;i++){let f=s[i];f===o?(a+=n[s[i+1]],i++):a+=f}return a}};rt.createDecode=Go});var Zr=y(nt=>{"use strict";Object.defineProperty(nt,"__esModule",{value:!0});nt.createEncode=void 0;var Jr=(e,t)=>t%2?e[e.length-t]:e[t],Bo=(e,t,r)=>{if(r.length>1&&e===1){let n=r.length;return o=>{let s=0,a="";for(let i=0;i<o.length;i++){let f=o.charAt(i);t[f]?(s+=1,s>=n&&(s=0),a+=Jr(r,s)+t[f]):a+=f}return a}}if(r.length>1){let n=r.length;return o=>{let s=0,a="";for(let i=0;i<o.length;i++){let f=!1;for(let u=e-1;u>-1;u--){if(i+u>o.length-1)continue;let l="";for(let c=0;c<u+1;c++)l+=o.charAt(i+c);t[l]&&(s+=1,s>=n&&(s=0),a+=Jr(r,s)+t[l],i+=l.length-1,u=-1,f=!0)}f||(a+=o.charAt(i))}return a}}return e===1?n=>{let o="";for(let s=0;s<n.length;s++){let a=n.charAt(s);t[a]?o+=t[a]:o+=a}return o}:n=>{let o="";for(let s=0;s<n.length;s++){let a=!1;for(let i=e-1;i>-1;i--){if(s+i>n.length-1)continue;let f="";for(let u=0;u<i+1;u++)f+=n.charAt(s+u);t[f]&&(o+=t[f],s+=f.length-1,i=-1,a=!0)}a||(o+=n.charAt(s))}return o}};nt.createEncode=Bo});var Wr=y(ot=>{"use strict";Object.defineProperty(ot,"__esModule",{value:!0});ot.createEncoder=void 0;var Vo=Kr(),Xo=Zr(),Yo=Zt(),es=(e,t=["$"])=>{let r=1,n=e.length>36,o=[...e,...t],s=o.map((u,l)=>(u.length>r&&(r=u.length),l>25?String(l-26):String.fromCharCode(97+l))),a={},i={};for(let u=0;u<o.length;u++)a[o[u]]=t.length===1?t[0]+s[u]:s[u],i[s[u]]=o[u];let f=1;if(n){for(let u in i)u.length>f&&(f=u.length);for(let u in i)if(u.length<f){let l=(0,Yo.padLeft)(u,f,"0"),c=i[u];t.length>1?a[c]=l:a[c]=t[0]+l,delete i[u],i[l]=c}}return{charMap:a,reverseCharMap:i,encode:(0,Xo.createEncode)(r,a,t),decode:(0,Vo.createDecode)(n,f,t,i)}};ot.createEncoder=es});var Gr=y(be=>{"use strict";Object.defineProperty(be,"__esModule",{value:!0});be.deepMerge=be.deepMergeArrays=void 0;var st=(e,t)=>{if(t.constructor===Array)for(let r=0;r<t.length;r++)r in e&&e[r]&&typeof e[r]=="object"&&t[r]&&typeof t[r]=="object"?st(e[r],t[r]):e[r]=t[r];else for(let r in t)r in e&&e[r]&&typeof e[r]=="object"&&t[r]&&typeof t[r]=="object"?st(e[r],t[r]):e[r]=t[r]};function ts(e,...t){if(!t.length)return e;if(t.length===1){let r=t[0];if(e&&typeof e=="object"&&r&&typeof r=="object")return st(e,r),e}for(let r=0;r<t.length;r++){let n=t[r];if(e&&typeof e=="object"&&n&&typeof n=="object")return st(e,n),e}return e}be.deepMergeArrays=ts;var Wt=(e,t)=>{if(t.constructor===Array||e.constructor===Array)return t;for(let r in t)if(r in e)if(e[r]&&t[r]&&typeof e[r]=="object"&&e[r].constructor!==Array&&typeof t[r]=="object"&&t[r].constructor!==Array){let n=Wt(e[r],t[r]);n!==e[r]&&(e[r]=n)}else e[r]=t[r];else e[r]=t[r];return e};function rs(e,...t){if(!t.length)return e;if(t.length===1){let r=t[0];if(e&&typeof e=="object"&&r&&typeof r=="object")return Wt(e,r)}for(let r=0;r<t.length;r++){let n=t[r];if(e&&typeof e=="object"&&n&&typeof n=="object"){let o=Wt(e,n);o!==e&&(e=o)}}return e}be.deepMerge=rs});var Br=y(Ne=>{"use strict";Object.defineProperty(Ne,"__esModule",{value:!0});Ne.walk=void 0;var we=re(),ns=async e=>(0,we.getType)(e.ref)!=="object",os=async(e,t)=>Object.keys(e).map(r=>({name:r,ref:e[r],path:[t,r].filter(Boolean).join("/"),type:(0,we.getType)(e[r])})),ss=async e=>(0,we.getType)(e.ref)==="object",is=async e=>(0,we.getType)(e)==="object",as=async(e,t,r)=>{if(r={listFn:os,itemMatchFn:ns,recurseFn:ss,targetValidationFn:is,...r},(0,we.getType)(r.targetValidationFn)==="function"&&!await r.targetValidationFn(e))return;["listFn","itemMatchFn","recurseFn"].forEach(o=>{if((0,we.getType)(r[o])!=="function")throw new Error(o+" should be a function")});let n=await r.listFn(e,r.previousPath);await Promise.all(n.map(async o=>{let{name:s,path:a,type:i}=o;await r.itemMatchFn(o)&&await t(o.ref,{name:s,path:a,type:i}),await r.recurseFn(o)&&await(0,Ne.walk)(o.ref,t,{...r,previousPath:o.path})}))};Ne.walk=as});var Vr=y(it=>{"use strict";Object.defineProperty(it,"__esModule",{value:!0});it.getType=void 0;var fs=e=>e===null?"null":Array.isArray(e)?"array":typeof e;it.getType=fs});var Xr=y(fe=>{"use strict";Object.defineProperty(fe,"__esModule",{value:!0});fe.serializeQuery=fe.parseQuery=void 0;var Gt=e=>{if(e.includes(",")){e=e.split(",");for(let t=0;t<e.length;t++)e[t]=Gt(e[t]);return e}return e==="null"?null:e==="true"||e===""?!0:e==="false"?!1:isNaN(e)?e:Number(e)},us=e=>{if(e)try{let t={},r="",n="",o=!1,s=0,a=e.length;for(let i=0;i<a;i++){let f=e[i];if(f==="&"&&(!s||s===1&&e[i-1]==="}"||s===2&&e[i-1]==="]")){if(!o)t[r]=!0;else if(s)try{t[r]=JSON.parse(n)}catch{t[r]=n}else t[r]=Gt(n);s=0,o=!1,r="",n=""}else f==="="&&!s?o=!0:o?(n===""&&(f==="{"?s=1:f==="["&&(s=2)),n+=f):r+=f}if(r)if(s)try{t[r]=JSON.parse(n)}catch{t[r]=n}else t[r]=Gt(n);return t}catch{}};fe.parseQuery=us;var ls=e=>{let t=[];for(let r in e){let n=e[r];n===!0?t.push(`${r}`):t.push(`${r}=${(0,fe.serializeQuery)(n,!0)}`)}return t.join("&")},cs=(e,t=!1)=>typeof e=="string"?e:typeof e=="boolean"?e?"true":"false":typeof e=="number"||typeof e=="number"?String(e):e===null?"null":Array.isArray(e)?e.map(r=>typeof r=="object"&&r!==null?JSON.stringify(r):(0,fe.serializeQuery)(r,!0)).join(","):typeof e=="object"?t?JSON.stringify(e):ls(e):"";fe.serializeQuery=cs});var Yr=y(Se=>{"use strict";Object.defineProperty(Se,"__esModule",{value:!0});Se.encodeBase64=Se.decodeBase64=void 0;var hs=e=>e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0,at=e=>e<26?e+65:e<52?e+71:e<62?e-4:e===62?43:e===63?47:65,ps=(e,t)=>{let r=e.replace(/[^A-Za-z0-9+/]/g,""),n=r.length,o=t?Math.ceil((n*3+1>>2)/t)*t:n*3+1>>2,s=new Uint8Array(o),a,i,f=0,u=0;for(let l=0;l<n;l++)if(i=l&3,f|=hs(r.charCodeAt(l))<<6*(3-i),i===3||n-l===1){for(a=0;a<3&&u<o;)s[u]=f>>>(16>>>a&24)&255,a++,u++;f=0}return s};Se.decodeBase64=ps;var ds=e=>{let t=2,r="",n=e.length,o=0;for(let s=0;s<n;s++)t=s%3,o|=e[s]<<(16>>>t&24),(t===2||e.length-s===1)&&(r+=String.fromCodePoint(at(o>>>18&63),at(o>>>12&63),at(o>>>6&63),at(o&63)),o=0);return r.substring(0,r.length-2+t)+(t===2?"":t===1?"=":"==")};Se.encodeBase64=ds});var en=y(xe=>{"use strict";Object.defineProperty(xe,"__esModule",{value:!0});xe.stringToUtf8=xe.uft8ToString=void 0;var vs=e=>{let t="",r,n=e.length;for(let o=0;o<n;o++)r=e[o],t+=String.fromCodePoint(r>251&&r<254&&o+5<n?(r-252)*1073741824+(e[++o]-128<<24)+(e[++o]-128<<18)+(e[++o]-128<<12)+(e[++o]-128<<6)+e[++o]-128:r>247&&r<252&&o+4<n?(r-248<<24)+(e[++o]-128<<18)+(e[++o]-128<<12)+(e[++o]-128<<6)+e[++o]-128:r>239&&r<248&&o+3<n?(r-240<<18)+(e[++o]-128<<12)+(e[++o]-128<<6)+e[++o]-128:r>223&&r<240&&o+2<n?(r-224<<12)+(e[++o]-128<<6)+e[++o]-128:r>191&&r<224&&o+1<n?(r-192<<6)+e[++o]-128:r);return t};xe.uft8ToString=vs;var gs=e=>{let t,r=e.length,n=0;for(let i=0;i<r;i++)t=e.codePointAt(i),t>=65536&&i++,n+=t<128?1:t<2048?2:t<65536?3:t<2097152?4:t<67108864?5:6;let o=new Uint8Array(n),s=0,a=0;for(;s<n;)t=e.codePointAt(a),t<128?o[s++]=t:t<2048?(o[s++]=192+(t>>>6),o[s++]=128+(t&63)):t<65536?(o[s++]=224+(t>>>12),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63)):t<2097152?(o[s++]=240+(t>>>18),o[s++]=128+(t>>>12&63),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63),a++):t<67108864?(o[s++]=248+(t>>>24),o[s++]=128+(t>>>18&63),o[s++]=128+(t>>>12&63),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63),a++):(o[s++]=252+(t>>>30),o[s++]=128+(t>>>24&63),o[s++]=128+(t>>>18&63),o[s++]=128+(t>>>12&63),o[s++]=128+(t>>>6&63),o[s++]=128+(t&63),a++),a++;return o};xe.stringToUtf8=gs});var tn=y(_e=>{"use strict";Object.defineProperty(_e,"__esModule",{value:!0});_e.getByPath=_e.setByPath=void 0;function ys(e,t,r){if(typeof e!="object")return e;let n=e;for(let o=0;o<t.length;o++){let s=t[o];if(o===t.length-1){n[s]=r;break}n[s]===void 0&&(typeof t[o+1]=="number"?n[s]=[]:n[s]={}),n=n[s]}return e}_e.setByPath=ys;var ms=(e,t)=>{if(typeof e!="object")return;let r=e;for(let n=0;n<t.length;n++){let o=t[n];if(r?.[o]!==void 0)r=r[o];else{r=void 0;break}}return r};_e.getByPath=ms});var re=y(m=>{"use strict";var bs=m&&m.__createBinding||(Object.create?function(e,t,r,n){n===void 0&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);(!o||("get"in o?!t.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){n===void 0&&(n=r),e[n]=t[r]}),ne=m&&m.__exportStar||function(e,t){for(var r in e)r!=="default"&&!Object.prototype.hasOwnProperty.call(t,r)&&bs(t,e,r)},oe=m&&m.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(m,"__esModule",{value:!0});m.randomString=m.retry=m.toEnvVar=m.deepEqual=m.wait=m.isObject=m.readStream=m.queued=m.deepCopy=void 0;var ws=oe(Pr());m.deepCopy=ws.default;var Ss=oe(Ar());m.isObject=Ss.default;var xs=oe(Mr());m.wait=xs.default;var _s=oe(Tr());m.deepEqual=_s.default;var Os=oe(Ir());m.toEnvVar=Os.default;var js=oe(zr());m.readStream=js.default;var Ps=oe(Ur());m.queued=Ps.default;var As=oe($r());m.retry=As.default;var Ms=oe(Hr());m.randomString=Ms.default;ne(Zt(),m);ne(Wr(),m);ne(Gr(),m);ne(Br(),m);ne(Vr(),m);ne(Xr(),m);ne(Yr(),m);ne(en(),m);ne(tn(),m)});var on=y((ra,nn)=>{nn.exports=fetch});var dn=y((na,pn)=>{var Is=Object.create,ft=Object.defineProperty,Ds=Object.getOwnPropertyDescriptor,zs=Object.getOwnPropertyNames,qs=Object.getPrototypeOf,Cs=Object.prototype.hasOwnProperty,Es=(e,t)=>{for(var r in t)ft(e,r,{get:t[r],enumerable:!0})},an=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of zs(t))!Cs.call(e,o)&&o!==r&&ft(e,o,{get:()=>t[o],enumerable:!(n=Ds(t,o))||n.enumerable});return e},Qs=(e,t,r)=>(r=e!=null?Is(qs(e)):{},an(t||!e||!e.__esModule?ft(r,"default",{value:e,enumerable:!0}):r,e)),Fs=e=>an(ft({},"__esModule",{value:!0}),e),fn={};Es(fn,{default:()=>Js,genCache:()=>cn,getServicePort:()=>un});pn.exports=Fs(fn);var ks=Qs(on()),Vt=re(),Ls=e=>{let t=5381,r=e.length;for(;r;)t=t*33^e.charCodeAt(--r);let n=t>>>0;for(;n>65535;)n=n/10;return Math.round(n)},un=(e,t,r,n,o="allServices",s=0)=>Ls(`${o}-${e}-${t}-${r}-${n}-${s}`),Rs=he(),ln=e=>e||"@based/env-hub",Us={"@based/env-hub":0,"@based/env-admin-hub":1,"@based/admin-hub":2,"@based/machine-hub":3},cn=e=>{let t=Us[ln(e.name)],r=Math.floor(Math.random()*1e4),n=t+""+r;return e.key?n+"/"+(e.optionalKey?e.key+"$":e.key):n},Ns=async(e,t,r)=>{try{let n=await(0,ks.default)(`${e}/status/${cn(t)}`,{headers:t.headers});if(n.ok){let o=n.headers.get("x-request-id");if(!o)return 1;let{decode:s}=(0,Vt.createEncoder)(Hs,o.slice(0,6).split("")),a=s(o.slice(6)).split(","),i=[];for(let l=0;l<Math.floor(a.length/2);l++)i.push([a[l],encodeURIComponent(a[a.length-1-l])]);let[f,u]=i[~~(Math.random()*i.length)];return r?`${/^https/.test(e)?"https":"http"}://${f}`:`${/^https/.test(e)?"wss":"ws"}://${f}/${u}`}else return!1}catch{return!1}},sn=/^ws/,$s=({cluster:e="production",org:t,project:r,env:n,name:o})=>{if(e==="local")return[`http://localhost:${un(t,r,n,ln(o).includes("env-")?"@based/env-hub-discovery":"@based/hub-discovery","allServices")}`];let s="-status";return[`https://${(0,Rs.hashObjectIgnoreKeyOrder)({org:t,project:r,env:n,cluster:e}).toString(36)}${s}.based.dev`]},hn=async(e,t=!1,r=0)=>{if(e.url){let o;return typeof e.url=="function"?o=await e.url():o=e.url,t&&o&&sn.test(o)?o.replace(sn,"http"):o}let n=e.discoveryUrls||$s(e);for(let o=0;o<n.length;o++){let s=n[o],a=await Promise.race([Ns(s,e,t),(0,Vt.wait)(3e3)]);if(a===1||!a&&o===n.length-1)return await(0,Vt.wait)(Math.min(r*r*50+500,5e3)),hn(e,t,++r);if(a)return a}},Hs=[",",".based.dev","localhost:","localhost","based.io","based.dev","@based","/env-hub","admin","hub","900","90","443","80",":","%","/","=","<","?","."],Ks=hn,Js=async(e,t)=>Ks(e,t)});var Zn=y(dr=>{"use strict";Object.defineProperty(dr,"__esModule",{value:!0});var $n=re(),Hn=(e,t,r)=>{if(r.constructor===Array){let n=r[0];if(n===0)e[t]=r[1];else if(n===1)delete e[t];else if(n===2){let o=Kn(e[t],r[1]);if(o===null)return null;e[t]=o}}else{if(r.___$toObject&&e[t]&&e[t].constructor===Array){let n={};for(let o=0;o<e[t].length;o++)n[o]=e[t][o];e[t]=n}if(e[t]===void 0)return console.warn("Diff apply patch: Cannot find key in original object",t,JSON.stringify(r,null,2)),null;for(let n in r)if(n!=="___$toObject"&&Hn(e[t],n,r[n])===null)return null}},Kn=(e,t)=>{let r=t.length,n=new Array(t[0]),o=-1,s=[],a={};for(let f=1;f<r;f++){let u=t[f],l=u[0];if(l===0)for(let c=1;c<u.length;c++)n[++o]=u[c];else if(l===1){let c=u[2],p=u[1]+c;for(let h=c;h<p;h++){let d=typeof e[h];if(d==="object"&&h in a){let v=$n.deepCopy(e[h]);n[++o]=v}else d==="object"&&(a[h]=!0),n[++o]=e[h]}}else if(l===2){let c=u[1],p=u.length-2+c;for(let h=c;h<p;h++){let d=[++o,h,u[h-c+2]];s.push(d)}}}let i=s.length;for(let f=0;f<i;f++){let[u,l,c]=s[f],p=l in a?$n.deepCopy(e[l]):e[l],h=Jn(p,c);if(h===null)return null;n[u]=h}return n},Jn=(e,t)=>{if(t)if(t.constructor===Array){let r=t[0];if(r===0)return t[1];if(r===1)return;if(r===2)return Kn(e,t[1])}else{if(t.___$toObject&&e&&e.constructor===Array){let r={};for(let n=0;n<e.length;n++)r[n]=e[n];e=r}for(let r in t)if(r!=="___$toObject"&&Hn(e,r,t[r])===null)return null;return e}else return e};dr.default=Jn});var Gn=y(De=>{"use strict";var ui=De&&De.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(De,"__esModule",{value:!0});De.execCreatePartialDiff=void 0;var Wn=re(),li=ui(vr()),ci=(e,t,r)=>{let n=e(t);if(n!==!1)if(n.type==="array"){let o=[];if(!Array.isArray(t))return o[0]=0,console.log("no current value do something..."),o;o[0]=2;let s=[t.length];o[1]=s,n.values.sort((c,p)=>c.index<p.index?-1:c.index===p.index?0:1);let a=0,i,f=0,u=0,l=!0;for(let c of n.values){let p=c.type,h=c.index;if(f){if(h+f>a+1){let d=h-a-1;d>0&&(u+=d,s.push([1,h-a-1,a+1]))}}else if(i?h>a:h>a+1)if(i)if(p==="insert"){let d=h-a-1;s[0]++,d>0&&(u+=d,s.push([1,d,a+1]))}else{let d=h-a;d>0&&(u+=d,s.push([1,d,a+1]))}else{let d=h-a;d>0&&(u+=d,s.push([1,d,a]))}if(p==="delete")s[0]--,i=!0,l=!1,f&&s.length>1&&s[s.length-1][0]===1&&s[s.length-1][2]--,f=0;else{if(p==="update"||p==="merge"){l=!0;let d=!1,v=c.value;if(p==="merge"){let x=c.fromIndex||h;if(!(!t[x]||typeof t[x]!="object")){let _=Wn.deepMerge(Wn.deepCopy(t[x]),v);v=[2,x,li.default(t[x],_)],d=!0}}let w=s[s.length-1];!d&&s.length>1&&w[0]===0?(w.push(v),u++,h++):(a===0&&h===1&&!i&&(s.push([1,1,0]),u++),u++,d?s.push(v):s.push([0,v]),h++)}else if(p==="insert"){l=!1;let d=s.length,v;d>1&&(v=s[d-1]),d>1&&v[0]===0?c.values?(f=c.values.length,s[0]+=c.values.length,v.push(...c.values)):(s[0]++,f=1,v.push(c.value)):c.values?(f=c.values.length,s[0]+=c.values.length,s.push([0].concat(c.values))):(s[0]++,f=1,s.push([0,c.value])),u+=f}i=!1}a=h}if(u<s[0]){let c=s[0]-u;i||l?c>0&&s.push([1,c,a+1]):c>0&&s.push([1,c,a])}return o}else{if(n.type==="update")return[0,n.value];if(n.type==="delete")return[1]}};De.execCreatePartialDiff=ci});var eo=y(W=>{"use strict";Object.defineProperty(W,"__esModule",{value:!0});W.createPatch=W.arrayDiff=void 0;var hi=he(),Vn=Gn(),Bn=e=>e===null?"___isNull$":e===!1?"___isFalse$":e===!0?"___isTrue$":typeof e=="object"&&e!==null?"___obj"+hi.hashObject(e):e,pi=(e,t,r)=>{let n=e.length,o=t.length,s={},a=new Array(n);for(let l=0;l<n;l++){let c=Bn(e[l]);s[c]||(s[c]=[]),s[c].push(l),a[l]=c}let i=[],f=0;i[0]=o;for(let l=0;l<o;l++){let c=a[l],p=Bn(t[l]),h=i[f],d=i[f]&&i[f][0];if(c===p){let v=!1;if(d===1){let w=h[2];for(let x=0;x<w.length;x++){let _=w[x];if(_+h[1]===l){v=_;break}}}v!==!1?(h[1]++,h[2]=[v]):v===!1&&(d===1&&(h[2]=h[2][0]),f++,i[f]=[1,1,[l]])}else if(s[p]){let v=!1;if(d===1)for(let w=0;w<s[p].length;w++){let x=s[p][w],_=h[2],L=!1;for(let q=0;q<_.length;q++){let T=_[q];if(T+h[1]===x){v=T,L=!0;break}}if(L)break}v!==!1?(h[1]++,h[2]=[v]):v===!1&&(d===1&&(h[2]=h[2][0]),f++,i[f]=[1,1,s[p]])}else if(d===1&&(h[2]=h[2][0]),typeof e[l]=="object"&&typeof t[l]=="object"){let v=W.createPatch(e[l],t[l],r);d===2?h.push(v):(f++,i[f]=[2,l,v])}else d===0?h.push(t[l]):(f++,i[f]=[0,t[l]])}let u=i[i.length-1];if(u[0]===1&&(u[2]=u[2][0]),!(i.length===2&&i[1][0]===1&&i[1][1]===i[0]&&i[1][2]===0&&i[0]===n))return i};W.arrayDiff=pi;var Xn=(e,t,r,n,o)=>{let s=typeof t;if(s==="function"&&o&&o.parseDiffFunctions){let a=Vn.execCreatePartialDiff(t,e,o);a&&(r[n]=a)}else if(s!==typeof e)r[n]=[0,t];else if(s==="object")if(t===null)r[n]=[0,null];else{let a;if(t.constructor===Array)if(t.length===0)e&&e.constructor===Array&&e.length===0||(a=[0,[]],r[n]=a);else if(e&&e.constructor===Array){let i=W.arrayDiff(e,t,o);i&&i.length>1&&(a=[2,i],r[n]=a)}else{let i=W.arrayDiff(e,t,o);i&&i.length>1&&(a=[0,i],r[n]=a)}else{a={},e&&e.constructor===Array&&e.length&&(a.___$toObject=!0);for(let i in t)i in e?Xn(e[i],t[i],a,i,o):a[i]=[0,t[i]];for(let i in e)i in t||(a[i]=[1]);for(let i in a){r[n]=a;break}}}else e===t||(r[n]=[0,t])},Yn=(e,t,r)=>{let n=e[t];if(n){let o=typeof n;if(o==="function"){let s=Vn.execCreatePartialDiff(e[t],void 0,r);console.log(s),s?e[t]=s[1]:delete e[t]}else if(o==="object")for(let s in n)Yn(n,s,r)}},di=(e,t,r)=>{let n=typeof t;if(n!==typeof e)return[0,t];if(n==="object"){if(t===null)return[0,null];if(t.constructor===Array){if(t.length===0)return e.constructor===Array&&e.length===0?void 0:[0,t];if(e.constructor===Array){let o=W.arrayDiff(e,t,r);if(o&&o.length>1)return[2,W.arrayDiff(e,t,r)]}else return[0,t]}else{let o={};e.constructor===Array&&(o.___$toObject=!0);for(let s in t)s in e?Xn(e[s],t[s],o,s,r):(r&&r.parseDiffFunctions&&Yn(t,s,r),o[s]=[0,t[s]]);for(let s in e)s in t||(o[s]=[1]);for(let s in o)return o}}else if(e!==t)return[0,t]};W.createPatch=di});var vr=y(G=>{"use strict";var vi=G&&G.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(G,"__esModule",{value:!0});G.createPatch=G.applyPatch=G.arrayDiff=void 0;var gi=vi(Zn());G.applyPatch=gi.default;var gr=eo();Object.defineProperty(G,"createPatch",{enumerable:!0,get:function(){return gr.createPatch}});Object.defineProperty(G,"arrayDiff",{enumerable:!0,get:function(){return gr.arrayDiff}});G.default=gr.createPatch});var Or=(e,t)=>{typeof e=="function"?e().then(r=>{t(r)}):t(e)};var rn=ae(re(),1);var{encode:Ts}=(0,rn.createEncoder)(["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," "],["0"]),Bt=e=>encodeURI(Ts(global.btoa(String.fromCodePoint(...new TextEncoder().encode(JSON.stringify(e))))));var Oe;(function(e){e[e.FunctionError=50001]="FunctionError",e[e.AuthorizeFunctionError=50002]="AuthorizeFunctionError",e[e.NoOservableCacheAvailable=50003]="NoOservableCacheAvailable",e[e.ObservableFunctionError=50004]="ObservableFunctionError",e[e.ObserveCallbackError=50005]="ObserveCallbackError",e[e.FunctionNotFound=40401]="FunctionNotFound",e[e.FunctionIsNotObservable=40402]="FunctionIsNotObservable",e[e.FunctionIsObservable=40403]="FunctionIsObservable",e[e.FunctionIsStream=40404]="FunctionIsStream",e[e.CannotStreamToObservableFunction=40405]="CannotStreamToObservableFunction",e[e.AuthorizeRejectedError=40301]="AuthorizeRejectedError",e[e.InvalidPayload=40001]="InvalidPayload",e[e.PayloadTooLarge=40002]="PayloadTooLarge",e[e.ChunkTooLarge=40003]="ChunkTooLarge",e[e.UnsupportedContentEncoding=40004]="UnsupportedContentEncoding",e[e.NoBinaryProtocol=40005]="NoBinaryProtocol",e[e.LengthRequired=41101]="LengthRequired",e[e.MethodNotAllowed=40501]="MethodNotAllowed",e[e.RateLimit=40029]="RateLimit",e[e.MissingAuthStateProtocolHeader=40030]="MissingAuthStateProtocolHeader",e[e.IncorrectAccessKey=40031]="IncorrectAccessKey"})(Oe=Oe||(Oe={}));var ut=class extends Error{statusMessage;code},je=(e,t)=>{if(!e||typeof e!="object"){let a=new ut(`Payload: ${e}`);return a.name="Invalid returned payload",a}let{message:r,code:n}=e,o=r?r[0]==="["?r:`[${Oe[n]}] `+r:n?"Cannot read error msg":JSON.stringify(e,null,2),s=new ut(o);return s.stack=t?o+" "+t:o,s.name=Oe[n],s.code=n,s};var vn={streaming:!1};var Pe=null;typeof WebSocket<"u"?Pe=WebSocket:typeof MozWebSocket<"u"?Pe=MozWebSocket:typeof global<"u"?Pe=global.WebSocket||global.MozWebSocket:typeof window<"u"?Pe=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(Pe=self.WebSocket||self.MozWebSocket);var gn=Pe;var Ae=new Map,lt;typeof document<"u"&&document.addEventListener("visibilitychange",function(){clearTimeout(lt),document.hidden?lt=setTimeout(()=>{Ae.forEach(e=>{e(!1)})},3e4):Ae.forEach(e=>{e(!0)})});var Xt=(e,t,r={destroy:()=>{Ae.delete(r)}},n=0,o=!1)=>(Or(t,s=>{setTimeout(()=>{if(r.disconnected)return;let a=!0;Ae.set(r,u=>{r.disconnected||(!u&&a?e.functionResponseListeners.size||vn.streaming?(console.warn("Send to background - streams or functions in progress try again in 10 seconds..."),clearTimeout(lt),lt=setTimeout(()=>{Ae.forEach(l=>{l(!1)})},1e4)):(console.warn("Send to background - close connection"),a=!1,e.onClose(),i.close()):!a&&u&&(Ae.delete(r),Xt(e,t,r,0,!0)))});let i=r.ws=new gn(s,[Bt(e.authState)]),f=!1;i.binaryType="blob",i.addEventListener("error",u=>{u.message&&u.message.includes("401")&&(f=!0)}),i.addEventListener("message",u=>{e.onData(u)}),i.addEventListener("open",()=>{if(a){if(r.disconnected)return;n=100,o&&e.onReconnect(),e.onOpen()}}),i.addEventListener("close",()=>{if(a){if(r.disconnected)return;e.onClose(),Xt(e,t,r,f?5e3:Math.min(2500,n+~~(Math.random()*500)+100),!0)}})},n)}),r),yn=Xt;var Yt=class{constructor(){Object.defineProperty(this,"listeners",{enumerable:!1,writable:!0})}listeners={};emit(t,r){if(this.listeners[t]){let n=this.listeners[t];for(let o=0,s=n.length;o<n.length;o++){let a=n[o];a(r),s>n.length&&n[o]!==a&&(o--,s=n.length)}}}on(t,r){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(r)}removeAllListeners(){this.listeners={}}once(t,r){if(!r)return new Promise(o=>{let s=a=>{o(a),this.off(t,s)};this.on(t,s)});let n=o=>{r(o),this.off(t,n)};this.on(t,n)}off(t,r){let n=this.listeners[t];if(n)if(!r)delete this.listeners[t];else{for(let o=0;o<n.length;o++)if(n[o]===r){n.splice(o,1),o--;break}n.length===0&&delete this.listeners[t]}}},mn=Yt;var C=Uint8Array,k=Uint16Array,ct=Uint32Array,ht=new C([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),pt=new C([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),nr=new C([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),xn=function(e,t){for(var r=new k(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var o=new ct(r[30]),n=1;n<30;++n)for(var s=r[n];s<r[n+1];++s)o[s]=s-r[n]<<5|n;return[r,o]},_n=xn(ht,2),On=_n[0],or=_n[1];On[28]=258,or[258]=28;var jn=xn(pt,0),Zs=jn[0],bn=jn[1],sr=new k(32768);for(b=0;b<32768;++b)se=(b&43690)>>>1|(b&21845)<<1,se=(se&52428)>>>2|(se&13107)<<2,se=(se&61680)>>>4|(se&3855)<<4,sr[b]=((se&65280)>>>8|(se&255)<<8)>>>1;var se,b,Y=function(e,t,r){for(var n=e.length,o=0,s=new k(t);o<n;++o)e[o]&&++s[e[o]-1];var a=new k(t);for(o=0;o<t;++o)a[o]=a[o-1]+s[o-1]<<1;var i;if(r){i=new k(1<<t);var f=15-t;for(o=0;o<n;++o)if(e[o])for(var u=o<<4|e[o],l=t-e[o],c=a[e[o]-1]++<<l,p=c|(1<<l)-1;c<=p;++c)i[sr[c]>>>f]=u}else for(i=new k(n),o=0;o<n;++o)e[o]&&(i[o]=sr[a[e[o]-1]++]>>>15-e[o]);return i},le=new C(288);for(b=0;b<144;++b)le[b]=8;var b;for(b=144;b<256;++b)le[b]=9;var b;for(b=256;b<280;++b)le[b]=7;var b;for(b=280;b<288;++b)le[b]=8;var b,Ke=new C(32);for(b=0;b<32;++b)Ke[b]=5;var b,Ws=Y(le,9,0),Gs=Y(le,9,1),Bs=Y(Ke,5,0),Vs=Y(Ke,5,1),er=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},Z=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(t&7)&r},tr=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},fr=function(e){return(e+7)/8|0},Pn=function(e,t,r){(t==null||t<0)&&(t=0),(r==null||r>e.length)&&(r=e.length);var n=new(e.BYTES_PER_ELEMENT==2?k:e.BYTES_PER_ELEMENT==4?ct:C)(r-t);return n.set(e.subarray(t,r)),n};var Xs=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ue=function(e,t,r){var n=new Error(t||Xs[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,ue),!r)throw n;return n},Ys=function(e,t,r){var n=e.length;if(!n||r&&r.f&&!r.l)return t||new C(0);var o=!t||r,s=!r||r.i;r||(r={}),t||(t=new C(n*3));var a=function(et){var qe=t.length;if(et>qe){var ge=new C(Math.max(qe*2,et));ge.set(t),t=ge}},i=r.f||0,f=r.p||0,u=r.b||0,l=r.l,c=r.d,p=r.m,h=r.n,d=n*8;do{if(!l){i=Z(e,f,1);var v=Z(e,f+1,3);if(f+=3,v)if(v==1)l=Gs,c=Vs,p=9,h=5;else if(v==2){var L=Z(e,f,31)+257,q=Z(e,f+10,15)+4,T=L+Z(e,f+5,31)+1;f+=14;for(var M=new C(T),j=new C(19),g=0;g<q;++g)j[nr[g]]=Z(e,f+g*3,7);f+=q*3;for(var B=er(j),E=(1<<B)-1,ve=Y(j,B,1),g=0;g<T;){var I=ve[Z(e,f,E)];f+=I&15;var w=I>>>4;if(w<16)M[g++]=w;else{var R=0,D=0;for(w==16?(D=3+Z(e,f,3),f+=2,R=M[g-1]):w==17?(D=3+Z(e,f,7),f+=3):w==18&&(D=11+Z(e,f,127),f+=7);D--;)M[g++]=R}}var Q=M.subarray(0,L),P=M.subarray(L);p=er(Q),h=er(P),l=Y(Q,p,1),c=Y(P,h,1)}else ue(1);else{var w=fr(f)+4,x=e[w-4]|e[w-3]<<8,_=w+x;if(_>n){s&&ue(0);break}o&&a(u+x),t.set(e.subarray(w,_),u),r.b=u+=x,r.p=f=_*8,r.f=i;continue}if(f>d){s&&ue(0);break}}o&&a(u+131072);for(var A=(1<<p)-1,U=(1<<h)-1,$=f;;$=f){var R=l[tr(e,f)&A],V=R>>>4;if(f+=R&15,f>d){s&&ue(0);break}if(R||ue(2),V<256)t[u++]=V;else if(V==256){$=f,l=null;break}else{var N=V-254;if(V>264){var g=V-257,K=ht[g];N=Z(e,f,(1<<K)-1)+On[g],f+=K}var X=c[tr(e,f)&U],F=X>>>4;X||ue(3),f+=X&15;var P=Zs[F];if(F>3){var K=pt[F];P+=tr(e,f)&(1<<K)-1,f+=K}if(f>d){s&&ue(0);break}o&&a(u+131072);for(var z=u+N;u<z;u+=4)t[u]=t[u-P],t[u+1]=t[u+1-P],t[u+2]=t[u+2-P],t[u+3]=t[u+3-P];u=z}}r.l=l,r.p=$,r.b=u,r.f=i,l&&(i=1,r.m=p,r.d=c,r.n=h)}while(!i);return u==t.length?t:Pn(t,0,u)},ie=function(e,t,r){r<<=t&7;var n=t/8|0;e[n]|=r,e[n+1]|=r>>>8},$e=function(e,t,r){r<<=t&7;var n=t/8|0;e[n]|=r,e[n+1]|=r>>>8,e[n+2]|=r>>>16},rr=function(e,t){for(var r=[],n=0;n<e.length;++n)e[n]&&r.push({s:n,f:e[n]});var o=r.length,s=r.slice();if(!o)return[ur,0];if(o==1){var a=new C(r[0].s+1);return a[r[0].s]=1,[a,1]}r.sort(function(T,M){return T.f-M.f}),r.push({s:-1,f:25001});var i=r[0],f=r[1],u=0,l=1,c=2;for(r[0]={s:-1,f:i.f+f.f,l:i,r:f};l!=o-1;)i=r[r[u].f<r[c].f?u++:c++],f=r[u!=l&&r[u].f<r[c].f?u++:c++],r[l++]={s:-1,f:i.f+f.f,l:i,r:f};for(var p=s[0].s,n=1;n<o;++n)s[n].s>p&&(p=s[n].s);var h=new k(p+1),d=ir(r[l-1],h,0);if(d>t){var n=0,v=0,w=d-t,x=1<<w;for(s.sort(function(M,j){return h[j.s]-h[M.s]||M.f-j.f});n<o;++n){var _=s[n].s;if(h[_]>t)v+=x-(1<<d-h[_]),h[_]=t;else break}for(v>>>=w;v>0;){var L=s[n].s;h[L]<t?v-=1<<t-h[L]++-1:++n}for(;n>=0&&v;--n){var q=s[n].s;h[q]==t&&(--h[q],++v)}d=t}return[new C(h),d]},ir=function(e,t,r){return e.s==-1?Math.max(ir(e.l,t,r+1),ir(e.r,t,r+1)):t[e.s]=r},wn=function(e){for(var t=e.length;t&&!e[--t];);for(var r=new k(++t),n=0,o=e[0],s=1,a=function(f){r[n++]=f},i=1;i<=t;++i)if(e[i]==o&&i!=t)++s;else{if(!o&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(o),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(o);s=1,o=e[i]}return[r.subarray(0,n),t]},He=function(e,t){for(var r=0,n=0;n<t.length;++n)r+=e[n]*t[n];return r},ar=function(e,t,r){var n=r.length,o=fr(t+2);e[o]=n&255,e[o+1]=n>>>8,e[o+2]=e[o]^255,e[o+3]=e[o+1]^255;for(var s=0;s<n;++s)e[o+s+4]=r[s];return(o+4+n)*8},Sn=function(e,t,r,n,o,s,a,i,f,u,l){ie(t,l++,r),++o[256];for(var c=rr(o,15),p=c[0],h=c[1],d=rr(s,15),v=d[0],w=d[1],x=wn(p),_=x[0],L=x[1],q=wn(v),T=q[0],M=q[1],j=new k(19),g=0;g<_.length;++g)j[_[g]&31]++;for(var g=0;g<T.length;++g)j[T[g]&31]++;for(var B=rr(j,7),E=B[0],ve=B[1],I=19;I>4&&!E[nr[I-1]];--I);var R=u+5<<3,D=He(o,le)+He(s,Ke)+a,Q=He(o,p)+He(s,v)+a+14+3*I+He(j,E)+(2*j[16]+3*j[17]+7*j[18]);if(R<=D&&R<=Q)return ar(t,l,e.subarray(f,f+u));var P,A,U,$;if(ie(t,l,1+(Q<D)),l+=2,Q<D){P=Y(p,h,0),A=p,U=Y(v,w,0),$=v;var V=Y(E,ve,0);ie(t,l,L-257),ie(t,l+5,M-1),ie(t,l+10,I-4),l+=14;for(var g=0;g<I;++g)ie(t,l+3*g,E[nr[g]]);l+=3*I;for(var N=[_,T],K=0;K<2;++K)for(var X=N[K],g=0;g<X.length;++g){var F=X[g]&31;ie(t,l,V[F]),l+=E[F],F>15&&(ie(t,l,X[g]>>>5&127),l+=X[g]>>>12)}}else P=Ws,A=le,U=Bs,$=Ke;for(var g=0;g<i;++g)if(n[g]>255){var F=n[g]>>>18&31;$e(t,l,P[F+257]),l+=A[F+257],F>7&&(ie(t,l,n[g]>>>23&31),l+=ht[F]);var z=n[g]&31;$e(t,l,U[z]),l+=$[z],z>3&&($e(t,l,n[g]>>>5&8191),l+=pt[z])}else $e(t,l,P[n[g]]),l+=A[n[g]];return $e(t,l,P[256]),l+A[256]},ei=new ct([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),ur=new C(0),ti=function(e,t,r,n,o,s){var a=e.length,i=new C(n+a+5*(1+Math.ceil(a/7e3))+o),f=i.subarray(n,i.length-o),u=0;if(!t||a<8)for(var l=0;l<=a;l+=65535){var c=l+65535;c>=a&&(f[u>>3]=s),u=ar(f,u+1,e.subarray(l,c))}else{for(var p=ei[t-1],h=p>>>13,d=p&8191,v=(1<<r)-1,w=new k(32768),x=new k(v+1),_=Math.ceil(r/3),L=2*_,q=function(Mt){return(e[Mt]^e[Mt+1]<<_^e[Mt+2]<<L)&v},T=new ct(25e3),M=new k(288),j=new k(32),g=0,B=0,l=0,E=0,ve=0,I=0;l<a;++l){var R=q(l),D=l&32767,Q=x[R];if(w[D]=Q,x[R]=D,ve<=l){var P=a-l;if((g>7e3||E>24576)&&P>423){u=Sn(e,f,0,T,M,j,B,E,I,l-I,u),E=g=B=0,I=l;for(var A=0;A<286;++A)M[A]=0;for(var A=0;A<30;++A)j[A]=0}var U=2,$=0,V=d,N=D-Q&32767;if(P>2&&R==q(l-N))for(var K=Math.min(h,P)-1,X=Math.min(32767,l),F=Math.min(258,P);N<=X&&--V&&D!=Q;){if(e[l+U]==e[l+U-N]){for(var z=0;z<F&&e[l+z]==e[l+z-N];++z);if(z>U){if(U=z,$=N,z>K)break;for(var et=Math.min(N,z-2),qe=0,A=0;A<et;++A){var ge=l-N+A+32768&32767,lo=w[ge],wr=ge-lo+32768&32767;wr>qe&&(qe=wr,Q=ge)}}}D=Q,Q=w[D],N+=D-Q+32768&32767}if($){T[E++]=268435456|or[U]<<18|bn[$];var Sr=or[U]&31,xr=bn[$]&31;B+=ht[Sr]+pt[xr],++M[257+Sr],++j[xr],ve=l+U,++g}else T[E++]=e[l],++M[e[l]]}}u=Sn(e,f,s,T,M,j,B,E,I,l-I,u),!s&&u&7&&(u=ar(f,u+1,ur))}return Pn(i,0,n+fr(u)+o)};var ri=function(e,t,r,n,o){return ti(e,t.level==null?6:t.level,t.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(e.length)))*1.5):12+t.mem,r,n,!o)};function dt(e,t){return ri(e,t||{},0,0)}function vt(e,t){return Ys(e,t)}var ni=typeof TextDecoder<"u"&&new TextDecoder,oi=0;try{ni.decode(ur,{stream:!0}),oi=1}catch{}var Me="@based",Je=Me+"-cache-",Ze=Me+"-size",We=Me+"-authState-";var Mn=new TextDecoder,Tn=new TextEncoder,si=e=>{let t=global.atob(e),r=Mn.decode(vt(Tn.encode(t)));return JSON.parse(r)},gt=(e,t)=>{let r=localStorage.getItem(t);r&&(e.storageSize-=new Blob([r]).size,localStorage.setItem(Ze,String(e.storageSize)),localStorage.removeItem(t))},Ge=()=>{let e=Object.keys(localStorage);try{for(let t of e)t.startsWith(Me)&&localStorage.removeItem(t)}catch{try{localStorage.clear()}catch{}}},cr=(e,t,r)=>{try{let n=e.storageEnvKey;if(!n)return;let o=localStorage.getItem(t),s=JSON.stringify(r),a=s.length>70||t===We+n?global.btoa(Mn.decode(dt(Tn.encode(s)))):s,f=new Blob([a]).size;o&&(e.storageSize-=new Blob([o]).size),e.storageSize+=f,e.storageSize>e.maxStorageSize&&(Ge(),e.storageSize=0,e.authState.persistent===!0&&cr(e,We+n,e.authState),e.storageSize+=f),localStorage.setItem(Ze,String(e.storageSize)),localStorage.setItem(t,a)}catch{}},An=(e,t)=>{let r=e.storageEnvKey;if(!!r)try{let n=localStorage.getItem(t);if(n!==void 0){if(n.length<70&&t!==We+r)try{return JSON.parse(n)}catch{}return si(n)}return}catch{}},In=async e=>{let t=e.storageEnvKey;if(!t)return;let r=global.__basedcache__??{};for(let n in r)e.cache.set(Number(n),r[n]);try{let n=Number(localStorage.getItem(Ze)||0);n<0&&(Ge(),n=0),e.storageSize=n;let o=Object.keys(localStorage);if(o.length===1&&n>0&&(Ge(),n=0),n>0)for(let s of o){if(s===Ze||!s.startsWith(Me))continue;if(s===We+t){let l=An(e,s);l&&e.setAuthState(l).catch(c=>{console.error(c.message),gt(e,s)});continue}let[,a]=s.split(Je);if(!a)continue;let[i,f]=a.split("-");if(f!==String(t))continue;if(!i){gt(e,s);continue}let u=An(e,s);e.cache.set(Number(i),u)}}catch{}};var Be=typeof window<"u",yt=(e,t)=>{let r=e.storageEnvKey;!r||(Be?(t+="-"+r,gt(e,t)):e.storagePath)},de=(e,t,r)=>{let n=e.storageEnvKey;!n||(Be?(t+="-"+n,cr(e,t,r)):e.storagePath)},hr=async e=>{Be||e.storagePath},Dn=async e=>{if(Be)return In(e);e.storagePath},zn=async e=>{if(Be)return Ge();e.storagePath};var Te=(e,t)=>{t.persistent?de(e,"@based-authState",t):yt(e,"@based-authState"),e.authState=t};var Ve=new TextEncoder,ee=(e,t,r,n)=>{for(let o=r;o<r+n;o++){let s=t&255;e[o]=s,t=(t-s)/256}},ii=(e,t,r)=>{let n=(e<<1)+(t|0);return(r<<4)+n},ce=(e,t,r,n=r)=>{let o=ii(e,t,r),s=new Uint8Array(n);return ee(s,o,0,4),s},Ie=(e,t=!1)=>{let r,n=!1;return e!==void 0?(r=Ve.encode(typeof e=="string"?e:JSON.stringify(e)),!t&&r.length>150&&(r=dt(r),n=!0),[n,r]):[!1]},qn=(e,t)=>{let r=4,[n,o,s,a]=t;if(n===3){let i=Ve.encode(o);r+=1+i.length;let[f,u]=Ie(a);u&&(r+=u.length);let l=16;r+=l;let c=ce(n,f,r,5+l);return ee(c,e,4,8),ee(c,s,12,8),c[20]=i.length,u?{buffers:[c,i,u],len:r}:{buffers:[c,i],len:r}}return{buffers:[],len:0}},mt=(e,t)=>{let r=4,[n,o,s]=t;if(n===7){let c=ce(n,!1,12);return ee(c,e,4,8),{buffers:[c],len:12}}let a=Ve.encode(o);r+=1+a.length;let i=n===6,[,f]=Ie(s,!0);f&&(r+=f.length);let u=8;r+=u;let l=ce(5,i,r,5+u);return ee(l,e,4,8),l[12]=a.length,f?{buffers:[l,a,f],len:r}:{buffers:[l,a],len:r}},Cn=(e,t)=>{let r=4,[n,o,s,a]=t;if(n===2){let p=ce(n,!1,12);return ee(p,e,4,8),{buffers:[p],len:12}}let i=Ve.encode(o);r+=1+i.length;let[f,u]=Ie(a);u&&(r+=u.length);let l=16;r+=l;let c=ce(n,f,r,5+l);return ee(c,e,4,8),ee(c,s,12,8),c[20]=i.length,u?{buffers:[c,i,u],len:r}:{buffers:[c,i],len:r}},En=e=>{let t=7,[r,n,o]=e,s=Ve.encode(n);t+=1+s.length;let[a,i]=Ie(o);i&&(t+=i.length);let f=ce(0,a,t,8);return ee(f,r,4,3),f[7]=s.length,i?{buffers:[f,s,i],len:t}:{buffers:[f,s],len:t}},Qn=e=>{let t=12,[r,n]=e,[o,s]=Ie(n);s&&(t+=s.length);let a=ce(6,o,t,12);return ee(a,r,4,8),s?{buffers:[a,s],len:t}:{buffers:[a],len:t}},Fn=e=>{let t=4,[r,n]=Ie(e);n&&(t+=n.length);let o=ce(4,r,t);return n&&o.set(n,4),o};var Ln=ae(re(),1),ai=new Uint8Array(0),fi=e=>{clearTimeout(e.idlePing),e.idlePing=setTimeout(()=>{e.connection&&e.connected&&!e.connection.disconnected&&e.connection.ws.send(ai)},6e4)},kn=e=>!!(e.fQ.length||e.oQ.size||e.gQ.size||e.cQ.size||e.pQ.length),te=e=>{if(e.connected&&!e.drainInProgress&&kn(e)){e.drainInProgress=!0;let t=()=>{if(e.drainInProgress=!1,!!e.connected&&kn(e)){let r=e.cQ,n=e.pQ,o=e.fQ,s=e.oQ,a=e.gQ,i=[],f=0;for(let[c,p]of r){let{buffers:h,len:d}=mt(c,p);i.push(...h),f+=d}for(let[c,p]of a){let{buffers:h,len:d}=qn(c,p);i.push(...h),f+=d}for(let[c,p]of s){let{buffers:h,len:d}=Cn(c,p);i.push(...h),f+=d}for(let c of o){let{buffers:p,len:h}=En(c);i.push(...p),f+=h}for(let c of n){let{buffers:p,len:h}=Qn(c);i.push(...p),f+=h}let u=new Uint8Array(f),l=0;for(let c of i)u.set(c,l),l+=c.length;e.fQ=[],e.pQ=[],e.oQ.clear(),e.gQ.clear(),e.cQ.clear(),e.connection.ws.send(u),fi(e)}};e.drainTimeout=setTimeout(t,0)}};var Xe=(e,t,r,n,o)=>{e.requestId++,e.requestId>16777215&&(e.requestId=0);let s=e.requestId,a=Error().stack.split(/BasedClient\.function.+:\d\d\)/)[1];e.functionResponseListeners.set(s,[n,o,a]),e.fQ.push([s,r,t]),te(e)},Rn=(e,t)=>{e.cQ.get(t)?.[0]!==7&&(e.cQ.set(t,[7]),te(e))},bt=(e,t,r,n)=>{e.cQ.get(r)?.[0]!==5&&(e.cQ.set(r,[5,t,n]),te(e))},wt=(e,t,r,n)=>{let o=e.cQ.get(r)?.[0];o===5||o===6||(e.cQ.set(r,[6,t,n]),te(e))},Un=(e,t,r)=>{e.pQ.length>e.maxPublishQueue&&e.pQ.shift(),e.pQ.push([t,r]),te(e)},Nn=(e,t)=>{e.oQ.get(t)?.[0]!==2&&(e.oQ.set(t,[2]),te(e))},St=(e,t,r,n,o=0)=>{e.oQ.get(r)?.[0]!==1&&(e.oQ.set(r,[1,t,o,n]),te(e))},xt=(e,t,r,n,o=0)=>{e.gQ.has(r)||(e.gQ.set(r,[3,t,o,n]),te(e))},pr=async(e,t)=>(0,Ln.deepEqual)(t,e.authState)?(console.warn("[Based] Trying to send the same authState twice",e.authState),e.authRequest.inProgress?e.authRequest.promise:new Promise(r=>r({}))):(e.authRequest.inProgress&&(console.warn("[Based] Authentication still in progress - waiting until done"),await e.authRequest.promise),Te(e,t),e.emit("authstate-change",e.authState),e.connected&&e.connection.ws.send(Fn(t)),e.authRequest.promise=new Promise((r,n)=>{e.authRequest.inProgress=!0,e.authRequest.resolve=r,e.authRequest.reject=n}).finally(()=>{e.authRequest.resolve=null,e.authRequest.reject=null,e.authRequest.inProgress=!1}),e.authRequest.promise);var no=ae(vr(),1);var oo=ae(re(),1);var to=e=>{let t=e>>4,r=e&15,n=r>>1,o=r&1;return{type:n,isDeflate:o===1,len:t}},H=(e,t,r)=>{let n=0,o=r-1+t;for(let s=o;s>=t;s--)n=n*256+e[s];return n},ro=async e=>{if(e instanceof ArrayBuffer)return new Uint8Array(e);if(typeof window>"u"){if(e instanceof Buffer)return new Uint8Array(e)}else if(e instanceof Blob){let t=await e.arrayBuffer();return new Uint8Array(t)}throw new Error("432")},_t=(e,t)=>{let r=e.observeState.get(t);xt(e,r.name,t,r.payload)};var yr=(e,t,r)=>{let n=r==="sub"?e.observeState.get(t):e.channelState.get(t);return n?n.payload?{name:n.name,payload:n.payload,id:t}:{name:n.name,id:t}:{name:`[Cannot find ${t}]`,id:t}};var ze=(e,t,r,n)=>new TextDecoder().decode(r?vt(n.slice(e,t)):n.slice(e,t)),so=async(e,t)=>{if(!e.isDestroyed)try{let r=t.data,n=await ro(r),{type:o,len:s,isDeflate:a}=to(H(n,0,4));if(o===0){let i=H(n,4,3),f=7,u=s+4,l;s!==3&&(l=JSON.parse(ze(f,u,a,n))),e.functionResponseListeners.has(i)&&(e.functionResponseListeners.get(i)[0](l),e.functionResponseListeners.delete(i))}else if(o===3){let i=H(n,4,8);if(e.getState.has(i)&&e.cache.has(i)){let f=e.getState.get(i);for(let[u]of f)u(e.cache.get(i).value);e.getState.delete(i)}}else if(o===2){let i=H(n,4,8),f=e.cache.get(i);if(!f){_t(e,i);return}let u=H(n,12,8),l=H(n,20,8);if(f.checksum!==l){_t(e,i);return}let c=28,p=s+4,h;s!==24&&(h=JSON.parse(ze(c,p,a,n)));try{f.value=(0,no.applyPatch)(f.value,h),f.checksum=u}catch{_t(e,i);return}if(e.observeState.has(i)){let d=e.observeState.get(i);d.persistent&&(f.persistent=!0,de(e,Je+i,f));for(let[,v]of d.subscribers)v.onData(f.value,u)}if(e.getState.has(i)){let d=e.getState.get(i);for(let[v]of d)v(f.value);e.getState.delete(i)}}else if(o===1){let i=H(n,4,8),f=H(n,12,8),u=20,l=s+4,c;s!==16&&(c=JSON.parse(ze(u,l,a,n)));let p={value:c,checksum:f};if(e.cache.set(i,p),e.observeState.has(i)){let h=e.observeState.get(i);h.persistent&&(p.persistent=!0,de(e,Je+i,p));for(let[,d]of h.subscribers)d.onData(c,f)}if(e.getState.has(i)){let h=e.getState.get(i);for(let[d]of h)d(c);e.getState.delete(i)}}else if(o===4){let f=s+4,u;s!==3&&(u=JSON.parse(ze(4,f,a,n))),u===!0?e.authRequest.resolve?.(e.authState):"error"in u?(Te(e,u),e.emit("authstate-change",e.authState),e.authRequest.reject?.(new Error(u.error))):((0,oo.deepEqual)(e.authState,u)?Te(e,u):(Te(e,u),e.emit("authstate-change",e.authState)),e.authRequest?.resolve?.(e.authState))}else if(o===5){let f=s+4,u;if(s!==3&&(u=JSON.parse(ze(4,f,a,n))),u.requestId&&e.functionResponseListeners.has(u.requestId)){let[,l,c]=e.functionResponseListeners.get(u.requestId);l(je(u,c)),e.functionResponseListeners.delete(u.requestId)}if(u.channelId&&e.channelState.has(u.channelId)){let l=je(u),c=e.channelState.get(u.channelId);for(let[,p]of c.subscribers)p.onError?p.onError(l):console.error(yr(e,u.channelId,"channel"),l)}if(u.observableId){if(e.cache.delete(u.observableId),e.observeState.has(u.observableId)){let l=je(u),c=e.observeState.get(u.observableId);for(let[,p]of c.subscribers)p.onError?p.onError(l):console.error(yr(e,u.observableId,"sub"),l)}if(e.getState.has(u.observableId)){let l=je(u),c=e.getState.get(u.observableId);for(let[,p]of c)p(l);e.getState.delete(u.observableId)}}}else if(o===6){let i=H(n,4,8),f=e.channelState.get(i);if(i){if(!f.inTransit){f.inTransit=!0;let{buffers:u,len:l}=mt(i,[6,f.name,f.payload]),c=new Uint8Array(l),p=0;for(let h of u)c.set(h,p),p+=h.length;e.connection.ws.send(c),f.removeTimer!==-1&&f.removeTimer<2&&(f.removeTimer+=1),setTimeout(()=>{let h=e.channelState.get(i);h&&(h.inTransit=!1)},5e3)}e.connection.ws.send(n)}}else if(o===7&&H(n,4,1)===0){let f=H(n,5,8),u=13,l=s+5,c;if(s!==9){let p=ze(u,l,a,n);try{c=JSON.parse(p)}catch{c=p}}if(e.channelState.has(f)){let p=e.channelState.get(f);for(let[,h]of p.subscribers)h.onMessage(c)}}}catch(r){console.error(981,r)}};var Ot=ae(he(),1),jt=(e,t)=>t===void 0?(0,Ot.hash)(e):(0,Ot.hashObjectIgnoreKeyOrder)([e,t]);var Pt=class{id;query;name;client;persistent;constructor(t,r,n,o){this.query=n,this.id=jt(r,n),this.client=t,this.name=r,this.persistent=o?.persistent||!1}get cache(){return this.client.cache.get(this.id)||null}clearCache(){this.persistent&&yt(this.client,"@based-cache-"+this.id),this.client.cache.delete(this.id)}subscribe(t,r){let n,o=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){let s=this.client.observeState.get(this.id);this.persistent&&!s.persistent&&(s.persistent=!0,o&&de(this.client,"@based-cache-"+this.id,o)),n=++s.idCnt,s.subscribers.set(n,{onError:r,onData:t})}else{n=1;let s=new Map;s.set(n,{onError:r,onData:t}),this.client.observeState.set(this.id,{payload:this.query,name:this.name,subscribers:s,persistent:this.persistent||!1,idCnt:1}),St(this.client,this.name,this.id,this.query,o?.checksum||0)}return o&&t(o.value,o.checksum),()=>{let s=this.client.observeState.get(this.id);s?(s.subscribers.delete(n),s.subscribers.size===0&&(this.client.observeState.delete(this.id),Nn(this.client,this.id))):console.warn("Subscription allready removed",this.query,this.name)}}async getWhen(t){return new Promise(r=>{let n=this.subscribe((o,s)=>{t(o,s)&&(r(o),n())})})}async get(){return new Promise((t,r)=>{if(this.client.getState.has(this.id)){this.client.getState.get(this.id).push([t,r]);return}this.client.getState.set(this.id,[]);let n=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){if(this.client.oQ.has(this.id)){let[o]=this.client.oQ.get(this.id);if(o===1){this.client.getState.get(this.id).push([t,r]);return}}if(n){t(n.value);return}}this.client.getState.get(this.id).push([t,r]),xt(this.client,this.name,this.id,this.query,n?.checksum||0)})}};var io=async(e,t,r,n)=>{};var Ye=e=>{e.channelCleanTimeout||(e.channelCleanTimeout=setTimeout(()=>{if(e.channelCleanTimeout=null,e.connected){let t=!1;e.channelState.forEach((r,n)=>{r.removeTimer!==-1&&(r.removeTimer--,r.removeTimer===0?e.channelState.delete(n):t=!0)}),t&&Ye(e)}else Ye(e)},e.channelCleanupCycle))};var At=class{id;payload;name;client;constructor(t,r,n){this.payload=n,this.id=jt(r,n),this.client=t,this.name=r}subscribe(t,r){let n;if(!this.client.channelState.has(this.id)||this.client.channelState.get(this.id).subscribers.size===0){n=1;let o=new Map;o.set(n,{onMessage:t,onError:r}),this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:o,removeTimer:-1,idCnt:1}),bt(this.client,this.name,this.id,this.payload)}else{let o=this.client.channelState.get(this.id);o.removeTimer=-1,n=++o.idCnt,o.subscribers.set(n,{onMessage:t,onError:r})}return()=>{let o=this.client.channelState.get(this.id);o.subscribers.delete(n),o.subscribers.size===0&&(o.removeTimer=2,Rn(this.client,this.id))}}publish(t){if(!this.client.channelState.has(this.id))this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:new Map,removeTimer:2,idCnt:0}),Ye(this.client),wt(this.client,this.name,this.id,this.payload);else{let r=this.client.channelState.get(this.id);r.removeTimer!==-1&&r.removeTimer<2&&(r.removeTimer=2,Ye(this.client))}Un(this.client,this.id,t)}};var ao=ae(he(),1),fo=ae(re(),1),uo=ae(dn(),1),yi=uo.default.default;var mr=class extends mn{constructor(t,r){super(),r?.persistentStorage&&(this.storagePath=r.persistentStorage),r?.maxCacheSize&&(console.warn("MaxCacheSize setting not implemented yet..."),this.maxCacheSize=r.maxCacheSize),t&&this.connect(t)}storageSize=0;maxStorageSize=5e6-500;storageEnvKey=0;storagePath;storageBeingWritten;opts;connected=!1;connection;url;outgoingStreams=new Map;isDrainingStreams=!1;maxPublishQueue=1e3;pQ=[];fQ=[];oQ=new Map;cQ=new Map;gQ=new Map;drainInProgress=!1;drainTimeout;idlePing;localStorage=!1;maxCacheSize=4e6;cache=new Map;functionResponseListeners=new Map;requestId=0;channelState=new Map;channelCleanTimeout;channelCleanupCycle=3e4;observeState=new Map;getState=new Map;authState={};authRequest={authState:null,promise:null,resolve:null,reject:null,inProgress:!1};onClose(){this.connected=!1,this.functionResponseListeners.size>this.fQ.length&&this.functionResponseListeners.forEach((t,r)=>{this.fQ.find(([n])=>n===r)||(t[1](new Error("Server disconnected before function result was processed")),this.functionResponseListeners.delete(r))}),this.emit("disconnect",!0)}onReconnect(){this.connected=!0,this.emit("reconnect",!0)}onOpen(){this.connected=!0,this.emit("connect",!0);for(let[t,r]of this.observeState)if(!this.oQ.has(t)){let n=this.cache.get(t);St(this,r.name,t,r.payload,n?.checksum||0)}for(let[t,r]of this.channelState)this.cQ.has(t)||(r.subscribers.size?bt(this,r.name,t,r.payload):wt(this,r.name,t,r.payload));te(this)}onData(t){so(this,t)}async connect(t){if(t&&Object.keys(t).length>0){if(this.opts){if((0,fo.deepEqual)(this.opts,t))return;this.disconnect()}this.opts=t,this.url=()=>yi(t),this.storageEnvKey=(0,ao.hashObjectIgnoreKeyOrder)(t),Dn(this)}if(!this.opts){console.error("Configure opts to connect");return}this.url&&!this.connection&&(this.connection=yn(this,this.url))}disconnect(){this.connection&&(this.connection.disconnected=!0,this.connection.destroy(),this.connection.ws&&this.connection.ws.close(),this.connected&&this.onClose(),delete this.connection),clearTimeout(this.drainTimeout),clearTimeout(this.idlePing),this.connected=!1}isDestroyed;async destroy(t){t||await hr(this),clearTimeout(this.storageBeingWritten),clearTimeout(this.channelCleanTimeout),this.disconnect();for(let r in this)delete this[r];this.isDestroyed=!0}channel(t,r){return new At(this,t,r)}query(t,r,n){return new Pt(this,t,r,n)}call(t,r,n){let o=n?.retryStrategy;return o?new Promise(s=>{let a=0,i=0,f=u=>{let l=o(u,a,i);i++,typeof l=="number"&&!isNaN(l)&&(a=l,l===0?Xe(this,r,t,s,f):setTimeout(()=>{Xe(this,r,t,s,f)},l))};return Xe(this,r,t,s,f)}):new Promise((s,a)=>Xe(this,r,t,s,a))}stream(t,r,n){return io(this,t,r,n)}setAuthState(t){if(typeof t=="object")return pr(this,t);throw new Error("Invalid auth() arguments")}clearAuthState(){return pr(this,{})}clearStorage(){return zn(this)}saveStorage(){return hr(this)}genCacheScript(){return`<script>window.__basedcache__=${JSON.stringify(mi(this))}<\/script>`}},mi=e=>{let t={};return e.cache.forEach((r,n)=>{t[n]=r}),t};function br(e,t){return new mr(e,t)}var bi=br({url:"ws://localhost:8082"}),wi=()=>{let e=document.body;bi.query("text").subscribe(t=>{e.innerHTML=t.map(r=>`<div>${r}</div>`).join("!!!----------")})};wi();})();
