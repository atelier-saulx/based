(()=>{var Ft=(e,t)=>{typeof e=="function"?e().then(n=>{t(n)}):t(e)};var Ct=e=>{let t=Array.isArray(e)?[]:{};for(let n in e)e[n]!==null&&typeof e[n]=="object"?t[n]=Ct(e[n]):t[n]=e[n];return t},Te=Ct;var Ne=(e=100)=>new Promise(t=>{setTimeout(()=>t(),e)});var st=(e,t)=>{let n=typeof e,r=typeof t;if(e===t)return!0;if(n!==r||e===null||t===null)return!1;if(n!=="object"){if(n==="function"){if(e.toString()!==t.toString())return!1}else if(e!==t)return!1}else{if(Array.isArray(e))if(Array.isArray(t)){let o=e.length;if(o!==t.length)return!1;for(let a=0;a<o;a++){let i=typeof e[a];if(typeof t[a]!==i)return!1;if(i==="object"&&!st(e[a],t[a]))return!1}}else return!1;if(e.checksum||t.checksum)return e.checksum===t.checksum;let s=0;for(let o in e){if(o[0]==="_"||!e.hasOwnProperty(o))continue;if(!t.hasOwnProperty(o))return!1;let a=t[o],i=e[o];if(a===void 0&&i!==void 0)return!1;let c=typeof a;if(c!==typeof i)return!1;if(a&&c==="object"){if(!st(i,a))return!1}else if(a!==i)return!1;s++}for(let o in t)if(s--,s<0)return!1}return!0},ie=st;var Fn=(e,t=5381)=>{let n=e.length;for(;n;){let r=e.charCodeAt(--n);t=t*33^r}return t},D=Fn;var he=(e,t,n,r,s)=>{let o=typeof r,a="";if(o==="string")a=n+":"+r;else if(o==="number")a=n+"n:"+r;else if(o==="object")if(r===null)a=n+"v:null";else{let i=s(r,e,t);return[D(n+"o:",i[0]),D(n+"o:",i[1])]}else o==="boolean"&&(a=n+"b:"+(r?"true":"false"));return[D(a,e),D(a,t)]};var ot=(e,t=5381,n=52711)=>{if(Array.isArray(e))for(let r=0;r<e.length;r++){let s=he(t,n,r,e[r],ot);t=s[0],n=s[1]}else for(let r in e){if(r===void 0)continue;let s=he(t,n,r,e[r],ot);t=s[0],n=s[1]}return[t,n]},it=ot;var Cn=e=>{let t=it(e);return(t[0]>>>0)*4096+t[1]},ze=Cn;var Pn=(e,t)=>{let n;if(typeof e=="object"?e===null?n=0:n=ze(e):typeof e=="boolean"?n=e?792222265344:4821552340992:typeof e=="number"?n=(D("n:"+e)>>>0)*4096+(D("n:"+e,52711)>>>0):n=(D(e)>>>0)*4096+(D(e,52711)>>>0),t){let r=Math.ceil(Math.log10(n+1));if(r<t)return n*Math.pow(10,t-r)}return n},Ie=Pn;var at=(e,t=5381,n=52711)=>{if(Array.isArray(e)){let r="__len:"+e.length+1;t=D(r,t),n=D(r,n);for(let s=0;s<e.length;s++){let o=e[s],a=he(t,n,s,o,at);t=a[0],n=a[1]}}else{let r=Object.keys(e).sort(),s="__len:"+r.length+1;t=D(s,t),n=D(s,n);for(let o=0;o<r.length;o++){let a=r[o];if(a===void 0)continue;let i=e[a],c=he(t,n,a,i,at);t=c[0],n=c[1]}}return[t,n]},ft=at;var Dn=e=>{let t=ft(e);return(t[0]>>>0)*4096+(t[1]>>>0)},X=Dn;var Pt=(e,t,n)=>{let r=e.length;for(let s=0;s<t-r;s++)e=n+e;return e};var Dt=(e,t,n=["$"],r)=>{if(n.length>1&&e)return o=>{let a="";for(let i=0;i<o.length;i++){let c=o[i];if(n.includes(c)){let f="";for(let u=0;u<t;u++)f+=o[i+u+1];let l=r[f];a+=l,i+=t}else a+=c}return a};if(n.length>1)return o=>{let a="";for(let i=0;i<o.length;i++){let c=o[i];if(n.includes(c)){let f=r[o[i+1]];a+=f,i++}else a+=c}return a};let s=n[0];return e?o=>{let a="";for(let i=0;i<o.length;i++){let c=o[i];if(c===s){let f="";for(let u=0;u<t;u++)f+=o[i+u+1];let l=r[f];a+=l,i+=t}else a+=c}return a}:o=>{let a="";for(let i=0;i<o.length;i++){let c=o[i];if(c===s){let f=r[o[i+1]];a+=f,i++}else a+=c}return a}};var Lt=(e,t)=>t%2?e[e.length-t]:e[t],Rt=(e,t,n)=>{if(n.length>1&&e===1){let r=n.length;return s=>{let o=0,a="";for(let i=0;i<s.length;i++){let c=s.charAt(i);t[c]?(o+=1,o>=r&&(o=0),a+=Lt(n,o)+t[c]):a+=c}return a}}if(n.length>1){let r=n.length;return s=>{let o=0,a="";for(let i=0;i<s.length;i++){let c=!1;for(let f=e-1;f>-1;f--){if(i+f>s.length-1)continue;let l="";for(let u=0;u<f+1;u++)l+=s.charAt(i+u);t[l]&&(o+=1,o>=r&&(o=0),a+=Lt(n,o)+t[l],i+=l.length-1,f=-1,c=!0)}c||(a+=s.charAt(i))}return a}}return e===1?r=>{let s="";for(let o=0;o<r.length;o++){let a=r.charAt(o);t[a]?s+=t[a]:s+=a}return s}:r=>{let s="";for(let o=0;o<r.length;o++){let a=!1;for(let i=e-1;i>-1;i--){if(o+i>r.length-1)continue;let c="";for(let f=0;f<i+1;f++)c+=r.charAt(o+f);t[c]&&(s+=t[c],o+=c.length-1,i=-1,a=!0)}a||(s+=r.charAt(o))}return s}};var ke=(e,t=["$"])=>{let n=1,r=e.length>36,s=[...e,...t],o=s.map((f,l)=>(f.length>n&&(n=f.length),l>25?String(l-26):String.fromCharCode(97+l))),a={},i={};for(let f=0;f<s.length;f++)a[s[f]]=t.length===1?t[0]+o[f]:o[f],i[o[f]]=s[f];let c=1;if(r){for(let f in i)f.length>c&&(c=f.length);for(let f in i)if(f.length<c){let l=Pt(f,c,"0"),u=i[f];t.length>1?a[u]=l:a[u]=t[0]+l,delete i[f],i[l]=u}}return{charMap:a,reverseCharMap:i,encode:Rt(n,a,t),decode:Dt(r,c,t,i)}};var Ln=e=>e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0,Ue=e=>e<26?e+65:e<52?e+71:e<62?e-4:e===62?43:e===63?47:65,ct=(e,t)=>{let n=e.replace(/[^A-Za-z0-9+/]/g,""),r=n.length,s=t?Math.ceil((r*3+1>>2)/t)*t:r*3+1>>2,o=new Uint8Array(s),a,i,c=0,f=0;for(let l=0;l<r;l++)if(i=l&3,c|=Ln(n.charCodeAt(l))<<6*(3-i),i===3||r-l===1){for(a=0;a<3&&f<s;)o[f]=c>>>(16>>>a&24)&255,a++,f++;c=0}return o},$e=e=>{let t=2,n="",r=e.length,s=0;for(let o=0;o<r;o++)t=o%3,s|=e[o]<<(16>>>t&24),(t===2||e.length-o===1)&&(n+=String.fromCodePoint(Ue(s>>>18&63),Ue(s>>>12&63),Ue(s>>>6&63),Ue(s&63)),s=0);return n.substring(0,n.length-2+t)+(t===2?"":t===1?"=":"==")};var{encode:Rn,decode:Rs}=ke(["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," "],["0"]),Qt=e=>Rn($e(new TextEncoder().encode(JSON.stringify(e))));var Et=e=>e.contents instanceof File,Qn=e=>e!==null&&typeof e=="object"&&typeof e.pipe=="function"&&e.readable!==!1&&typeof e._read=="function"&&typeof e._readableState=="object",Nt=e=>"path"in e&&typeof e.path=="string",kt=e=>"contents"in e&&Qn(e.contents);var Q=Uint8Array,q=Uint16Array,vt=Int32Array,He=new Q([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),qe=new Q([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),pt=new Q([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),qt=function(e,t){for(var n=new q(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];for(var s=new vt(n[30]),r=1;r<30;++r)for(var o=n[r];o<n[r+1];++o)s[o]=o-n[r]<<5|r;return{b:n,r:s}},Jt=qt(He,2),Kt=Jt.b,gt=Jt.r;Kt[28]=258,gt[258]=28;var Gt=qt(qe,0),En=Gt.b,Ut=Gt.r,mt=new q(32768);for(b=0;b<32768;++b)Y=(b&43690)>>1|(b&21845)<<1,Y=(Y&52428)>>2|(Y&13107)<<2,Y=(Y&61680)>>4|(Y&3855)<<4,mt[b]=((Y&65280)>>8|(Y&255)<<8)>>1;var Y,b,Z=function(e,t,n){for(var r=e.length,s=0,o=new q(t);s<r;++s)e[s]&&++o[e[s]-1];var a=new q(t);for(s=1;s<t;++s)a[s]=a[s-1]+o[s-1]<<1;var i;if(n){i=new q(1<<t);var c=15-t;for(s=0;s<r;++s)if(e[s])for(var f=s<<4|e[s],l=t-e[s],u=a[e[s]-1]++<<l,h=u|(1<<l)-1;u<=h;++u)i[mt[u]>>c]=f}else for(i=new q(r),s=0;s<r;++s)e[s]&&(i[s]=mt[a[e[s]-1]++]>>15-e[s]);return i},re=new Q(288);for(b=0;b<144;++b)re[b]=8;var b;for(b=144;b<256;++b)re[b]=9;var b;for(b=256;b<280;++b)re[b]=7;var b;for(b=280;b<288;++b)re[b]=8;var b,je=new Q(32);for(b=0;b<32;++b)je[b]=5;var b,Nn=Z(re,9,0),kn=Z(re,9,1),Un=Z(je,5,0),$n=Z(je,5,1),lt=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},K=function(e,t,n){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(t&7)&n},ut=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(t&7)},yt=function(e){return(e+7)/8|0},Wt=function(e,t,n){return(t==null||t<0)&&(t=0),(n==null||n>e.length)&&(n=e.length),new Q(e.subarray(t,n))};var Hn=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ee=function(e,t,n){var r=new Error(t||Hn[e]);if(r.code=e,Error.captureStackTrace&&Error.captureStackTrace(r,ee),!n)throw r;return r},qn=function(e,t,n,r){var s=e.length,o=r?r.length:0;if(!s||t.f&&!t.l)return n||new Q(0);var a=!n,i=a||t.i!=2,c=t.i;a&&(n=new Q(s*3));var f=function(Se){var Ae=n.length;if(Se>Ae){var ue=new Q(Math.max(Ae*2,Se));ue.set(n),n=ue}},l=t.f||0,u=t.p||0,h=t.b||0,p=t.l,m=t.d,g=t.m,v=t.n,y=s*8;do{if(!p){l=K(e,u,1);var z=K(e,u+1,3);if(u+=3,z)if(z==1)p=kn,m=$n,g=9,v=5;else if(z==2){var E=K(e,u,31)+257,j=K(e,u+10,15)+4,w=E+K(e,u+5,31)+1;u+=14;for(var d=new Q(w),F=new Q(19),I=0;I<j;++I)F[pt[I]]=K(e,u+I*3,7);u+=j*3;for(var R=lt(F),ne=(1<<R)-1,U=Z(F,R,1),I=0;I<w;){var N=U[K(e,u,ne)];u+=N&15;var x=N>>4;if(x<16)d[I++]=x;else{var C=0,S=0;for(x==16?(S=3+K(e,u,3),u+=2,C=d[I-1]):x==17?(S=3+K(e,u,7),u+=3):x==18&&(S=11+K(e,u,127),u+=7);S--;)d[I++]=C}}var k=d.subarray(0,E),P=d.subarray(E);g=lt(k),v=lt(P),p=Z(k,g,1),m=Z(P,v,1)}else ee(1);else{var x=yt(u)+4,O=e[x-4]|e[x-3]<<8,M=x+O;if(M>s){c&&ee(0);break}i&&f(h+O),n.set(e.subarray(x,M),h),t.b=h+=O,t.p=u=M*8,t.f=l;continue}if(u>y){c&&ee(0);break}}i&&f(h+131072);for(var xe=(1<<g)-1,J=(1<<v)-1,V=u;;V=u){var C=p[ut(e,u)&xe],$=C>>4;if(u+=C&15,u>y){c&&ee(0);break}if(C||ee(2),$<256)n[h++]=$;else if($==256){V=u,p=null;break}else{var H=$-254;if($>264){var I=$-257,A=He[I];H=K(e,u,(1<<A)-1)+Kt[I],u+=A}var W=m[ut(e,u)&J],ce=W>>4;W||ee(3),u+=W&15;var P=En[ce];if(ce>3){var A=qe[ce];P+=ut(e,u)&(1<<A)-1,u+=A}if(u>y){c&&ee(0);break}i&&f(h+131072);var le=h+H;if(h<P){var Qe=o-P,Ee=Math.min(P,le);for(Qe+h<0&&ee(3);h<Ee;++h)n[h]=r[Qe+h]}for(;h<le;++h)n[h]=n[h-P]}}t.l=p,t.p=V,t.b=h,t.f=l,p&&(l=1,t.m=g,t.d=m,t.n=v)}while(!l);return h!=n.length&&a?Wt(n,0,h):n.subarray(0,h)},_=function(e,t,n){n<<=t&7;var r=t/8|0;e[r]|=n,e[r+1]|=n>>8},Oe=function(e,t,n){n<<=t&7;var r=t/8|0;e[r]|=n,e[r+1]|=n>>8,e[r+2]|=n>>16},ht=function(e,t){for(var n=[],r=0;r<e.length;++r)e[r]&&n.push({s:r,f:e[r]});var s=n.length,o=n.slice();if(!s)return{t:Bt,l:0};if(s==1){var a=new Q(n[0].s+1);return a[n[0].s]=1,{t:a,l:1}}n.sort(function(M,E){return M.f-E.f}),n.push({s:-1,f:25001});var i=n[0],c=n[1],f=0,l=1,u=2;for(n[0]={s:-1,f:i.f+c.f,l:i,r:c};l!=s-1;)i=n[n[f].f<n[u].f?f++:u++],c=n[f!=l&&n[f].f<n[u].f?f++:u++],n[l++]={s:-1,f:i.f+c.f,l:i,r:c};for(var h=o[0].s,r=1;r<s;++r)o[r].s>h&&(h=o[r].s);var p=new q(h+1),m=dt(n[l-1],p,0);if(m>t){var r=0,g=0,v=m-t,y=1<<v;for(o.sort(function(E,j){return p[j.s]-p[E.s]||E.f-j.f});r<s;++r){var z=o[r].s;if(p[z]>t)g+=y-(1<<m-p[z]),p[z]=t;else break}for(g>>=v;g>0;){var x=o[r].s;p[x]<t?g-=1<<t-p[x]++-1:++r}for(;r>=0&&g;--r){var O=o[r].s;p[O]==t&&(--p[O],++g)}m=t}return{t:new Q(p),l:m}},dt=function(e,t,n){return e.s==-1?Math.max(dt(e.l,t,n+1),dt(e.r,t,n+1)):t[e.s]=n},$t=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new q(++t),r=0,s=e[0],o=1,a=function(c){n[r++]=c},i=1;i<=t;++i)if(e[i]==s&&i!=t)++o;else{if(!s&&o>2){for(;o>138;o-=138)a(32754);o>2&&(a(o>10?o-11<<5|28690:o-3<<5|12305),o=0)}else if(o>3){for(a(s),--o;o>6;o-=6)a(8304);o>2&&(a(o-3<<5|8208),o=0)}for(;o--;)a(s);o=1,s=e[i]}return{c:n.subarray(0,r),n:t}},Me=function(e,t){for(var n=0,r=0;r<t.length;++r)n+=e[r]*t[r];return n},Zt=function(e,t,n){var r=n.length,s=yt(t+2);e[s]=r&255,e[s+1]=r>>8,e[s+2]=e[s]^255,e[s+3]=e[s+1]^255;for(var o=0;o<r;++o)e[s+o+4]=n[o];return(s+4+r)*8},Ht=function(e,t,n,r,s,o,a,i,c,f,l){_(t,l++,n),++s[256];for(var u=ht(s,15),h=u.t,p=u.l,m=ht(o,15),g=m.t,v=m.l,y=$t(h),z=y.c,x=y.n,O=$t(g),M=O.c,E=O.n,j=new q(19),w=0;w<z.length;++w)++j[z[w]&31];for(var w=0;w<M.length;++w)++j[M[w]&31];for(var d=ht(j,7),F=d.t,I=d.l,R=19;R>4&&!F[pt[R-1]];--R);var ne=f+5<<3,U=Me(s,re)+Me(o,je)+a,N=Me(s,h)+Me(o,g)+a+14+3*R+Me(j,F)+2*j[16]+3*j[17]+7*j[18];if(c>=0&&ne<=U&&ne<=N)return Zt(t,l,e.subarray(c,c+f));var C,S,k,P;if(_(t,l,1+(N<U)),l+=2,N<U){C=Z(h,p,0),S=h,k=Z(g,v,0),P=g;var xe=Z(F,I,0);_(t,l,x-257),_(t,l+5,E-1),_(t,l+10,R-4),l+=14;for(var w=0;w<R;++w)_(t,l+3*w,F[pt[w]]);l+=3*R;for(var J=[z,M],V=0;V<2;++V)for(var $=J[V],w=0;w<$.length;++w){var H=$[w]&31;_(t,l,xe[H]),l+=F[H],H>15&&(_(t,l,$[w]>>5&127),l+=$[w]>>12)}}else C=Nn,S=re,k=Un,P=je;for(var w=0;w<i;++w){var A=r[w];if(A>255){var H=A>>18&31;Oe(t,l,C[H+257]),l+=S[H+257],H>7&&(_(t,l,A>>23&31),l+=He[H]);var W=A&31;Oe(t,l,k[W]),l+=P[W],W>3&&(Oe(t,l,A>>5&8191),l+=qe[W])}else Oe(t,l,C[A]),l+=S[A]}return Oe(t,l,C[256]),l+S[256]},Jn=new vt([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Bt=new Q(0),Kn=function(e,t,n,r,s,o){var a=o.z||e.length,i=new Q(r+a+5*(1+Math.ceil(a/7e3))+s),c=i.subarray(r,i.length-s),f=o.l,l=(o.r||0)&7;if(t){l&&(c[0]=o.r>>3);for(var u=Jn[t-1],h=u>>13,p=u&8191,m=(1<<n)-1,g=o.p||new q(32768),v=o.h||new q(m+1),y=Math.ceil(n/3),z=2*y,x=function(rt){return(e[rt]^e[rt+1]<<y^e[rt+2]<<z)&m},O=new vt(25e3),M=new q(288),E=new q(32),j=0,w=0,d=o.i||0,F=0,I=o.w||0,R=0;d+2<a;++d){var ne=x(d),U=d&32767,N=v[ne];if(g[U]=N,v[ne]=U,I<=d){var C=a-d;if((j>7e3||F>24576)&&(C>423||!f)){l=Ht(e,c,0,O,M,E,w,F,R,d-R,l),F=j=w=0,R=d;for(var S=0;S<286;++S)M[S]=0;for(var S=0;S<30;++S)E[S]=0}var k=2,P=0,xe=p,J=U-N&32767;if(C>2&&ne==x(d-J))for(var V=Math.min(h,C)-1,$=Math.min(32767,d),H=Math.min(258,C);J<=$&&--xe&&U!=N;){if(e[d+k]==e[d+k-J]){for(var A=0;A<H&&e[d+A]==e[d+A-J];++A);if(A>k){if(k=A,P=J,A>V)break;for(var W=Math.min(J,A-2),ce=0,S=0;S<W;++S){var le=d-J+S&32767,Qe=g[le],Ee=le-Qe&32767;Ee>ce&&(ce=Ee,N=le)}}}U=N,N=g[U],J+=U-N&32767}if(P){O[F++]=268435456|gt[k]<<18|Ut[P];var Se=gt[k]&31,Ae=Ut[P]&31;w+=He[Se]+qe[Ae],++M[257+Se],++E[Ae],I=d+k,++j}else O[F++]=e[d],++M[e[d]]}}for(d=Math.max(d,I);d<a;++d)O[F++]=e[d],++M[e[d]];l=Ht(e,c,f,O,M,E,w,F,R,d-R,l),f||(o.r=l&7|c[l/8|0]<<3,l-=7,o.h=v,o.p=g,o.i=d,o.w=I)}else{for(var d=o.w||0;d<a+f;d+=65535){var ue=d+65535;ue>=a&&(c[l/8|0]=f,ue=a),l=Zt(c,l+1,e.subarray(d,ue))}o.i=a}return Wt(i,0,r+yt(l)+s)};var Gn=function(e,t,n,r,s){if(!s&&(s={l:1},t.dictionary)){var o=t.dictionary.subarray(-32768),a=new Q(o.length+e.length);a.set(o),a.set(e,o.length),e=a,s.w=o.length}return Kn(e,t.level==null?6:t.level,t.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(e.length)))*1.5):12+t.mem,n,r,s)};function Fe(e,t){return Gn(e,t||{},0,0)}function pe(e,t){return qn(e,{i:2},t&&t.out,t&&t.dictionary)}var Wn=typeof TextDecoder<"u"&&new TextDecoder,Zn=0;try{Wn.decode(Bt,{stream:!0}),Zn=1}catch{}var ge="@based",Ce=ge+"-cache",Pe=ge+"-size",se=ge+"-authState";var Bn=new TextDecoder("utf-8"),Vn=new TextEncoder,Xn=e=>{let t=Bn.decode(pe(ct(e)));return JSON.parse(t)},bt=(e,t)=>{let n=localStorage.getItem(t);n&&(e.storageSize-=new Blob([n]).size,localStorage.setItem(Pe,String(e.storageSize)),localStorage.removeItem(t))},Je=()=>{let e=Object.keys(localStorage);try{for(let t of e)t.startsWith(ge)&&localStorage.removeItem(t)}catch{try{localStorage.clear()}catch{}}},Xt=(e,t,n)=>{try{let r=e.storageEnvKey;if(!r)return;let s=localStorage.getItem(t),o=JSON.stringify(n),a=o.length>70||t===se+"-"+r?$e(Fe(Vn.encode(o))):o,c=new Blob([a]).size;s&&(e.storageSize-=new Blob([s]).size),e.storageSize+=c,e.storageSize>e.maxStorageSize&&(Je(),e.storageSize=0,e.authState.persistent===!0&&Xt(e,se+"-"+r,e.authState),e.storageSize+=c),localStorage.setItem(Pe,String(e.storageSize)),localStorage.setItem(t,a)}catch(r){console.error(`Based - Error writing ${t} to localStorage`,r)}},Vt=(e,t)=>{let n=e.storageEnvKey;if(n)try{let r=localStorage.getItem(t);if(r!==void 0){if(r.length<70&&t!==se+"-"+n)try{return JSON.parse(r)}catch{}return Xn(r)}return}catch{}},Yn=async e=>{let t=e.storageEnvKey;if(!t)return;let n=window.__basedcache__??{};for(let r in n)e.cache.set(Number(r),n[r]);try{let r=Number(localStorage.getItem(Pe)||0);r<0&&(Je(),r=0),e.storageSize=r;let s=Object.keys(localStorage);if(s.length===1&&r>0&&(Je(),r=0),r>0)for(let o of s){if(o===Pe||!o.startsWith(ge))continue;if(o===se+"-"+t){let l=Vt(e,o);l&&e.setAuthState(l).catch(u=>{console.error(u.message),bt(e,o)});continue}let[,a]=o.split(Ce);if(!a)continue;let[i,c]=a.split("-");if(c!==String(t))continue;if(!i){bt(e,o);continue}let f=Vt(e,o);e.cache.set(Number(i),f)}}catch{}},me=(e,t)=>{let n=e.storageEnvKey;n&&(t+="-"+n,bt(e,t))},ae=(e,t,n)=>{let r=e.storageEnvKey;r&&(t+="-"+r,Xt(e,t,n))},wt=async(e,t)=>{},Yt=async e=>Yn(e),_t=async e=>Je();var de=(e,t)=>{t.persistent?ae(e,se,t):me(e,se),e.authState=t};var te=new TextEncoder,T=(e,t,n,r)=>{for(let s=n;s<n+r;s++){let o=t&255;e[s]=o,t=(t-o)/256}},_n=(e,t,n)=>{let r=(e<<1)+(t|0);return(n<<4)+r},B=(e,t,n,r=n)=>{let s=_n(e,t,n),o=new Uint8Array(r);return T(o,s,0,4),o},fe=(e,t=!1)=>{let n,r=!1;return e!==void 0?(n=te.encode(typeof e=="string"?e:JSON.stringify(e)),!t&&n.length>150&&(n=Fe(n),r=!0),[r,n]):[!1]},en=(e,t)=>{let n=4,[r,s,o,a]=t;if(r===3){let i=te.encode(s);n+=1+i.length;let[c,f]=fe(a);f&&(n+=f.length);let l=16;n+=l;let u=B(r,c,n,5+l);return T(u,e,4,8),T(u,o,12,8),u[20]=i.length,f?{buffers:[u,i,f],len:n}:{buffers:[u,i],len:n}}return{buffers:[],len:0}},Ke=(e,t)=>{let n=4,[r,s,o]=t;if(r===7){let u=B(r,!1,13);return T(u,0,4,1),T(u,e,5,8),{buffers:[u],len:13}}let a=te.encode(s);n+=1+a.length;let i=r===6,[,c]=fe(o,!0);c&&(n+=c.length);let f=8;n+=f;let l=B(5,i,n,5+f);return T(l,e,4,8),l[12]=a.length,c?{buffers:[l,a,c],len:n}:{buffers:[l,a],len:n}},tn=(e,t)=>{let n=4,[r,s,o,a]=t;if(r===2){let h=B(r,!1,12);return T(h,e,4,8),{buffers:[h],len:12}}let i=te.encode(s);n+=1+i.length;let[c,f]=fe(a);f&&(n+=f.length);let l=16;n+=l;let u=B(r,c,n,5+l);return T(u,e,4,8),T(u,o,12,8),u[20]=i.length,f?{buffers:[u,i,f],len:n}:{buffers:[u,i],len:n}},nn=e=>{let t=7,[n,r,s]=e,o=te.encode(r);t+=1+o.length;let[a,i]=fe(s);i&&(t+=i.length);let c=B(0,a,t,8);return T(c,n,4,3),c[7]=o.length,i?{buffers:[c,o,i],len:t}:{buffers:[c,o],len:t}},rn=e=>{let t=12,[n,r]=e,[s,o]=fe(r);o&&(t+=o.length);let a=B(6,s,t,12);return T(a,n,4,8),o?{buffers:[a,o],len:t}:{buffers:[a],len:t}},sn=e=>{let t=4,[n,r]=fe(e);r&&(t+=r.length);let s=B(4,n,t);return r&&s.set(r,4),s},xt=e=>{let[t,n]=e;if(t===1){let[,,r,s,o,a,i,c]=e,f=16,l=f,u=te.encode(s);l+=u.length;let[h,p]=fe(c);p&&(l+=p.length);let m=te.encode(o);l+=m.length;let g=te.encode(i);l+=g.length;let v=te.encode(a);l+=v.length;let y=B(7,h,l,f);return T(y,1,4,1),T(y,n,5,3),T(y,r,8,4),T(y,u.length,12,1),T(y,m.length,13,1),T(y,g.length,14,1),T(y,v.length,15,1),p?{buffers:[y,u,m,g,v,p],len:l}:{buffers:[y,u,m,g,v],len:l}}else if(t===2){let r=9,s=r,[,,o,a]=e,i=!1,c=a;a.length>150?(c=Fe(a),s+=c.length,i=!0):s+=a.length;let f=B(7,i,s,r);return T(f,2,4,1),T(f,n,5,3),T(f,o,8,1),{buffers:[f,c],len:s}}return{buffers:[],len:0}};var er=new Uint8Array(0),an=e=>{clearTimeout(e.idlePing),e.idlePing=setTimeout(()=>{e.connection&&e.connected&&!e.connection.disconnected&&e.connection.ws.send(er)},6e4)},on=e=>!!(e.fQ.length||e.oQ.size||e.gQ.size||e.cQ.size||e.pQ.length||e.sQ.length),G=e=>{if(e.connected&&!e.drainInProgress&&on(e)){e.drainInProgress=!0;let t=()=>{if(e.drainInProgress=!1,!!e.connected&&on(e)){let n=e.cQ,r=e.pQ,s=e.fQ,o=e.oQ,a=e.gQ,i=e.sQ,c=[],f=0;for(let[h,p]of n){let{buffers:m,len:g}=Ke(h,p);c.push(...m),f+=g}for(let[h,p]of a){let{buffers:m,len:g}=en(h,p);c.push(...m),f+=g}for(let[h,p]of o){let{buffers:m,len:g}=tn(h,p);c.push(...m),f+=g}for(let h of s){let{buffers:p,len:m}=nn(h);c.push(...p),f+=m}for(let h of r){let{buffers:p,len:m}=rn(h);c.push(...p),f+=m}for(let h of i){let{buffers:p,len:m}=xt(h);c.push(...p),f+=m}let l=new Uint8Array(f),u=0;for(let h of c)l.set(h,u),u+=h.length;e.fQ=[],e.pQ=[],e.sQ=[],e.oQ.clear(),e.gQ.clear(),e.cQ.clear(),e.connection.ws.send(l),an(e)}};e.drainTimeout=setTimeout(t,0)}};var De=(e,t,n,r,s)=>{e.requestId++,e.requestId>16777215&&(e.requestId=0);let o=e.requestId,a=Error().stack.split(/BasedClient\.function.+:\d\d\)/)[1];e.functionResponseListeners.set(o,[r,s,a]),e.fQ.push([o,n,t]),G(e)},fn=(e,t)=>{e.cQ.get(t)?.[0]!==7&&(e.cQ.set(t,[7]),G(e))},Ge=(e,t,n,r)=>{e.cQ.get(n)?.[0]!==5&&(e.cQ.set(n,[5,t,r]),G(e))},We=(e,t,n,r)=>{let s=e.cQ.get(n)?.[0];s===5||s===6||(e.cQ.set(n,[6,t,r]),G(e))},cn=(e,t,n)=>{e.pQ.length>e.maxPublishQueue&&e.pQ.shift(),e.pQ.push([t,n]),G(e)},ln=(e,t)=>{e.oQ.get(t)?.[0]!==2&&(e.oQ.set(t,[2]),G(e))},Ze=(e,t,n,r,s=0)=>{e.oQ.get(n)?.[0]!==1&&(e.oQ.set(n,[1,t,s,r]),G(e))},Be=(e,t,n,r,s=0)=>{e.gQ.has(n)||(e.gQ.set(n,[3,t,s,r]),G(e))},St=async(e,t)=>ie(t,e.authState)?(console.warn("[Based] Trying to send the same authState twice",e.authState),e.authRequest.inProgress?e.authRequest.promise:new Promise(n=>n({}))):(e.authRequest.inProgress&&(console.warn("[Based] Authentication still in progress - waiting until done"),await e.authRequest.promise),de(e,t),e.emit("authstate-change",e.authState),e.connected&&e.connection.ws.send(sn(t)),e.authRequest.promise=new Promise((n,r)=>{e.authRequest.inProgress=!0,e.authRequest.resolve=n,e.authRequest.reject=r}).finally(()=>{e.authRequest.resolve=null,e.authRequest.reject=null,e.authRequest.inProgress=!1}),e.authRequest.promise),un=(e,t,n,r,s,o,a,i)=>{e.sQ.push([1,t,n,r,s,o,a,i]),G(e)},hn=(e,t,n,r,s)=>{if(e.connected){let{len:o,buffers:a}=xt([2,t,n,r,s]),i=new Uint8Array(o),c=0;for(let f of a)i.set(f,c),c+=f.length;e.connection.ws.send(i),an(e)}else e.sQ.push([2,t,n,r,s])};var tr=e=>new Promise(t=>{e.addEventListener("loadend",n=>{t(new Uint8Array(e.result))})}),At=async(e,t,n,r)=>{if(!(n.contents instanceof File))throw new Error('File Contents has to be an instance of "File"');e.connected||await e.once("connect");let s=++e.streamRequestId;s>16777215&&(s=e.streamRequestId=0);let o=0;un(e,s,n.size,n.fileName,n.mimeType,n.extension,t,n.payload);let a=!(n.mimeType?/image|video|x-zip/i.test(n.mimeType):n.extension&&/(mp4|avi|mov|zip|jpg|jpeg|png|gif|mkv)/i.test(n.extension)),i=1e5,c=1e6*10,f=1e6*1,l=Math.min(f,n.size);n.size<f*5?l=Math.min(i,n.size):n.size>f*100&&(l=c);let u,h=()=>new Promise(v=>{u[2]=(y,z,x)=>{x&&(l=x),v({seqId:y,maxChunkSize:x,code:z})}});async function*p(v){let y=0;for(;y<v.size;){let z=Math.min(y+v.size,y+l),x=v.slice(y,z),O=new FileReader;O.readAsArrayBuffer(x);let M=await tr(O);o===255&&(o=0),hn(e,s,++o,M,a),await h(),y+=x.size,yield y}yield y}let m=Math.random().toString(16),g=()=>{console.error("CLIENT DC -> ABORT STREAM",Date.now(),m)};return e.once("disconnect",g),new Promise(async(v,y)=>{u=[v,y,()=>{}],e.streamFunctionResponseListeners.set(s,u);for await(let z of p(n.contents))r&&r(z/n.size,z);e.off("disconnect",g)})};var pn={streaming:!1},gn=async(e,t,n,r)=>{if(!(Nt(n)||kt(n))){if((n.contents instanceof ArrayBuffer||typeof n.contents=="string")&&(n.contents=new window.Blob([n.contents],{type:n.mimeType||"text/plain"})),Et(n))return n.size||(n.size=n.contents.size),At(e,t,n,r);if(n.contents instanceof window.Blob)return n.mimeType||(n.mimeType=n.contents.type),n.contents=new File([n.contents],n.fileName||"blob"),At(e,t,n,r);throw new Error(`Invalid opts for file api ${t} ${JSON.stringify(n,null,2)}`)}};var ve=null;typeof WebSocket<"u"?ve=WebSocket:typeof MozWebSocket<"u"?ve=MozWebSocket:typeof window<"u"||typeof window<"u"?ve=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(ve=self.WebSocket||self.MozWebSocket);var mn=ve;var ye=new Map,Ve;typeof document<"u"&&document.addEventListener("visibilitychange",function(){clearTimeout(Ve),document.hidden?Ve=setTimeout(()=>{ye.forEach(e=>{e(!1)})},3e4):ye.forEach(e=>{e(!0)})});var Tt=(e,t,n={destroy:()=>{ye.delete(n)}},r=0,s=!1)=>(Ft(t,o=>{setTimeout(()=>{if(n.disconnected)return;let a=!0;ye.set(n,f=>{n.disconnected||(!f&&a?e.functionResponseListeners.size||pn.streaming?(console.warn("Send to background - streams or functions in progress try again in 10 seconds..."),clearTimeout(Ve),Ve=setTimeout(()=>{ye.forEach(l=>{l(!1)})},1e4)):(console.warn("Send to background - close connection"),a=!1,e.onClose(),i.close()):!a&&f&&(ye.delete(n),Tt(e,t,n,0,!0)))});let i=n.ws=new mn(o,[Qt(e.authState)]),c=!1;i.binaryType="blob",i.addEventListener("error",f=>{f.message&&f.message.includes("401")&&(c=!0)}),i.addEventListener("message",f=>{e.onData(f)}),i.addEventListener("open",()=>{if(a){if(n.disconnected)return;r=100,s&&e.onReconnect(),e.onOpen()}}),i.addEventListener("close",()=>{if(a){if(n.disconnected)return;e.onClose(),Tt(e,t,n,c?5e3:Math.min(2500,r+~~(Math.random()*500)+100),!0)}})},r)}),n),dn=Tt;var zt=class{constructor(){Object.defineProperty(this,"listeners",{enumerable:!1,writable:!0})}listeners={};emit(t,n){if(this.listeners[t]){let r=this.listeners[t];for(let s=0,o=r.length;s<r.length;s++){let a=r[s];a(n),o>r.length&&r[s]!==a&&(s--,o=r.length)}}}on(t,n){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(n)}removeAllListeners(){this.listeners={}}once(t,n){if(!n)return new Promise(s=>{let o=a=>{s(a),this.off(t,o)};this.on(t,o)});let r=()=>{this.off(t,r),this.off(t,n)};this.on(t,n),this.on(t,r)}off(t,n){let r=this.listeners[t];if(r)if(!n)delete this.listeners[t];else{for(let s=0;s<r.length;s++)if(r[s]===n){r.splice(s,1);break}r.length===0&&delete this.listeners[t]}}},vn=zt;var yn=(e,t,n)=>{if(n.constructor===Array){let r=n[0];if(r===0)e[t]=n[1];else if(r===1)delete e[t];else if(r===2){let s=bn(e[t],n[1]);if(s===null)return null;e[t]=s}}else{if(n.___$toObject&&e[t]&&e[t].constructor===Array){let r={};for(let s=0;s<e[t].length;s++)r[s]=e[t][s];e[t]=r}if(e[t]===void 0)return console.warn("Diff apply patch: Cannot find key in original object",t,JSON.stringify(n,null,2)),null;for(let r in n)if(r!=="___$toObject"&&yn(e[t],r,n[r])===null)return null}},bn=(e,t)=>{let n=t.length,r=new Array(t[0]),s=-1,o=[],a={};for(let c=1;c<n;c++){let f=t[c],l=f[0];if(l===0)for(let u=1;u<f.length;u++)r[++s]=f[u];else if(l===1){let u=f[2],h=f[1]+u;for(let p=u;p<h;p++){let m=typeof e[p];if(m==="object"&&p in a){let g=Te(e[p]);r[++s]=g}else m==="object"&&(a[p]=!0),r[++s]=e[p]}}else if(l===2){let u=f[1],h=f.length-2+u;for(let p=u;p<h;p++){let m=[++s,p,f[p-u+2]];o.push(m)}}}let i=o.length;for(let c=0;c<i;c++){let[f,l,u]=o[c],h=l in a?Te(e[l]):e[l],p=wn(h,u);if(p===null)return null;r[f]=p}return r},wn=(e,t)=>{if(t)if(t.constructor===Array){let n=t[0];if(n===0)return t[1];if(n===1)return;if(n===2)return bn(e,t[1])}else{if(t.___$toObject&&e&&e.constructor===Array){let n={};for(let r=0;r<e.length;r++)n[r]=e[r];e=n}for(let n in t)if(n!=="___$toObject"&&yn(e,n,t[n])===null)return null;return e}else return e},It=wn;var xn=e=>{let t=e>>4,n=e&15,r=n>>1,s=n&1;return{type:r,isDeflate:s===1,len:t}},L=(e,t,n)=>{let r=0,s=n-1+t;for(let o=s;o>=t;o--)r=r*256+e[o];return r},Sn=async e=>{if(e instanceof ArrayBuffer)return new Uint8Array(e);if(typeof window>"u"){if(e instanceof Buffer)return new Uint8Array(e)}else if(e instanceof Blob){let t=await e.arrayBuffer();return new Uint8Array(t)}throw new Error("432")},Xe=(e,t)=>{let n=e.observeState.get(t);Be(e,n.name,t,n.payload)};var Ot=(e,t,n)=>{let r=n==="sub"?e.observeState.get(t):e.channelState.get(t);return r?r.payload?{name:r.name,payload:r.payload,id:t}:{name:r.name,id:t}:{name:`[Cannot find ${t}]`,id:t}};var Ye;(function(e){e[e.FunctionError=50001]="FunctionError",e[e.AuthorizeFunctionError=50002]="AuthorizeFunctionError",e[e.NoOservableCacheAvailable=50003]="NoOservableCacheAvailable",e[e.ObservableFunctionError=50004]="ObservableFunctionError",e[e.ObserveCallbackError=50005]="ObserveCallbackError",e[e.FunctionNotFound=40401]="FunctionNotFound",e[e.FunctionIsNotObservable=40402]="FunctionIsNotObservable",e[e.FunctionIsObservable=40403]="FunctionIsObservable",e[e.FunctionIsStream=40404]="FunctionIsStream",e[e.CannotStreamToObservableFunction=40405]="CannotStreamToObservableFunction",e[e.AuthorizeRejectedError=40301]="AuthorizeRejectedError",e[e.InvalidPayload=40001]="InvalidPayload",e[e.PayloadTooLarge=40002]="PayloadTooLarge",e[e.ChunkTooLarge=40003]="ChunkTooLarge",e[e.UnsupportedContentEncoding=40004]="UnsupportedContentEncoding",e[e.NoBinaryProtocol=40005]="NoBinaryProtocol",e[e.LengthRequired=41101]="LengthRequired",e[e.MethodNotAllowed=40501]="MethodNotAllowed",e[e.RateLimit=40029]="RateLimit",e[e.MissingAuthStateProtocolHeader=40030]="MissingAuthStateProtocolHeader",e[e.IncorrectAccessKey=40031]="IncorrectAccessKey"})(Ye||(Ye={}));var _e=class extends Error{statusMessage;code},be=(e,t)=>{if(!e||typeof e!="object"){let a=new _e(`Payload: ${e}`);return a.name="Invalid returned payload",a}let{message:n,code:r}=e,s=n?n[0]==="["?n:`[${Ye[r]}] `+n:r?"Cannot read error msg":JSON.stringify(e,null,2),o=new _e(s);return o.stack=t?s+" "+t:s,o.name=Ye[r],o.code=r,o};var we=e=>{e.cache.forEach((t,n)=>{e.observeState.has(n)||(e.cacheSize-=t.s,e.cache.delete(n),me(e,String(n)))})};var Le=(e,t,n,r)=>new TextDecoder().decode(n?pe(r.slice(e,t)):r.slice(e,t)),An=async(e,t)=>{if(!e.isDestroyed)try{let n=t.data,r=await Sn(n),{type:s,len:o,isDeflate:a}=xn(L(r,0,4));if(s===0){let i=L(r,4,3),c=7,f=o+4,l;o!==3&&(l=JSON.parse(Le(c,f,a,r))),e.functionResponseListeners.has(i)&&(e.functionResponseListeners.get(i)[0](l),e.functionResponseListeners.delete(i))}else if(s===3){let i=L(r,4,8);if(e.getState.has(i)&&e.cache.has(i)){let c=e.getState.get(i);for(let[f]of c)f(e.cache.get(i).v);e.getState.delete(i)}}else if(s===2){let i=L(r,4,8),c=e.cache.get(i);if(!c){Xe(e,i);return}let f=L(r,12,8),l=L(r,20,8);if(c.c!==l){Xe(e,i);return}let u=28,h=o+4,p,m=0;if(o!==24){let g=a?pe(r.slice(u,h)):r.slice(u,h);m=g.byteLength,p=JSON.parse(new TextDecoder().decode(g))}try{m>c.s&&(e.cacheSize-=c.s,e.cacheSize+=m,c.s=m),c.v=It(c.v,p),c.c=f}catch{Xe(e,i);return}if(e.observeState.has(i)){let g=e.observeState.get(i);g.persistent&&(c.p=!0,ae(e,Ce+i,c));for(let[,v]of g.subscribers)v.onData(c.v,f)}if(e.getState.has(i)){let g=e.getState.get(i);for(let[v]of g)v(c.v);e.getState.delete(i)}}else if(s===1){let i=L(r,4,8),c=L(r,12,8),f=20,l=o+4,u,h=0;if(o!==16){let g=a?pe(r.slice(f,l)):r.slice(f,l);h=g.byteLength,u=JSON.parse(new TextDecoder().decode(g))}let p=e.cache.get(i);if(!(p?.c===c)){e.cacheSize+=h,p&&p.s&&(e.cacheSize-=p.s),e.cacheSize>e.maxCacheSize&&we(e);let g={v:u,c,s:h};if(e.cache.set(i,g),e.observeState.has(i)){let v=e.observeState.get(i);v.persistent&&(g.p=!0,ae(e,Ce+i,g));for(let[,y]of v.subscribers)y.onData(u,c)}}if(e.getState.has(i)){let g=e.getState.get(i);for(let[v]of g)v(u);e.getState.delete(i)}}else if(s===4){let c=o+4,f;o!==3&&(f=JSON.parse(Le(4,c,a,r))),f===!0?e.authRequest.resolve?.(e.authState):"error"in f?(de(e,f),e.emit("authstate-change",e.authState),e.authRequest.reject?.(new Error(f.error))):(ie(e.authState,f)?de(e,f):(de(e,f),e.emit("authstate-change",e.authState)),e.authRequest?.resolve?.(e.authState))}else if(s===5){let c=o+4,f;if(o!==3&&(f=JSON.parse(Le(4,c,a,r))),f.streamRequestId&&e.streamFunctionResponseListeners.has(f.streamRequestId)){let[,l]=e.streamFunctionResponseListeners.get(f.streamRequestId);l(be(f)),e.streamFunctionResponseListeners.delete(f.streamRequestId)}if(f.requestId&&e.functionResponseListeners.has(f.requestId)){let[,l,u]=e.functionResponseListeners.get(f.requestId);l(be(f,u)),e.functionResponseListeners.delete(f.requestId)}if(f.channelId&&e.channelState.has(f.channelId)){let l=be(f),u=e.channelState.get(f.channelId);for(let[,h]of u.subscribers)h.onError?h.onError(l):console.error(Ot(e,f.channelId,"channel"),l)}if(f.observableId){if(e.cache.delete(f.observableId),e.observeState.has(f.observableId)){let l=be(f),u=e.observeState.get(f.observableId);for(let[,h]of u.subscribers)h.onError?h.onError(l):console.error(Ot(e,f.observableId,"sub"),l)}if(e.getState.has(f.observableId)){let l=be(f),u=e.getState.get(f.observableId);for(let[,h]of u)h(l);e.getState.delete(f.observableId)}}}else if(s===6){let i=L(r,4,8),c=e.channelState.get(i);if(i){if(!c.inTransit){c.inTransit=!0;let{buffers:f,len:l}=Ke(i,[6,c.name,c.payload]),u=new Uint8Array(l),h=0;for(let p of f)u.set(p,h),h+=p.length;e.connection.ws.send(u),c.removeTimer!==-1&&c.removeTimer<2&&(c.removeTimer+=1),setTimeout(()=>{let p=e.channelState.get(i);p&&(p.inTransit=!1)},5e3)}e.connection.ws.send(r)}}else if(s===7){let i=L(r,4,1);if(i===0){let c=L(r,5,8),f=13,l=o+5,u;if(o!==9){let h=Le(f,l,a,r);try{u=JSON.parse(h)}catch{u=h}}if(e.channelState.has(c)){let h=e.channelState.get(c);for(let[,p]of h.subscribers)p.onMessage(u)}}else if(i===1){let c=L(r,5,3),f=8,l=o+4,u;o!==4&&(u=JSON.parse(Le(f,l,a,r))),e.streamFunctionResponseListeners.has(c)&&(e.streamFunctionResponseListeners.get(c)[0](u),e.streamFunctionResponseListeners.delete(c))}else if(i===2){let c=L(r,5,3),f=L(r,8,1),l=L(r,9,1),u=0;o>10-4&&(u=L(r,10,o-6),console.log("more data",u)),e.streamFunctionResponseListeners.has(c)&&e.streamFunctionResponseListeners.get(c)[2](f,l,u)}}}catch(n){console.error(981,n)}};var et=(e,t)=>t===void 0?Ie(e):X([e,t]);var tt=class{id;query;name;client;persistent;constructor(t,n,r,s){this.query=r,this.id=et(n,r),this.client=t,this.name=n,this.persistent=s?.persistent||!1}get cache(){return this.client.cache.get(this.id)||null}clearCache(){this.persistent&&me(this.client,"@based-cache-"+this.id),this.client.cache.delete(this.id)}subscribe(t,n){let r,s=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){let o=this.client.observeState.get(this.id);this.persistent&&!o.persistent&&(o.persistent=!0,s&&ae(this.client,"@based-cache-"+this.id,s)),r=++o.idCnt,o.subscribers.set(r,{onError:n,onData:t})}else{r=1;let o=new Map;o.set(r,{onError:n,onData:t}),this.client.observeState.set(this.id,{payload:this.query,name:this.name,subscribers:o,persistent:this.persistent||!1,idCnt:1}),Ze(this.client,this.name,this.id,this.query,s?.c||0)}return s&&t(s.v,s.c),()=>{let o=this.client.observeState.get(this.id);o?(o.subscribers.delete(r),o.subscribers.size===0&&(this.client.observeState.delete(this.id),this.client.cacheSize>this.client.maxCacheSize&&we(this.client),ln(this.client,this.id))):console.warn("Subscription allready removed",this.query,this.name)}}async getWhen(t){return new Promise(n=>{let r=this.subscribe((s,o)=>{t(s,o)&&(n(s),r())})})}async get(){return new Promise((t,n)=>{if(this.client.getState.has(this.id)){this.client.getState.get(this.id).push([t,n]);return}let r=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){if(this.client.oQ.has(this.id)){let[s]=this.client.oQ.get(this.id);if(s===1){this.client.getState.set(this.id,[[t,n]]);return}}if(r){t(r.v);return}}this.client.getState.set(this.id,[[t,n]]),Be(this.client,this.name,this.id,this.query,r?.c||0)})}};var Re=e=>{e.channelCleanTimeout||(e.channelCleanTimeout=setTimeout(()=>{if(e.channelCleanTimeout=null,e.connected){let t=!1;e.channelState.forEach((n,r)=>{n.removeTimer!==-1&&(n.removeTimer--,n.removeTimer===0?e.channelState.delete(r):t=!0)}),t&&Re(e)}else Re(e)},e.channelCleanupCycle))};var nt=class{id;payload;name;client;constructor(t,n,r){this.payload=r,this.id=et(n,r),this.client=t,this.name=n}subscribe(t,n){let r;if(!this.client.channelState.has(this.id)||this.client.channelState.get(this.id).subscribers.size===0){r=1;let s=new Map;s.set(r,{onMessage:t,onError:n}),this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:s,removeTimer:-1,idCnt:1}),Ge(this.client,this.name,this.id,this.payload)}else{let s=this.client.channelState.get(this.id);s.removeTimer=-1,r=++s.idCnt,s.subscribers.set(r,{onMessage:t,onError:n})}return()=>{let s=this.client.channelState.get(this.id);s.subscribers.delete(r),s.subscribers.size===0&&(s.removeTimer=2,fn(this.client,this.id))}}publish(t){if(!this.client.channelState.has(this.id))this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:new Map,removeTimer:2,idCnt:0}),Re(this.client),We(this.client,this.name,this.id,this.payload);else{let n=this.client.channelState.get(this.id);n.removeTimer!==-1&&n.removeTimer<2&&(n.removeTimer=2,Re(this.client))}cn(this.client,this.id,t)}};var Tn=fetch;var nr=(e,t,n,r,s="allServices",o=0)=>(a=>{let i=5381,c=a.length;for(;c;)i=33*i^a.charCodeAt(--c);let f=i>>>0;for(;f>65535;)f/=10;return Math.round(f)})(`${s}-${e}-${t}-${n}-${r}-${o}`),In=e=>e||"@based/env-hub",zn=/^ws/,rr={"@based/env-hub":0,"@based/env-admin-hub":1,"@based/admin-hub":2,"@based/machine-hub":3},sr=e=>{let t=rr[In(e.name)]+""+Math.floor(1e4*Math.random());return e.key?t+"/"+(e.optionalKey?e.key+"$":e.key):t},or=async(e,t,n)=>{try{let r=await Tn(`${e}/status/${sr(t)}`,{headers:t.headers});if(r.ok){let s=r.headers.get("x-request-id");if(!s)return 1;let{decode:o}=ke(ir,s.slice(0,6).split("")),a=o(s.slice(6)).split(","),i=[];for(let u=0;u<Math.floor(a.length/2);u++)i.push([a[u],encodeURIComponent(a[a.length-1-u])]);let[c,f]=i[~~(Math.random()*i.length)],l=/^https/.test(e)?"s":"";return n?`http${l}://${c}`:`ws${l}://${c}/${f}`}return!1}catch{return!1}},On=async(e,t=!1,n=0)=>{if(e.url){let s;return s=typeof e.url=="function"?await e.url():e.url,t&&s&&zn.test(s)?s.replace(zn,"http"):s}let r=e.discoveryUrls||(({cluster:s="production",org:o,project:a,env:i,name:c})=>s==="local"?[`http://localhost:${nr(o,a,i,In(c).includes("env-")?"@based/env-hub-discovery":"@based/hub-discovery","allServices")}`]:[`https://${X({org:o,project:a,env:i,cluster:s}).toString(36)}-status.based.dev`])(e);for(let s=0;s<r.length;s++){let o=r[s],a=await Promise.race([or(o,e,t),Ne(3e3)]);if(a===1||!a&&s===r.length-1)return await Ne(Math.min(n*n*50+500,5e3)),On(e,t,++n);if(a)return a}},ir=[",",".based.dev","localhost:","localhost","based.io","based.dev","@based","/env-hub","admin","hub","900","90","443","80",":","%","/","=","<","?","."],ar=On,Mn=async(e,t)=>ar(e,t);typeof window<"u"&&typeof window>"u"&&(window.global=window);var Mt=class extends vn{constructor(t,n){super(),n?.persistentStorage&&(this.storagePath=n.persistentStorage),n?.maxCacheSize&&(console.warn("MaxCacheSize setting not implemented yet..."),this.maxCacheSize=n.maxCacheSize),t&&this.connect(t)}storageSize=0;maxStorageSize=5e6-500;storageEnvKey=0;storagePath;storageBeingWritten;opts;connected=!1;connection;url;outgoingStreams=new Map;isDrainingStreams=!1;maxPublishQueue=1e3;pQ=[];fQ=[];sQ=[];oQ=new Map;cQ=new Map;gQ=new Map;drainInProgress=!1;drainTimeout;idlePing;cacheSize=0;localStorage=!1;maxCacheSize=5e7;cache=new Map;functionResponseListeners=new Map;requestId=0;channelState=new Map;channelCleanTimeout;channelCleanupCycle=3e4;observeState=new Map;getState=new Map;authState={};authRequest={authState:null,promise:null,resolve:null,reject:null,inProgress:!1};streamFunctionResponseListeners=new Map;streamRequestId=0;clearUnusedCache(){we(this)}onClose(){this.connected=!1,this.functionResponseListeners.size>this.fQ.length&&this.functionResponseListeners.forEach((t,n)=>{this.fQ.find(([r])=>r===n)||(t[1](new Error("Server disconnected before function result was processed")),this.functionResponseListeners.delete(n))}),this.emit("disconnect",!0)}onReconnect(){this.connected=!0,this.emit("reconnect",!0)}onOpen(){this.connected=!0,this.emit("connect",!0);for(let[t,n]of this.observeState)if(!this.oQ.has(t)){let r=this.cache.get(t);Ze(this,n.name,t,n.payload,r?.c||0)}for(let[t,n]of this.channelState)this.cQ.has(t)||(n.subscribers.size?Ge(this,n.name,t,n.payload):We(this,n.name,t,n.payload));G(this)}onData(t){An(this,t)}async connect(t){if(t&&Object.keys(t).length>0){if(this.opts){if(ie(this.opts,t))return;this.disconnect()}this.opts=t,this.url=()=>Mn(t),this.storageEnvKey=X(t),Yt(this)}if(!this.opts){console.error("Configure opts to connect");return}this.url&&!this.connection&&(this.connection=dn(this,this.url))}disconnect(){this.connection&&(this.connection.disconnected=!0,this.connection.destroy(),this.connection.ws&&this.connection.ws.close(),this.connected&&this.onClose(),delete this.connection),clearTimeout(this.drainTimeout),clearTimeout(this.idlePing),this.connected=!1}isDestroyed;async destroy(t){t||await wt(this,!0),clearTimeout(this.storageBeingWritten),clearTimeout(this.channelCleanTimeout),this.disconnect();for(let n in this)delete this[n];this.isDestroyed=!0}channel(t,n){return new nt(this,t,n)}query(t,n,r){return new tt(this,t,n,r)}call(t,n,r){let s=r?.retryStrategy;return s?new Promise(o=>{let a=0,i=0,c=f=>{let l=s(f,a,i);i++,typeof l=="number"&&!isNaN(l)&&(a=l,l===0?De(this,n,t,o,c):setTimeout(()=>{De(this,n,t,o,c)},l))};return De(this,n,t,o,c)}):new Promise((o,a)=>De(this,n,t,o,a))}stream(t,n,r){return gn(this,t,n,r)}setAuthState(t){if(typeof t=="object")return St(this,t);throw new Error("Invalid auth() arguments")}clearAuthState(){return St(this,{})}clearStorage(){return _t(this)}saveStorage(){return wt(this)}};function jt(e,t){return new Mt(e,t)}var oe=jt({url:"ws://localhost:9910"}),jn=!1;oe.query("meta").subscribe((e,t)=>{jn&&window.location.reload(),jn=!0},e=>{console.error("??")});var fr=()=>{let e=document.body,t=document.createElement("button");t.innerHTML="LOGIN",t.onclick=()=>{oe.call("login",{name:"x",password:"x"})},e.appendChild(t);let n=document.createElement("button");n.innerHTML="LOGOUT",n.onclick=()=>{oe.setAuthState({})},e.appendChild(n);let r=document.createElement("input");r.type="file",r.onchange=async i=>{console.log("|--->",i.target.files[0]);let c=await oe.stream("flap",{contents:i.target.files[0]});console.info("READY",{x:c})},e.appendChild(r);let s=document.createElement("button");s.onclick=async i=>{let c=await oe.stream("flap",{contents:"flap"});console.info("READY",{x:c})},s.innerHTML="blap",e.appendChild(s);let o=document.createElement("div");e.appendChild(o);let a=document.createElement("pre");e.appendChild(a),oe.on("connect",i=>{o.innerHTML+="<div>CONNECT: true</div>"}),oe.query("counter").subscribe(i=>{o.innerHTML=`<span>cnt: ${i}</span>`},i=>{console.error(i)}),oe.query("meta").subscribe((i,c)=>{let f=Object.keys(Object.values(i.outputs)[0].inputs),l=Object.values(Object.values(i.outputs)[0].inputs).map((u,h)=>({key:f[h],bytes:u.bytesInOutput})).filter(u=>u.key!=="test/browser/index.ts").sort((u,h)=>u.bytes>h.bytes?-1:1);o.innerHTML+=`<div>bytes ${l.reduce((u,h)=>u+h.bytes,0)}</div>`,a.innerHTML=JSON.stringify(l,null,2)})};fr();})();
