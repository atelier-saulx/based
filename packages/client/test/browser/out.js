(()=>{var Lt=(e,t)=>{typeof e=="function"?e().then(r=>{t(r)}):t(e)};var Nt=e=>{let t=Array.isArray(e)?[]:{};for(let r in e)e[r]!==null&&typeof e[r]=="object"?t[r]=Nt(e[r]):t[r]=e[r];return t},Te=Nt;var Re=(e=100)=>new Promise(t=>{setTimeout(()=>t(),e)});var ut=(e,t)=>{let r=typeof e,n=typeof t;if(e===t)return!0;if(r!==n||e===null||t===null)return!1;if(r!=="object"){if(r==="function"){if(e.toString()!==t.toString())return!1}else if(e!==t)return!1}else{if(Array.isArray(e))if(Array.isArray(t)){let s=e.length;if(s!==t.length)return!1;for(let a=0;a<s;a++){let i=typeof e[a];if(typeof t[a]!==i)return!1;if(i==="object"&&!ut(e[a],t[a]))return!1}}else return!1;if(e.checksum||t.checksum)return e.checksum===t.checksum;let o=0;for(let s in e){if(s[0]==="_"||!e.hasOwnProperty(s))continue;if(!t.hasOwnProperty(s))return!1;let a=t[s],i=e[s];if(a===void 0&&i!==void 0)return!1;let c=typeof a;if(c!==typeof i)return!1;if(a&&c==="object"){if(!ut(i,a))return!1}else if(a!==i)return!1;o++}for(let s in t)if(o--,o<0)return!1}return!0},se=ut;var Mr=(e,t=5381)=>{let r=e.length;for(;r;){let n=e.charCodeAt(--r);t=t*33^n}return t},I=Mr;var le=(e,t,r,n,o)=>{let s=typeof n,a="";if(s==="string")a=r+":"+n;else if(s==="number")a=r+"n:"+n;else if(s==="object")if(n===null)a=r+"v:null";else{let i=o(n,e,t);return[I(r+"o:",i[0]),I(r+"o:",i[1])]}else s==="boolean"&&(a=r+"b:"+(n?"true":"false"));return[I(a,e),I(a,t)]};var ht=(e,t=5381,r=52711)=>{if(Array.isArray(e))for(let n=0;n<e.length;n++){let o=le(t,r,n,e[n],ht);t=o[0],r=o[1]}else for(let n in e){if(n===void 0)continue;let o=le(t,r,n,e[n],ht);t=o[0],r=o[1]}return[t,r]},pt=ht;var Pr=e=>{let t=pt(e);return(t[0]>>>0)*4096+t[1]},Oe=Pr;var Fr=(e,t)=>{let r;if(typeof e=="object"?e===null?r=0:r=Oe(e):typeof e=="boolean"?r=e?792222265344:4821552340992:typeof e=="number"?r=(I("n:"+e)>>>0)*4096+(I("n:"+e,52711)>>>0):r=(I(e)>>>0)*4096+(I(e,52711)>>>0),t){let n=Math.ceil(Math.log10(r+1));if(n<t)return r*Math.pow(10,t-n)}return r},ze=Fr;var gt=(e,t=5381,r=52711)=>{if(Array.isArray(e)){let n="__len:"+e.length+1;t=I(n,t),r=I(n,r);for(let o=0;o<e.length;o++){let s=e[o],a=le(t,r,o,s,gt);t=a[0],r=a[1]}}else{let n=Object.keys(e).sort(),o="__len:"+n.length+1;t=I(o,t),r=I(o,r);for(let s=0;s<n.length;s++){let a=n[s];if(a===void 0)continue;let i=e[a],c=le(t,r,a,i,gt);t=c[0],r=c[1]}}return[t,r]},vt=gt;var Cr=e=>{let t=vt(e);return(t[0]>>>0)*4096+(t[1]>>>0)},X=Cr;var Rt=(e,t,r)=>{let n=e.length;for(let o=0;o<t-n;o++)e=r+e;return e};var kt=(e,t,r=["$"],n)=>{if(r.length>1&&e)return s=>{let a="";for(let i=0;i<s.length;i++){let c=s[i];if(r.includes(c)){let f="";for(let u=0;u<t;u++)f+=s[i+u+1];let l=n[f];a+=l,i+=t}else a+=c}return a};if(r.length>1)return s=>{let a="";for(let i=0;i<s.length;i++){let c=s[i];if(r.includes(c)){let f=n[s[i+1]];a+=f,i++}else a+=c}return a};let o=r[0];return e?s=>{let a="";for(let i=0;i<s.length;i++){let c=s[i];if(c===o){let f="";for(let u=0;u<t;u++)f+=s[i+u+1];let l=n[f];a+=l,i+=t}else a+=c}return a}:s=>{let a="";for(let i=0;i<s.length;i++){let c=s[i];if(c===o){let f=n[s[i+1]];a+=f,i++}else a+=c}return a}};var Ut=(e,t)=>t%2?e[e.length-t]:e[t],$t=(e,t,r)=>{if(r.length>1&&e===1){let n=r.length;return o=>{let s=0,a="";for(let i=0;i<o.length;i++){let c=o.charAt(i);t[c]?(s+=1,s>=n&&(s=0),a+=Ut(r,s)+t[c]):a+=c}return a}}if(r.length>1){let n=r.length;return o=>{let s=0,a="";for(let i=0;i<o.length;i++){let c=!1;for(let f=e-1;f>-1;f--){if(i+f>o.length-1)continue;let l="";for(let u=0;u<f+1;u++)l+=o.charAt(i+u);t[l]&&(s+=1,s>=n&&(s=0),a+=Ut(r,s)+t[l],i+=l.length-1,f=-1,c=!0)}c||(a+=o.charAt(i))}return a}}return e===1?n=>{let o="";for(let s=0;s<n.length;s++){let a=n.charAt(s);t[a]?o+=t[a]:o+=a}return o}:n=>{let o="";for(let s=0;s<n.length;s++){let a=!1;for(let i=e-1;i>-1;i--){if(s+i>n.length-1)continue;let c="";for(let f=0;f<i+1;f++)c+=n.charAt(s+f);t[c]&&(o+=t[c],s+=c.length-1,i=-1,a=!0)}a||(o+=n.charAt(s))}return o}};var ke=(e,t=["$"])=>{let r=1,n=e.length>36,o=[...e,...t],s=o.map((f,l)=>(f.length>r&&(r=f.length),l>25?String(l-26):String.fromCharCode(97+l))),a={},i={};for(let f=0;f<o.length;f++)a[o[f]]=t.length===1?t[0]+s[f]:s[f],i[s[f]]=o[f];let c=1;if(n){for(let f in i)f.length>c&&(c=f.length);for(let f in i)if(f.length<c){let l=Rt(f,c,"0"),u=i[f];t.length>1?a[u]=l:a[u]=t[0]+l,delete i[f],i[l]=u}}return{charMap:a,reverseCharMap:i,encode:$t(r,a,t),decode:kt(n,c,t,i)}};var Dr=e=>{let t=[];for(let r in e){let n=e[r];n===!0?t.push(`${r}`):t.push(`${r}=${Ue(n,!0)}`)}return t.join("&")},Ue=(e,t=!1)=>typeof e=="string"?e:typeof e=="boolean"?e?"true":"false":typeof e=="number"||typeof e=="number"?String(e):e===null?"null":Array.isArray(e)?e.map(r=>typeof r=="object"&&r!==null?JSON.stringify(r):Ue(r,!0)).join(","):typeof e=="object"?t?JSON.stringify(e):Dr(e):"";var Qr=e=>e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0,$e=e=>e<26?e+65:e<52?e+71:e<62?e-4:e===62?43:e===63?47:65,mt=(e,t)=>{let r=e.replace(/[^A-Za-z0-9+/]/g,""),n=r.length,o=t?Math.ceil((n*3+1>>2)/t)*t:n*3+1>>2,s=new Uint8Array(o),a,i,c=0,f=0;for(let l=0;l<n;l++)if(i=l&3,c|=Qr(r.charCodeAt(l))<<6*(3-i),i===3||n-l===1){for(a=0;a<3&&f<o;)s[f]=c>>>(16>>>a&24)&255,a++,f++;c=0}return s},He=e=>{let t=2,r="",n=e.length,o=0;for(let s=0;s<n;s++)t=s%3,o|=e[s]<<(16>>>t&24),(t===2||e.length-s===1)&&(r+=String.fromCodePoint($e(o>>>18&63),$e(o>>>12&63),$e(o>>>6&63),$e(o&63)),o=0);return r.substring(0,r.length-2+t)+(t===2?"":t===1?"=":"==")};var{encode:Er,decode:Lo}=ke(["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," "],["0"]),ue=e=>Er(He(new TextEncoder().encode(JSON.stringify(e))));var qe=fetch;var Lr=(e,t,r,n,o="allServices",s=0)=>(a=>{let i=5381,c=a.length;for(;c;)i=33*i^a.charCodeAt(--c);let f=i>>>0;for(;f>65535;)f/=10;return Math.round(f)})(`${o}-${e}-${t}-${r}-${n}-${s}`),qt=e=>e||"@based/env-hub",Ht=/^ws/,Nr={"@based/env-hub":0,"@based/env-admin-hub":1,"@based/admin-hub":2,"@based/machine-hub":3},Rr=e=>{let t=Nr[qt(e.name)]+""+Math.floor(1e4*Math.random());return e.key?t+"/"+(e.optionalKey?e.key+"$":e.key):t},kr=async(e,t,r)=>{try{let n=await qe(`${e}/status/${Rr(t)}`,{headers:t.headers});if(n.ok){let o=n.headers.get("x-request-id");if(!o)return 1;let{decode:s}=ke(Ur,o.slice(0,6).split("")),a=s(o.slice(6)).split(","),i=[];for(let u=0;u<Math.floor(a.length/2);u++)i.push([a[u],encodeURIComponent(a[a.length-1-u])]);let[c,f]=i[~~(Math.random()*i.length)],l=/^https/.test(e)?"s":"";return r?`http${l}://${c}`:`ws${l}://${c}/${f}`}return!1}catch{return!1}},Jt=async(e,t=!1,r=0)=>{if(e.url){let o;return o=typeof e.url=="function"?await e.url():e.url,t&&o&&Ht.test(o)?o.replace(Ht,"http"):o}let n=e.discoveryUrls||(({cluster:o="production",org:s,project:a,env:i,name:c})=>o==="local"?[`http://localhost:${Lr(s,a,i,qt(c).includes("env-")?"@based/env-hub-discovery":"@based/hub-discovery","allServices")}`]:[`https://${X({org:s,project:a,env:i,cluster:o}).toString(36)}-status.based.dev`])(e);for(let o=0;o<n.length;o++){let s=n[o],a=await Promise.race([kr(s,e,t),Re(3e3)]);if(a===1||!a&&o===n.length-1)return await Re(Math.min(r*r*50+500,5e3)),Jt(e,t,++r);if(a)return a}},Ur=[",",".based.dev","localhost:","localhost","based.io","based.dev","@based","/env-hub","admin","hub","900","90","443","80",":","%","/","=","<","?","."],$r=Jt,he=async(e,t)=>$r(e,t);var pe;(function(e){e[e.FunctionError=50001]="FunctionError",e[e.AuthorizeFunctionError=50002]="AuthorizeFunctionError",e[e.NoOservableCacheAvailable=50003]="NoOservableCacheAvailable",e[e.ObservableFunctionError=50004]="ObservableFunctionError",e[e.ObserveCallbackError=50005]="ObserveCallbackError",e[e.FunctionNotFound=40401]="FunctionNotFound",e[e.FunctionIsNotObservable=40402]="FunctionIsNotObservable",e[e.FunctionIsObservable=40403]="FunctionIsObservable",e[e.FunctionIsStream=40404]="FunctionIsStream",e[e.CannotStreamToObservableFunction=40405]="CannotStreamToObservableFunction",e[e.AuthorizeRejectedError=40301]="AuthorizeRejectedError",e[e.InvalidPayload=40001]="InvalidPayload",e[e.PayloadTooLarge=40002]="PayloadTooLarge",e[e.ChunkTooLarge=40003]="ChunkTooLarge",e[e.UnsupportedContentEncoding=40004]="UnsupportedContentEncoding",e[e.NoBinaryProtocol=40005]="NoBinaryProtocol",e[e.LengthRequired=41101]="LengthRequired",e[e.MethodNotAllowed=40501]="MethodNotAllowed",e[e.RateLimit=40029]="RateLimit",e[e.MissingAuthStateProtocolHeader=40030]="MissingAuthStateProtocolHeader",e[e.IncorrectAccessKey=40031]="IncorrectAccessKey"})(pe||(pe={}));var Je=class extends Error{statusMessage;code},te=(e,t)=>{if(!e||typeof e!="object"){let a=new Je(`Payload: ${e}`);return a.name="Invalid returned payload",a}let{message:r,code:n}=e,o=r?r[0]==="["?r:`[${pe[n]}] `+r:n?"Cannot read error msg":JSON.stringify(e,null,2),s=new Je(o);return s.stack=t?o+" "+t:o,s.name=pe[n],s.code=n,s};var dt={},Ge={streaming:!1},Ie={},Ke=(e,t)=>{t.forEach(r=>{r.reject(e)})},Hr=(e,t,r)=>{dt[t]||(dt[t]=!0,Ge.streaming=!0,setTimeout(async()=>{dt[t]=!1;let n=await he(e.opts,!0),o=Ie[t];Ie[t]=[];let s=new window.FormData;for(let a=0;a<o.length;a++){let i=o[a].options,{contents:c,payload:f}=i,l=f||{};s.append(`size=${c.size},${JSON.stringify(l)}`,c)}try{let a=new window.XMLHttpRequest;a.upload.onprogress=i=>{let c=(i.loaded||i.position)/(i.totalSize||i.total);o.forEach(f=>{f.progressListener&&f.progressListener(c,o.length)})},a.onerror=i=>{if(console.error("Based xhr error",i),a.status===0&&!a.statusText){let c=te({message:`[${t}] XHR Error`,code:pe.FunctionError});Ke(c,o)}else console.error(i)},a.timeout=1e3*60*60*24,a.onabort=()=>{let i=new Error("File upload aborted before it finished");Ke(i,o)},a.ontimeout=()=>{console.error("on timeout")},a.onload=()=>{try{let i=JSON.parse(a.response);for(let c=0;c<i.length;c++){let f=i[c];f.error?o[c].reject(te(f.error)):o[c].resolve(i[c].value)}}catch(i){Ke(i,o)}Ge.streaming=!1},a.open("POST",n+"/"+t,!0),a.setRequestHeader("Content-Type","multipart/form-data"),a.setRequestHeader("Authorization",r),a.send(s)}catch(a){console.warn("Something unexpected happened with file upload",a),Ke(a,o)}},500))},Kt=async(e,t,r,n)=>(e.connected||await e.once("connect"),Ie[t]||(Ie[t]=[]),new Promise((o,s)=>{Ie[t].push({options:r,resolve:o,reject:s,progressListener:n}),Hr(e,t,ue(e.authState))}));var ge=null;typeof WebSocket<"u"?ge=WebSocket:typeof MozWebSocket<"u"?ge=MozWebSocket:typeof window<"u"||typeof window<"u"?ge=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(ge=self.WebSocket||self.MozWebSocket);var Gt=ge;var ve=new Map,Ze;typeof document<"u"&&document.addEventListener("visibilitychange",function(){clearTimeout(Ze),document.hidden?Ze=setTimeout(()=>{ve.forEach(e=>{e(!1)})},3e4):ve.forEach(e=>{e(!0)})});var yt=(e,t,r={destroy:()=>{ve.delete(r)}},n=0,o=!1)=>(Lt(t,s=>{setTimeout(()=>{if(r.disconnected)return;let a=!0;ve.set(r,f=>{r.disconnected||(!f&&a?e.functionResponseListeners.size||Ge.streaming?(console.warn("Send to background - streams or functions in progress try again in 10 seconds..."),clearTimeout(Ze),Ze=setTimeout(()=>{ve.forEach(l=>{l(!1)})},1e4)):(console.warn("Send to background - close connection"),a=!1,e.onClose(),i.close()):!a&&f&&(ve.delete(r),yt(e,t,r,0,!0)))});let i=r.ws=new Gt(s,[ue(e.authState)]),c=!1;i.binaryType="blob",i.addEventListener("error",f=>{f.message&&f.message.includes("401")&&(c=!0)}),i.addEventListener("message",f=>{e.onData(f)}),i.addEventListener("open",()=>{if(a){if(r.disconnected)return;n=100,o&&e.onReconnect(),e.onOpen()}}),i.addEventListener("close",()=>{if(a){if(r.disconnected)return;e.onClose(),yt(e,t,r,c?5e3:Math.min(2500,n+~~(Math.random()*500)+100),!0)}})},n)}),r),Zt=yt;var bt=class{constructor(){Object.defineProperty(this,"listeners",{enumerable:!1,writable:!0})}listeners={};emit(t,r){if(this.listeners[t]){let n=this.listeners[t];for(let o=0,s=n.length;o<n.length;o++){let a=n[o];a(r),s>n.length&&n[o]!==a&&(o--,s=n.length)}}}on(t,r){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(r)}removeAllListeners(){this.listeners={}}once(t,r){if(!r)return new Promise(o=>{let s=a=>{o(a),this.off(t,s)};this.on(t,s)});let n=o=>{r(o),this.off(t,n)};this.on(t,n)}off(t,r){let n=this.listeners[t];if(n)if(!r)delete this.listeners[t];else{for(let o=0;o<n.length;o++)if(n[o]===r){n.splice(o,1),o--;break}n.length===0&&delete this.listeners[t]}}},Wt=bt;var P=Uint8Array,U=Uint16Array,It=Int32Array,We=new P([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Be=new P([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),At=new P([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Yt=function(e,t){for(var r=new U(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var o=new It(r[30]),n=1;n<30;++n)for(var s=r[n];s<r[n+1];++s)o[s]=s-r[n]<<5|n;return{b:r,r:o}},_t=Yt(We,2),er=_t.b,Tt=_t.r;er[28]=258,Tt[258]=28;var tr=Yt(Be,0),qr=tr.b,Bt=tr.r,Ot=new U(32768);for(m=0;m<32768;++m)V=(m&43690)>>1|(m&21845)<<1,V=(V&52428)>>2|(V&13107)<<2,V=(V&61680)>>4|(V&3855)<<4,Ot[m]=((V&65280)>>8|(V&255)<<8)>>1;var V,m,G=function(e,t,r){for(var n=e.length,o=0,s=new U(t);o<n;++o)e[o]&&++s[e[o]-1];var a=new U(t);for(o=1;o<t;++o)a[o]=a[o-1]+s[o-1]<<1;var i;if(r){i=new U(1<<t);var c=15-t;for(o=0;o<n;++o)if(e[o])for(var f=o<<4|e[o],l=t-e[o],u=a[e[o]-1]++<<l,h=u|(1<<l)-1;u<=h;++u)i[Ot[u]>>c]=f}else for(i=new U(n),o=0;o<n;++o)e[o]&&(i[o]=Ot[a[e[o]-1]++]>>15-e[o]);return i},re=new P(288);for(m=0;m<144;++m)re[m]=8;var m;for(m=144;m<256;++m)re[m]=9;var m;for(m=256;m<280;++m)re[m]=7;var m;for(m=280;m<288;++m)re[m]=8;var m,Pe=new P(32);for(m=0;m<32;++m)Pe[m]=5;var m,Jr=G(re,9,0),Kr=G(re,9,1),Gr=G(Pe,5,0),Zr=G(Pe,5,1),wt=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},J=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(t&7)&r},xt=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},jt=function(e){return(e+7)/8|0},rr=function(e,t,r){return(t==null||t<0)&&(t=0),(r==null||r>e.length)&&(r=e.length),new P(e.subarray(t,r))};var Wr=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],_=function(e,t,r){var n=new Error(t||Wr[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,_),!r)throw n;return n},Br=function(e,t,r,n){var o=e.length,s=n?n.length:0;if(!o||t.f&&!t.l)return r||new P(0);var a=!r,i=a||t.i!=2,c=t.i;a&&(r=new P(o*3));var f=function(Se){var Ae=r.length;if(Se>Ae){var ce=new P(Math.max(Ae*2,Se));ce.set(r),r=ce}},l=t.f||0,u=t.p||0,h=t.b||0,p=t.l,v=t.d,d=t.m,D=t.n,q=o*8;do{if(!p){l=J(e,u,1);var L=J(e,u+1,3);if(u+=3,L)if(L==1)p=Kr,v=Zr,d=9,D=5;else if(L==2){var C=J(e,u,31)+257,A=J(e,u+10,15)+4,y=C+J(e,u+5,31)+1;u+=14;for(var g=new P(y),T=new P(19),x=0;x<A;++x)T[At[x]]=J(e,u+x*3,7);u+=A*3;for(var M=wt(T),ee=(1<<M)-1,N=G(T,M,1),x=0;x<y;){var Q=N[J(e,u,ee)];u+=Q&15;var S=Q>>4;if(S<16)g[x++]=S;else{var O=0,b=0;for(S==16?(b=3+J(e,u,3),u+=2,O=g[x-1]):S==17?(b=3+J(e,u,7),u+=3):S==18&&(b=11+J(e,u,127),u+=7);b--;)g[x++]=O}}var E=g.subarray(0,C),z=g.subarray(C);d=wt(E),D=wt(z),p=G(E,d,1),v=G(z,D,1)}else _(1);else{var S=jt(u)+4,F=e[S-4]|e[S-3]<<8,j=S+F;if(j>o){c&&_(0);break}i&&f(h+F),r.set(e.subarray(S,j),h),t.b=h+=F,t.p=u=j*8,t.f=l;continue}if(u>q){c&&_(0);break}}i&&f(h+131072);for(var xe=(1<<d)-1,$=(1<<D)-1,B=u;;B=u){var O=p[xt(e,u)&xe],R=O>>4;if(u+=O&15,u>q){c&&_(0);break}if(O||_(2),R<256)r[h++]=R;else if(R==256){B=u,p=null;break}else{var k=R-254;if(R>264){var x=R-257,w=We[x];k=J(e,u,(1<<w)-1)+er[x],u+=w}var K=v[xt(e,u)&$],ae=K>>4;K||_(3),u+=K&15;var z=qr[ae];if(ae>3){var w=Be[ae];z+=xt(e,u)&(1<<w)-1,u+=w}if(u>q){c&&_(0);break}i&&f(h+131072);var fe=h+k;if(h<z){var Le=s-z,Ne=Math.min(z,fe);for(Le+h<0&&_(3);h<Ne;++h)r[h]=n[Le+h]}for(;h<fe;++h)r[h]=r[h-z]}}t.l=p,t.p=B,t.b=h,t.f=l,p&&(l=1,t.m=d,t.d=v,t.n=D)}while(!l);return h!=r.length&&a?rr(r,0,h):r.subarray(0,h)},Y=function(e,t,r){r<<=t&7;var n=t/8|0;e[n]|=r,e[n+1]|=r>>8},je=function(e,t,r){r<<=t&7;var n=t/8|0;e[n]|=r,e[n+1]|=r>>8,e[n+2]|=r>>16},St=function(e,t){for(var r=[],n=0;n<e.length;++n)e[n]&&r.push({s:n,f:e[n]});var o=r.length,s=r.slice();if(!o)return{t:or,l:0};if(o==1){var a=new P(r[0].s+1);return a[r[0].s]=1,{t:a,l:1}}r.sort(function(j,C){return j.f-C.f}),r.push({s:-1,f:25001});var i=r[0],c=r[1],f=0,l=1,u=2;for(r[0]={s:-1,f:i.f+c.f,l:i,r:c};l!=o-1;)i=r[r[f].f<r[u].f?f++:u++],c=r[f!=l&&r[f].f<r[u].f?f++:u++],r[l++]={s:-1,f:i.f+c.f,l:i,r:c};for(var h=s[0].s,n=1;n<o;++n)s[n].s>h&&(h=s[n].s);var p=new U(h+1),v=zt(r[l-1],p,0);if(v>t){var n=0,d=0,D=v-t,q=1<<D;for(s.sort(function(C,A){return p[A.s]-p[C.s]||C.f-A.f});n<o;++n){var L=s[n].s;if(p[L]>t)d+=q-(1<<v-p[L]),p[L]=t;else break}for(d>>=D;d>0;){var S=s[n].s;p[S]<t?d-=1<<t-p[S]++-1:++n}for(;n>=0&&d;--n){var F=s[n].s;p[F]==t&&(--p[F],++d)}v=t}return{t:new P(p),l:v}},zt=function(e,t,r){return e.s==-1?Math.max(zt(e.l,t,r+1),zt(e.r,t,r+1)):t[e.s]=r},Xt=function(e){for(var t=e.length;t&&!e[--t];);for(var r=new U(++t),n=0,o=e[0],s=1,a=function(c){r[n++]=c},i=1;i<=t;++i)if(e[i]==o&&i!=t)++s;else{if(!o&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(o),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(o);s=1,o=e[i]}return{c:r.subarray(0,n),n:t}},Me=function(e,t){for(var r=0,n=0;n<t.length;++n)r+=e[n]*t[n];return r},nr=function(e,t,r){var n=r.length,o=jt(t+2);e[o]=n&255,e[o+1]=n>>8,e[o+2]=e[o]^255,e[o+3]=e[o+1]^255;for(var s=0;s<n;++s)e[o+s+4]=r[s];return(o+4+n)*8},Vt=function(e,t,r,n,o,s,a,i,c,f,l){Y(t,l++,r),++o[256];for(var u=St(o,15),h=u.t,p=u.l,v=St(s,15),d=v.t,D=v.l,q=Xt(h),L=q.c,S=q.n,F=Xt(d),j=F.c,C=F.n,A=new U(19),y=0;y<L.length;++y)++A[L[y]&31];for(var y=0;y<j.length;++y)++A[j[y]&31];for(var g=St(A,7),T=g.t,x=g.l,M=19;M>4&&!T[At[M-1]];--M);var ee=f+5<<3,N=Me(o,re)+Me(s,Pe)+a,Q=Me(o,h)+Me(s,d)+a+14+3*M+Me(A,T)+2*A[16]+3*A[17]+7*A[18];if(c>=0&&ee<=N&&ee<=Q)return nr(t,l,e.subarray(c,c+f));var O,b,E,z;if(Y(t,l,1+(Q<N)),l+=2,Q<N){O=G(h,p,0),b=h,E=G(d,D,0),z=d;var xe=G(T,x,0);Y(t,l,S-257),Y(t,l+5,C-1),Y(t,l+10,M-4),l+=14;for(var y=0;y<M;++y)Y(t,l+3*y,T[At[y]]);l+=3*M;for(var $=[L,j],B=0;B<2;++B)for(var R=$[B],y=0;y<R.length;++y){var k=R[y]&31;Y(t,l,xe[k]),l+=T[k],k>15&&(Y(t,l,R[y]>>5&127),l+=R[y]>>12)}}else O=Jr,b=re,E=Gr,z=Pe;for(var y=0;y<i;++y){var w=n[y];if(w>255){var k=w>>18&31;je(t,l,O[k+257]),l+=b[k+257],k>7&&(Y(t,l,w>>23&31),l+=We[k]);var K=w&31;je(t,l,E[K]),l+=z[K],K>3&&(je(t,l,w>>5&8191),l+=Be[K])}else je(t,l,O[w]),l+=b[w]}return je(t,l,O[256]),l+b[256]},Xr=new It([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),or=new P(0),Vr=function(e,t,r,n,o,s){var a=s.z||e.length,i=new P(n+a+5*(1+Math.ceil(a/7e3))+o),c=i.subarray(n,i.length-o),f=s.l,l=(s.r||0)&7;if(t){l&&(c[0]=s.r>>3);for(var u=Xr[t-1],h=u>>13,p=u&8191,v=(1<<r)-1,d=s.p||new U(32768),D=s.h||new U(v+1),q=Math.ceil(r/3),L=2*q,S=function(lt){return(e[lt]^e[lt+1]<<q^e[lt+2]<<L)&v},F=new It(25e3),j=new U(288),C=new U(32),A=0,y=0,g=s.i||0,T=0,x=s.w||0,M=0;g+2<a;++g){var ee=S(g),N=g&32767,Q=D[ee];if(d[N]=Q,D[ee]=N,x<=g){var O=a-g;if((A>7e3||T>24576)&&(O>423||!f)){l=Vt(e,c,0,F,j,C,y,T,M,g-M,l),T=A=y=0,M=g;for(var b=0;b<286;++b)j[b]=0;for(var b=0;b<30;++b)C[b]=0}var E=2,z=0,xe=p,$=N-Q&32767;if(O>2&&ee==S(g-$))for(var B=Math.min(h,O)-1,R=Math.min(32767,g),k=Math.min(258,O);$<=R&&--xe&&N!=Q;){if(e[g+E]==e[g+E-$]){for(var w=0;w<k&&e[g+w]==e[g+w-$];++w);if(w>E){if(E=w,z=$,w>B)break;for(var K=Math.min($,w-2),ae=0,b=0;b<K;++b){var fe=g-$+b&32767,Le=d[fe],Ne=fe-Le&32767;Ne>ae&&(ae=Ne,Q=fe)}}}N=Q,Q=d[N],$+=N-Q&32767}if(z){F[T++]=268435456|Tt[E]<<18|Bt[z];var Se=Tt[E]&31,Ae=Bt[z]&31;y+=We[Se]+Be[Ae],++j[257+Se],++C[Ae],x=g+E,++A}else F[T++]=e[g],++j[e[g]]}}for(g=Math.max(g,x);g<a;++g)F[T++]=e[g],++j[e[g]];l=Vt(e,c,f,F,j,C,y,T,M,g-M,l),f||(s.r=l&7|c[l/8|0]<<3,l-=7,s.h=D,s.p=d,s.i=g,s.w=x)}else{for(var g=s.w||0;g<a+f;g+=65535){var ce=g+65535;ce>=a&&(c[l/8|0]=f,ce=a),l=nr(c,l+1,e.subarray(g,ce))}s.i=a}return rr(i,0,n+jt(l)+o)};var Yr=function(e,t,r,n,o){if(!o&&(o={l:1},t.dictionary)){var s=t.dictionary.subarray(-32768),a=new P(s.length+e.length);a.set(s),a.set(e,s.length),e=a,o.w=s.length}return Vr(e,t.level==null?6:t.level,t.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(e.length)))*1.5):12+t.mem,r,n,o)};function Xe(e,t){return Yr(e,t||{},0,0)}function Ve(e,t){return Br(e,{i:2},t&&t.out,t&&t.dictionary)}var _r=typeof TextDecoder<"u"&&new TextDecoder,en=0;try{_r.decode(or,{stream:!0}),en=1}catch{}var me="@based",Fe=me+"-cache",Ce=me+"-size",ne=me+"-authState";var tn=new TextDecoder("utf-8"),rn=new TextEncoder,nn=e=>{console.info("DECODE",e);let t=tn.decode(Ve(mt(e)));return console.info(",,,x",t),JSON.parse(t)},Mt=(e,t)=>{let r=localStorage.getItem(t);r&&(e.storageSize-=new Blob([r]).size,localStorage.setItem(Ce,String(e.storageSize)),localStorage.removeItem(t))},Ye=()=>{let e=Object.keys(localStorage);try{for(let t of e)t.startsWith(me)&&localStorage.removeItem(t)}catch{try{localStorage.clear()}catch{}}},ir=(e,t,r)=>{try{let n=e.storageEnvKey;if(!n)return;let o=localStorage.getItem(t),s=JSON.stringify(r),a=s.length>70||t===ne+"-"+n?He(Xe(rn.encode(s))):s,c=new Blob([a]).size;o&&(e.storageSize-=new Blob([o]).size),e.storageSize+=c,e.storageSize>e.maxStorageSize&&(Ye(),e.storageSize=0,e.authState.persistent===!0&&ir(e,ne+"-"+n,e.authState),e.storageSize+=c),localStorage.setItem(Ce,String(e.storageSize)),localStorage.setItem(t,a)}catch(n){console.error(`Based - Error writing ${t} to localStorage`,n)}},sr=(e,t)=>{let r=e.storageEnvKey;if(r)try{let n=localStorage.getItem(t);if(n!==void 0){if(n.length<70&&t!==ne+"-"+r)try{return JSON.parse(n)}catch{}return nn(n)}return}catch{}},on=async e=>{let t=e.storageEnvKey;if(!t)return;let r=window.__basedcache__??{};for(let n in r)e.cache.set(Number(n),r[n]);try{let n=Number(localStorage.getItem(Ce)||0);n<0&&(Ye(),n=0),e.storageSize=n;let o=Object.keys(localStorage);if(o.length===1&&n>0&&(Ye(),n=0),n>0)for(let s of o){if(s===Ce||!s.startsWith(me))continue;if(s===ne+"-"+t){let l=sr(e,s);console.info("-------->",l),l&&e.setAuthState(l).catch(u=>{console.error(u.message),Mt(e,s)});continue}let[,a]=s.split(Fe);if(!a)continue;let[i,c]=a.split("-");if(c!==String(t))continue;if(!i){Mt(e,s);continue}let f=sr(e,s);e.cache.set(Number(i),f)}}catch{}},_e=(e,t)=>{let r=e.storageEnvKey;r&&(t+="-"+r,Mt(e,t))},ie=(e,t,r)=>{let n=e.storageEnvKey;n&&(t+="-"+n,console.info(t),ir(e,t,r))},Pt=async(e,t)=>{},ar=async e=>on(e),fr=async e=>Ye();var de=(e,t)=>{t.persistent?ie(e,ne,t):_e(e,ne),e.authState=t};var De=new TextEncoder,Z=(e,t,r,n)=>{for(let o=r;o<r+n;o++){let s=t&255;e[o]=s,t=(t-s)/256}},sn=(e,t,r)=>{let n=(e<<1)+(t|0);return(r<<4)+n},oe=(e,t,r,n=r)=>{let o=sn(e,t,r),s=new Uint8Array(n);return Z(s,o,0,4),s},ye=(e,t=!1)=>{let r,n=!1;return e!==void 0?(r=De.encode(typeof e=="string"?e:JSON.stringify(e)),!t&&r.length>150&&(r=Xe(r),n=!0),[n,r]):[!1]},cr=(e,t)=>{let r=4,[n,o,s,a]=t;if(n===3){let i=De.encode(o);r+=1+i.length;let[c,f]=ye(a);f&&(r+=f.length);let l=16;r+=l;let u=oe(n,c,r,5+l);return Z(u,e,4,8),Z(u,s,12,8),u[20]=i.length,f?{buffers:[u,i,f],len:r}:{buffers:[u,i],len:r}}return{buffers:[],len:0}},et=(e,t)=>{let r=4,[n,o,s]=t;if(n===7){let u=oe(n,!1,12);return Z(u,e,4,8),{buffers:[u],len:12}}let a=De.encode(o);r+=1+a.length;let i=n===6,[,c]=ye(s,!0);c&&(r+=c.length);let f=8;r+=f;let l=oe(5,i,r,5+f);return Z(l,e,4,8),l[12]=a.length,c?{buffers:[l,a,c],len:r}:{buffers:[l,a],len:r}},lr=(e,t)=>{let r=4,[n,o,s,a]=t;if(n===2){let h=oe(n,!1,12);return Z(h,e,4,8),{buffers:[h],len:12}}let i=De.encode(o);r+=1+i.length;let[c,f]=ye(a);f&&(r+=f.length);let l=16;r+=l;let u=oe(n,c,r,5+l);return Z(u,e,4,8),Z(u,s,12,8),u[20]=i.length,f?{buffers:[u,i,f],len:r}:{buffers:[u,i],len:r}},ur=e=>{let t=7,[r,n,o]=e,s=De.encode(n);t+=1+s.length;let[a,i]=ye(o);i&&(t+=i.length);let c=oe(0,a,t,8);return Z(c,r,4,3),c[7]=s.length,i?{buffers:[c,s,i],len:t}:{buffers:[c,s],len:t}},hr=e=>{let t=12,[r,n]=e,[o,s]=ye(n);s&&(t+=s.length);let a=oe(6,o,t,12);return Z(a,r,4,8),s?{buffers:[a,s],len:t}:{buffers:[a],len:t}},pr=e=>{let t=4,[r,n]=ye(e);n&&(t+=n.length);let o=oe(4,r,t);return n&&o.set(n,4),o};var an=new Uint8Array(0),fn=e=>{clearTimeout(e.idlePing),e.idlePing=setTimeout(()=>{e.connection&&e.connected&&!e.connection.disconnected&&e.connection.ws.send(an)},6e4)},gr=e=>!!(e.fQ.length||e.oQ.size||e.gQ.size||e.cQ.size||e.pQ.length),W=e=>{if(e.connected&&!e.drainInProgress&&gr(e)){e.drainInProgress=!0;let t=()=>{if(e.drainInProgress=!1,!!e.connected&&gr(e)){let r=e.cQ,n=e.pQ,o=e.fQ,s=e.oQ,a=e.gQ,i=[],c=0;for(let[u,h]of r){let{buffers:p,len:v}=et(u,h);i.push(...p),c+=v}for(let[u,h]of a){let{buffers:p,len:v}=cr(u,h);i.push(...p),c+=v}for(let[u,h]of s){let{buffers:p,len:v}=lr(u,h);i.push(...p),c+=v}for(let u of o){let{buffers:h,len:p}=ur(u);i.push(...h),c+=p}for(let u of n){let{buffers:h,len:p}=hr(u);i.push(...h),c+=p}let f=new Uint8Array(c),l=0;for(let u of i)f.set(u,l),l+=u.length;e.fQ=[],e.pQ=[],e.oQ.clear(),e.gQ.clear(),e.cQ.clear(),e.connection.ws.send(f),fn(e)}};e.drainTimeout=setTimeout(t,0)}};var Qe=(e,t,r,n,o)=>{e.requestId++,e.requestId>16777215&&(e.requestId=0);let s=e.requestId,a=Error().stack.split(/BasedClient\.function.+:\d\d\)/)[1];e.functionResponseListeners.set(s,[n,o,a]),e.fQ.push([s,r,t]),W(e)},vr=(e,t)=>{e.cQ.get(t)?.[0]!==7&&(e.cQ.set(t,[7]),W(e))},tt=(e,t,r,n)=>{e.cQ.get(r)?.[0]!==5&&(e.cQ.set(r,[5,t,n]),W(e))},rt=(e,t,r,n)=>{let o=e.cQ.get(r)?.[0];o===5||o===6||(e.cQ.set(r,[6,t,n]),W(e))},mr=(e,t,r)=>{e.pQ.length>e.maxPublishQueue&&e.pQ.shift(),e.pQ.push([t,r]),W(e)},dr=(e,t)=>{e.oQ.get(t)?.[0]!==2&&(e.oQ.set(t,[2]),W(e))},nt=(e,t,r,n,o=0)=>{e.oQ.get(r)?.[0]!==1&&(e.oQ.set(r,[1,t,o,n]),W(e))},ot=(e,t,r,n,o=0)=>{e.gQ.has(r)||(e.gQ.set(r,[3,t,o,n]),W(e))},Ft=async(e,t)=>se(t,e.authState)?(console.warn("[Based] Trying to send the same authState twice",e.authState),e.authRequest.inProgress?e.authRequest.promise:new Promise(r=>r({}))):(e.authRequest.inProgress&&(console.warn("[Based] Authentication still in progress - waiting until done"),await e.authRequest.promise),de(e,t),e.emit("authstate-change",e.authState),e.connected&&e.connection.ws.send(pr(t)),e.authRequest.promise=new Promise((r,n)=>{e.authRequest.inProgress=!0,e.authRequest.resolve=r,e.authRequest.reject=n}).finally(()=>{e.authRequest.resolve=null,e.authRequest.reject=null,e.authRequest.inProgress=!1}),e.authRequest.promise);var yr=(e,t,r)=>{if(r.constructor===Array){let n=r[0];if(n===0)e[t]=r[1];else if(n===1)delete e[t];else if(n===2){let o=br(e[t],r[1]);if(o===null)return null;e[t]=o}}else{if(r.___$toObject&&e[t]&&e[t].constructor===Array){let n={};for(let o=0;o<e[t].length;o++)n[o]=e[t][o];e[t]=n}if(e[t]===void 0)return console.warn("Diff apply patch: Cannot find key in original object",t,JSON.stringify(r,null,2)),null;for(let n in r)if(n!=="___$toObject"&&yr(e[t],n,r[n])===null)return null}},br=(e,t)=>{let r=t.length,n=new Array(t[0]),o=-1,s=[],a={};for(let c=1;c<r;c++){let f=t[c],l=f[0];if(l===0)for(let u=1;u<f.length;u++)n[++o]=f[u];else if(l===1){let u=f[2],h=f[1]+u;for(let p=u;p<h;p++){let v=typeof e[p];if(v==="object"&&p in a){let d=Te(e[p]);n[++o]=d}else v==="object"&&(a[p]=!0),n[++o]=e[p]}}else if(l===2){let u=f[1],h=f.length-2+u;for(let p=u;p<h;p++){let v=[++o,p,f[p-u+2]];s.push(v)}}}let i=s.length;for(let c=0;c<i;c++){let[f,l,u]=s[c],h=l in a?Te(e[l]):e[l],p=wr(h,u);if(p===null)return null;n[f]=p}return n},wr=(e,t)=>{if(t)if(t.constructor===Array){let r=t[0];if(r===0)return t[1];if(r===1)return;if(r===2)return br(e,t[1])}else{if(t.___$toObject&&e&&e.constructor===Array){let r={};for(let n=0;n<e.length;n++)r[n]=e[n];e=r}for(let r in t)if(r!=="___$toObject"&&yr(e,r,t[r])===null)return null;return e}else return e},Ct=wr;var xr=e=>{let t=e>>4,r=e&15,n=r>>1,o=r&1;return{type:n,isDeflate:o===1,len:t}},H=(e,t,r)=>{let n=0,o=r-1+t;for(let s=o;s>=t;s--)n=n*256+e[s];return n},Sr=async e=>{if(e instanceof ArrayBuffer)return new Uint8Array(e);if(typeof window>"u"){if(e instanceof Buffer)return new Uint8Array(e)}else if(e instanceof Blob){let t=await e.arrayBuffer();return new Uint8Array(t)}throw new Error("432")},st=(e,t)=>{let r=e.observeState.get(t);ot(e,r.name,t,r.payload)};var Dt=(e,t,r)=>{let n=r==="sub"?e.observeState.get(t):e.channelState.get(t);return n?n.payload?{name:n.name,payload:n.payload,id:t}:{name:n.name,id:t}:{name:`[Cannot find ${t}]`,id:t}};var be=(e,t,r,n)=>new TextDecoder().decode(r?Ve(n.slice(e,t)):n.slice(e,t)),Ar=async(e,t)=>{if(!e.isDestroyed)try{let r=t.data,n=await Sr(r),{type:o,len:s,isDeflate:a}=xr(H(n,0,4));if(o===0){let i=H(n,4,3),c=7,f=s+4,l;s!==3&&(l=JSON.parse(be(c,f,a,n))),e.functionResponseListeners.has(i)&&(e.functionResponseListeners.get(i)[0](l),e.functionResponseListeners.delete(i))}else if(o===3){let i=H(n,4,8);if(e.getState.has(i)&&e.cache.has(i)){let c=e.getState.get(i);for(let[f]of c)f(e.cache.get(i).v);e.getState.delete(i)}}else if(o===2){let i=H(n,4,8),c=e.cache.get(i);if(!c){st(e,i);return}let f=H(n,12,8),l=H(n,20,8);if(c.c!==l){st(e,i);return}let u=28,h=s+4,p;s!==24&&(p=JSON.parse(be(u,h,a,n)));try{c.v=Ct(c.v,p),c.c=f}catch{st(e,i);return}if(e.observeState.has(i)){let v=e.observeState.get(i);v.persistent&&(c.p=!0,ie(e,Fe+i,c));for(let[,d]of v.subscribers)d.onData(c.v,f)}if(e.getState.has(i)){let v=e.getState.get(i);for(let[d]of v)d(c.v);e.getState.delete(i)}}else if(o===1){let i=H(n,4,8),c=H(n,12,8),f=20,l=s+4,u;if(s!==16&&(u=JSON.parse(be(f,l,a,n))),!(e.cache.get(i)?.c===c)){let p={v:u,c};if(e.cache.set(i,p),e.observeState.has(i)){let v=e.observeState.get(i);v.persistent&&(p.p=!0,ie(e,Fe+i,p));for(let[,d]of v.subscribers)d.onData(u,c)}}if(e.getState.has(i)){let p=e.getState.get(i);for(let[v]of p)v(u);e.getState.delete(i)}}else if(o===4){let c=s+4,f;s!==3&&(f=JSON.parse(be(4,c,a,n))),f===!0?e.authRequest.resolve?.(e.authState):"error"in f?(de(e,f),e.emit("authstate-change",e.authState),e.authRequest.reject?.(new Error(f.error))):(se(e.authState,f)?de(e,f):(de(e,f),e.emit("authstate-change",e.authState)),e.authRequest?.resolve?.(e.authState))}else if(o===5){let c=s+4,f;if(s!==3&&(f=JSON.parse(be(4,c,a,n))),f.requestId&&e.functionResponseListeners.has(f.requestId)){let[,l,u]=e.functionResponseListeners.get(f.requestId);l(te(f,u)),e.functionResponseListeners.delete(f.requestId)}if(f.channelId&&e.channelState.has(f.channelId)){let l=te(f),u=e.channelState.get(f.channelId);for(let[,h]of u.subscribers)h.onError?h.onError(l):console.error(Dt(e,f.channelId,"channel"),l)}if(f.observableId){if(e.cache.delete(f.observableId),e.observeState.has(f.observableId)){let l=te(f),u=e.observeState.get(f.observableId);for(let[,h]of u.subscribers)h.onError?h.onError(l):console.error(Dt(e,f.observableId,"sub"),l)}if(e.getState.has(f.observableId)){let l=te(f),u=e.getState.get(f.observableId);for(let[,h]of u)h(l);e.getState.delete(f.observableId)}}}else if(o===6){let i=H(n,4,8),c=e.channelState.get(i);if(i){if(!c.inTransit){c.inTransit=!0;let{buffers:f,len:l}=et(i,[6,c.name,c.payload]),u=new Uint8Array(l),h=0;for(let p of f)u.set(p,h),h+=p.length;e.connection.ws.send(u),c.removeTimer!==-1&&c.removeTimer<2&&(c.removeTimer+=1),setTimeout(()=>{let p=e.channelState.get(i);p&&(p.inTransit=!1)},5e3)}e.connection.ws.send(n)}}else if(o===7&&H(n,4,1)===0){let c=H(n,5,8),f=13,l=s+5,u;if(s!==9){let h=be(f,l,a,n);try{u=JSON.parse(h)}catch{u=h}}if(e.channelState.has(c)){let h=e.channelState.get(c);for(let[,p]of h.subscribers)p.onMessage(u)}}}catch(r){console.error(981,r)}};var it=(e,t)=>t===void 0?ze(e):X([e,t]);var at=class{id;query;name;client;persistent;constructor(t,r,n,o){this.query=n,this.id=it(r,n),this.client=t,this.name=r,this.persistent=o?.persistent||!1}get cache(){return this.client.cache.get(this.id)||null}clearCache(){this.persistent&&_e(this.client,"@based-cache-"+this.id),this.client.cache.delete(this.id)}subscribe(t,r){let n,o=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){let s=this.client.observeState.get(this.id);this.persistent&&!s.persistent&&(s.persistent=!0,o&&ie(this.client,"@based-cache-"+this.id,o)),n=++s.idCnt,s.subscribers.set(n,{onError:r,onData:t})}else{n=1;let s=new Map;s.set(n,{onError:r,onData:t}),this.client.observeState.set(this.id,{payload:this.query,name:this.name,subscribers:s,persistent:this.persistent||!1,idCnt:1}),nt(this.client,this.name,this.id,this.query,o?.c||0)}return o&&t(o.v,o.c),()=>{let s=this.client.observeState.get(this.id);s?(s.subscribers.delete(n),s.subscribers.size===0&&(this.client.observeState.delete(this.id),dr(this.client,this.id))):console.warn("Subscription allready removed",this.query,this.name)}}async getWhen(t){return new Promise(r=>{let n=this.subscribe((o,s)=>{t(o,s)&&(r(o),n())})})}async get(){return new Promise((t,r)=>{if(this.client.getState.has(this.id)){this.client.getState.get(this.id).push([t,r]);return}this.client.getState.set(this.id,[]);let n=this.client.cache.get(this.id);if(this.client.observeState.has(this.id)){if(this.client.oQ.has(this.id)){let[o]=this.client.oQ.get(this.id);if(o===1){this.client.getState.get(this.id).push([t,r]);return}}if(n){t(n.v);return}}this.client.getState.get(this.id).push([t,r]),ot(this.client,this.name,this.id,this.query,n?.c||0)})}};var Tr=e=>e.contents instanceof File,cn=e=>e!==null&&typeof e=="object"&&typeof e.pipe=="function"&&e.readable!==!1&&typeof e._read=="function"&&typeof e._readableState=="object",Or=e=>"path"in e&&typeof e.path=="string",zr=e=>"contents"in e&&cn(e.contents);var ft=async(e,t,r)=>{e.connected||await e.once("connect");let n=await he(e.opts,!0),o={"Content-Type":r.mimeType||"text/plain",Authorization:ue(e.authState)};r.fileName&&(o["Content-Name"]=r.fileName);let s="";r.payload&&(s="?"+Ue(r.payload));let a=await qe(n+"/"+t+s,{method:"POST",cache:"no-cache",headers:o,body:r.contents}).then(i=>i.text());try{return JSON.parse(a)}catch{}return a};var Ir=async(e,t,r,n)=>{if(!Or(r)&&!zr(r)){if(r.contents instanceof ArrayBuffer)return r.contents=new window.Blob([r.contents],{type:r.mimeType||"text/plain"}),ft(e,t,r);if(Tr(r))return Kt(e,t,r,n);if(r.contents instanceof window.Blob)return r.mimeType||(r.mimeType=r.contents.type),ft(e,t,r);if(typeof r.contents=="string")return ft(e,t,r);throw new Error(`Invalid opts for file api ${t} ${JSON.stringify(r,null,2)}`)}};var Ee=e=>{e.channelCleanTimeout||(e.channelCleanTimeout=setTimeout(()=>{if(e.channelCleanTimeout=null,e.connected){let t=!1;e.channelState.forEach((r,n)=>{r.removeTimer!==-1&&(r.removeTimer--,r.removeTimer===0?e.channelState.delete(n):t=!0)}),t&&Ee(e)}else Ee(e)},e.channelCleanupCycle))};var ct=class{id;payload;name;client;constructor(t,r,n){this.payload=n,this.id=it(r,n),this.client=t,this.name=r}subscribe(t,r){let n;if(!this.client.channelState.has(this.id)||this.client.channelState.get(this.id).subscribers.size===0){n=1;let o=new Map;o.set(n,{onMessage:t,onError:r}),this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:o,removeTimer:-1,idCnt:1}),tt(this.client,this.name,this.id,this.payload)}else{let o=this.client.channelState.get(this.id);o.removeTimer=-1,n=++o.idCnt,o.subscribers.set(n,{onMessage:t,onError:r})}return()=>{let o=this.client.channelState.get(this.id);o.subscribers.delete(n),o.subscribers.size===0&&(o.removeTimer=2,vr(this.client,this.id))}}publish(t){if(!this.client.channelState.has(this.id))this.client.channelState.set(this.id,{payload:this.payload,name:this.name,subscribers:new Map,removeTimer:2,idCnt:0}),Ee(this.client),rt(this.client,this.name,this.id,this.payload);else{let r=this.client.channelState.get(this.id);r.removeTimer!==-1&&r.removeTimer<2&&(r.removeTimer=2,Ee(this.client))}mr(this.client,this.id,t)}};var Qt=class extends Wt{constructor(t,r){super(),r?.persistentStorage&&(this.storagePath=r.persistentStorage),r?.maxCacheSize&&(console.warn("MaxCacheSize setting not implemented yet..."),this.maxCacheSize=r.maxCacheSize),t&&this.connect(t)}storageSize=0;maxStorageSize=5e6-500;storageEnvKey=0;storagePath;storageBeingWritten;opts;connected=!1;connection;url;outgoingStreams=new Map;isDrainingStreams=!1;maxPublishQueue=1e3;pQ=[];fQ=[];oQ=new Map;cQ=new Map;gQ=new Map;drainInProgress=!1;drainTimeout;idlePing;localStorage=!1;maxCacheSize=4e6;cache=new Map;functionResponseListeners=new Map;requestId=0;channelState=new Map;channelCleanTimeout;channelCleanupCycle=3e4;observeState=new Map;getState=new Map;authState={};authRequest={authState:null,promise:null,resolve:null,reject:null,inProgress:!1};onClose(){this.connected=!1,this.functionResponseListeners.size>this.fQ.length&&this.functionResponseListeners.forEach((t,r)=>{this.fQ.find(([n])=>n===r)||(t[1](new Error("Server disconnected before function result was processed")),this.functionResponseListeners.delete(r))}),this.emit("disconnect",!0)}onReconnect(){this.connected=!0,this.emit("reconnect",!0)}onOpen(){this.connected=!0,this.emit("connect",!0);for(let[t,r]of this.observeState)if(!this.oQ.has(t)){let n=this.cache.get(t);nt(this,r.name,t,r.payload,n?.c||0)}for(let[t,r]of this.channelState)this.cQ.has(t)||(r.subscribers.size?tt(this,r.name,t,r.payload):rt(this,r.name,t,r.payload));W(this)}onData(t){Ar(this,t)}async connect(t){if(t&&Object.keys(t).length>0){if(this.opts){if(se(this.opts,t))return;this.disconnect()}this.opts=t,this.url=()=>he(t),this.storageEnvKey=X(t),ar(this)}if(!this.opts){console.error("Configure opts to connect");return}this.url&&!this.connection&&(this.connection=Zt(this,this.url))}disconnect(){this.connection&&(this.connection.disconnected=!0,this.connection.destroy(),this.connection.ws&&this.connection.ws.close(),this.connected&&this.onClose(),delete this.connection),clearTimeout(this.drainTimeout),clearTimeout(this.idlePing),this.connected=!1}isDestroyed;async destroy(t){t||await Pt(this,!0),clearTimeout(this.storageBeingWritten),clearTimeout(this.channelCleanTimeout),this.disconnect();for(let r in this)delete this[r];this.isDestroyed=!0}channel(t,r){return new ct(this,t,r)}query(t,r,n){return new at(this,t,r,n)}call(t,r,n){let o=n?.retryStrategy;return o?new Promise(s=>{let a=0,i=0,c=f=>{let l=o(f,a,i);i++,typeof l=="number"&&!isNaN(l)&&(a=l,l===0?Qe(this,r,t,s,c):setTimeout(()=>{Qe(this,r,t,s,c)},l))};return Qe(this,r,t,s,c)}):new Promise((s,a)=>Qe(this,r,t,s,a))}stream(t,r,n){return Ir(this,t,r,n)}setAuthState(t){if(typeof t=="object")return Ft(this,t);throw new Error("Invalid auth() arguments")}clearAuthState(){return Ft(this,{})}clearStorage(){return fr(this)}saveStorage(){return Pt(this)}};function Et(e,t){return new Qt(e,t)}var we=Et({url:"ws://localhost:9910"}),jr=!1;we.query("meta").subscribe((e,t)=>{jr&&window.location.reload(),jr=!0},e=>{console.error("??")});var ln=()=>{let e=document.body,t=document.createElement("button");t.innerHTML="LOGIN",t.onclick=()=>{we.call("login",{name:"x",password:"x"})},e.appendChild(t);let r=document.createElement("button");r.innerHTML="LOGOUT",r.onclick=()=>{we.setAuthState({})},e.appendChild(r);let n=document.createElement("div");e.appendChild(n);let o=document.createElement("pre");e.appendChild(o),we.on("connect",s=>{n.innerHTML+="<div>CONNECT: true</div>"}),we.query("counter").subscribe(s=>{n.innerHTML+=`<span>cnt: ${s}</span>`},s=>{console.error(s)}),we.query("meta").subscribe((s,a)=>{let i=Object.keys(Object.values(s.outputs)[0].inputs),c=Object.values(Object.values(s.outputs)[0].inputs).map((f,l)=>({key:i[l],bytes:f.bytesInOutput})).filter(f=>f.key!=="test/browser/index.ts").sort((f,l)=>f.bytes>l.bytes?-1:1);n.innerHTML+=`<div>bytes ${c.reduce((f,l)=>f+l.bytes,0)}</div>`,o.innerHTML=JSON.stringify(c,null,2)})};ln();})();
